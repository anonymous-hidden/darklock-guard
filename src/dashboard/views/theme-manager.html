<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <title>Theme Manager - DarkLock</title>
    <link rel="stylesheet" href="/css/dashboard-pro.css">
    <link id="dynamic-theme-stylesheet" rel="stylesheet" href="/api/v3/theme/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="/js/global-theme.js"></script>
    <script src="/js/theme-effects.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-body, #0a0e1a);
            background-image: var(--bg-gradient, radial-gradient(ellipse at top, #1a2332 0%, #0a0e1a 100%));
            background-attachment: fixed;
            color: var(--color-text, #ffffff);
            font-family: var(--font-stack, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif);
            min-height: 100vh;
        }

        .theme-header {
            background: linear-gradient(135deg, var(--color-primary, #10b981) 0%, var(--color-info, #0066ff) 100%);
            padding: 2rem;
            border-radius: var(--radius-lg, 16px);
            margin-bottom: 2rem;
            color: white;
        }

        .theme-header h1 {
            font-size: 2rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .current-theme-display {
            background: var(--bg-surface, #151b2d);
            border: 2px solid var(--color-primary, #10b981);
            border-radius: var(--radius-lg, 16px);
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .current-theme-display .theme-emoji {
            font-size: 4rem;
        }

        .current-theme-info h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
            color: var(--color-text, #fff);
        }

        .current-theme-info p {
            margin: 0;
            color: var(--color-muted, #6b7280);
        }

        .theme-categories {
            margin-bottom: 2rem;
        }

        .theme-category {
            margin-bottom: 2rem;
        }

        .theme-category h2 {
            font-size: 1.25rem;
            color: var(--color-text-secondary, #b4bcd4);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border, #2a3441);
        }

        .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .theme-card {
            background: var(--bg-surface, #151b2d);
            border: 2px solid var(--color-border, #2a3441);
            border-radius: var(--radius-lg, 16px);
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            user-select: none;
        }

        .theme-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: var(--color-primary, #10b981);
        }

        .theme-card.active {
            border-color: var(--color-primary, #10b981);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .theme-card.active::after {
            content: 'âœ“';
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--color-primary, #10b981);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .theme-card.selected {
            border-color: var(--color-info, #3b82f6) !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        }

        .theme-card .theme-emoji {
            font-size: 3rem;
            margin-bottom: 0.75rem;
            pointer-events: none;
        }

        .theme-card .theme-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            color: var(--color-text, #fff);
            pointer-events: none;
        }

        .theme-card .theme-desc {
            font-size: 0.75rem;
            color: var(--color-muted, #6b7280);
            pointer-events: none;
        }

        /* Theme Preview Colors */
        .theme-card .color-preview {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-top: 0.75rem;
            pointer-events: none;
        }

        .theme-card .color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Schedule Section */
        .schedule-section {
            background: var(--bg-surface, #151b2d);
            border: 1px solid var(--color-border, #2a3441);
            border-radius: var(--radius-lg, 16px);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .schedule-section h2 {
            margin: 0 0 1rem 0;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--color-text, #fff);
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .schedule-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-surface-elevated, #1a2332);
            border-radius: var(--radius-md, 12px);
        }

        .schedule-item .emoji {
            font-size: 1.5rem;
        }

        .schedule-item .info {
            flex: 1;
        }

        .schedule-item .theme-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--color-text, #fff);
        }

        .schedule-item .date-range {
            font-size: 0.8rem;
            color: var(--color-muted, #6b7280);
        }

        .schedule-item .toggle-btn {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .schedule-item .toggle-btn.enabled {
            background: var(--color-success, #10b981);
            color: white;
        }

        .schedule-item .toggle-btn.disabled {
            background: var(--bg-surface, #151b2d);
            color: var(--color-muted, #6b7280);
            border: 1px solid var(--color-border, #2a3441);
        }

        .btn-apply {
            background: linear-gradient(135deg, var(--color-primary, #10b981) 0%, var(--color-primary-light, #34d399) 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: var(--radius-md, 12px);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1rem;
            transition: all 0.2s;
        }

        .btn-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-apply:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--color-muted, #6b7280);
            text-decoration: none;
            margin-bottom: 1rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--color-text, #fff);
        }

        .owner-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }

        .saving-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-surface, #151b2d);
            border: 1px solid var(--color-border, #2a3441);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md, 12px);
            display: none;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .saving-indicator.show {
            display: flex;
        }

        .saving-indicator.success {
            border-color: var(--color-success, #10b981);
        }

        .clock-display {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--bg-surface, #151b2d);
            border: 1px solid var(--color-border, #2a3441);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md, 12px);
            font-family: monospace;
            font-size: 1rem;
            z-index: 1000;
            color: var(--color-text, #fff);
        }
    </style>
</head>
<body>
    <!-- Clock Display -->
    <div class="clock-display" id="clockDisplay">
        <span id="currentTime">--:--:--</span>
        <span id="currentDate" style="color: var(--color-muted, #6b7280); margin-left: 0.5rem; font-size: 0.85rem;"></span>
    </div>

    <main style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
        <a href="/admin" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Admin Dashboard
        </a>

        <div class="theme-header">
            <h1>
                <i class="fas fa-palette"></i> Theme Manager
                <span class="owner-badge">OWNER ONLY</span>
            </h1>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Customize the look and feel of the dashboard for all users</p>
        </div>

        <!-- Current Theme -->
        <div class="current-theme-display">
            <div class="theme-emoji" id="currentThemeEmoji">ðŸŽ„</div>
            <div class="current-theme-info">
                <h3>Current Theme: <span id="currentThemeName">Christmas</span></h3>
                <p id="currentThemeDesc">Red, Green, Gold with snowfall effects</p>
            </div>
        </div>

        <!-- Theme Categories -->
        <div class="theme-categories">
            <!-- Holiday Themes -->
            <div class="theme-category">
                <h2><i class="fas fa-gift"></i> Holiday Themes</h2>
                <div class="themes-grid" id="holidayThemes">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Seasonal Themes -->
            <div class="theme-category">
                <h2><i class="fas fa-leaf"></i> Seasonal Themes</h2>
                <div class="themes-grid" id="seasonalThemes">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Aesthetic Themes -->
            <div class="theme-category">
                <h2><i class="fas fa-star"></i> Aesthetic Themes</h2>
                <div class="themes-grid" id="aestheticThemes">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <button class="btn-apply" id="applyThemeBtn" disabled>
            <i class="fas fa-check"></i> Apply Selected Theme
        </button>

        <!-- Auto-Schedule Section -->
        <div class="schedule-section">
            <h2><i class="fas fa-calendar-alt"></i> Auto-Schedule Themes</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">
                Enable automatic theme switching based on holidays and seasons.
            </p>
            <div class="schedule-grid" id="scheduleGrid">
                <!-- Populated by JS -->
            </div>
        </div>
    </main>

    <div class="saving-indicator" id="savingIndicator">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Saving...</span>
    </div>

    <script src="/js/secure-auth.js"></script>
    <script>
        // Theme definitions
        const themes = {
            holiday: [
                { id: 'christmas', name: 'Christmas', emoji: 'ðŸŽ„', desc: 'Red, Green, Gold with snowfall', colors: ['#c41e3a', '#228b22', '#ffd700'] },
                { id: 'new-year', name: 'New Year', emoji: 'ðŸŽ†', desc: 'Gold, Silver, Black with confetti', colors: ['#ffd700', '#c0c0c0', '#000000'] },
                { id: 'valentines', name: "Valentine's Day", emoji: 'ðŸ’•', desc: 'Pink, Red with floating hearts', colors: ['#ff69b4', '#ff1493', '#ffffff'] },
                { id: 'stpatricks', name: "St. Patrick's Day", emoji: 'ðŸ€', desc: 'Green, Gold with shamrocks', colors: ['#228b22', '#ffd700', '#32cd32'] },
                { id: 'easter', name: 'Easter', emoji: 'ðŸ°', desc: 'Pastels with eggs and bunnies', colors: ['#ffb6c1', '#98fb98', '#87ceeb'] },
                { id: 'july4th', name: '4th of July', emoji: 'ðŸ‡ºðŸ‡¸', desc: 'Red, White, Blue with fireworks', colors: ['#b22234', '#ffffff', '#3c3b6e'] },
                { id: 'halloween', name: 'Halloween', emoji: 'ðŸŽƒ', desc: 'Orange, Black, Purple - spooky!', colors: ['#ff6600', '#000000', '#9932cc'] },
                { id: 'thanksgiving', name: 'Thanksgiving', emoji: 'ðŸ¦ƒ', desc: 'Orange, Brown with falling leaves', colors: ['#d2691e', '#daa520', '#8b4513'] },
                { id: 'pride', name: 'Pride', emoji: 'ðŸ³ï¸â€ðŸŒˆ', desc: 'Rainbow gradient effects', colors: ['#e40303', '#ffed00', '#004dff'] }
            ],
            seasonal: [
                { id: 'winter', name: 'Winter', emoji: 'â„ï¸', desc: 'Icy blue with gentle snowfall', colors: ['#4a90d9', '#b0e0e6', '#ffffff'] },
                { id: 'spring', name: 'Spring', emoji: 'ðŸŒ¸', desc: 'Cherry blossoms, soft pastels', colors: ['#ffb7c5', '#98fb98', '#87ceeb'] },
                { id: 'summer', name: 'Summer', emoji: 'â˜€ï¸', desc: 'Beach vibes, bright colors', colors: ['#ff6b35', '#00bfff', '#ffff00'] },
                { id: 'autumn', name: 'Autumn', emoji: 'ðŸ‚', desc: 'Falling leaves, warm oranges', colors: ['#d2691e', '#b8860b', '#cd853f'] }
            ],
            aesthetic: [
                { id: 'default-dark', name: 'Default Dark', emoji: 'ðŸŒ™', desc: 'Clean, neutral dark mode', colors: ['#5865F2', '#57F287', '#FEE75C'] },
                { id: 'ocean', name: 'Ocean', emoji: 'ðŸŒŠ', desc: 'Deep blue with wave effects', colors: ['#006994', '#00ced1', '#20b2aa'] },
                { id: 'forest', name: 'Forest', emoji: 'ðŸŒ²', desc: 'Deep greens, nature vibes', colors: ['#228b22', '#8fbc8f', '#9acd32'] },
                { id: 'sunset', name: 'Sunset', emoji: 'ðŸŒ…', desc: 'Orange/purple gradients', colors: ['#ff6b6b', '#ffa502', '#9b59b6'] },
                { id: 'cyberpunk', name: 'Cyberpunk', emoji: 'ðŸ’œ', desc: 'Neon pink/cyan, futuristic', colors: ['#ff00ff', '#00ffff', '#ffff00'] },
                { id: 'oled-black', name: 'OLED Black', emoji: 'âš«', desc: 'Pure black, minimal', colors: ['#ffffff', '#888888', '#000000'] }
            ]
        };

        // Schedule definitions
        const schedules = [
            { themeId: 'christmas', name: 'Christmas', emoji: 'ðŸŽ„', start: '12-01', end: '12-31' },
            { themeId: 'new-year', name: 'New Year', emoji: 'ðŸŽ†', start: '01-01', end: '01-07' },
            { themeId: 'valentines', name: "Valentine's Day", emoji: 'ðŸ’•', start: '02-01', end: '02-14' },
            { themeId: 'stpatricks', name: "St. Patrick's Day", emoji: 'ðŸ€', start: '03-10', end: '03-17' },
            { themeId: 'easter', name: 'Easter', emoji: 'ðŸ°', start: '03-20', end: '04-20' },
            { themeId: 'july4th', name: '4th of July', emoji: 'ðŸ‡ºðŸ‡¸', start: '06-28', end: '07-04' },
            { themeId: 'halloween', name: 'Halloween', emoji: 'ðŸŽƒ', start: '10-01', end: '10-31' },
            { themeId: 'thanksgiving', name: 'Thanksgiving', emoji: 'ðŸ¦ƒ', start: '11-20', end: '11-30' }
        ];

        let currentTheme = 'christmas';
        let selectedTheme = null;
        let enabledSchedules = [];

        // Clock update
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            const dateStr = now.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('currentDate').textContent = dateStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Render theme cards
        function renderThemes() {
            ['holiday', 'seasonal', 'aesthetic'].forEach(category => {
                const container = document.getElementById(category + 'Themes');
                container.innerHTML = themes[category].map(theme => `
                    <div class="theme-card ${currentTheme === theme.id ? 'active' : ''}" 
                         data-theme="${theme.id}">
                        <div class="theme-emoji">${theme.emoji}</div>
                        <div class="theme-name">${theme.name}</div>
                        <div class="theme-desc">${theme.desc}</div>
                        <div class="color-preview">
                            ${theme.colors.map(c => `<div class="color-dot" style="background: ${c}"></div>`).join('')}
                        </div>
                    </div>
                `).join('');
                
                // Add click listeners
                container.querySelectorAll('.theme-card').forEach(card => {
                    card.addEventListener('click', function() {
                        selectTheme(this.dataset.theme);
                    });
                });
            });
        }

        // Render schedule
        function renderSchedule() {
            const container = document.getElementById('scheduleGrid');
            container.innerHTML = schedules.map(s => {
                const enabled = enabledSchedules.includes(s.themeId);
                return `
                    <div class="schedule-item">
                        <div class="emoji">${s.emoji}</div>
                        <div class="info">
                            <div class="theme-title">${s.name}</div>
                            <div class="date-range">${formatDateRange(s.start, s.end)}</div>
                        </div>
                        <button class="toggle-btn ${enabled ? 'enabled' : 'disabled'}" 
                                data-theme="${s.themeId}">
                            ${enabled ? 'Enabled' : 'Disabled'}
                        </button>
                    </div>
                `;
            }).join('');
            
            // Add click listeners for schedule toggles
            container.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    toggleSchedule(this.dataset.theme);
                });
            });
        }

        function formatDateRange(start, end) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const [sMonth, sDay] = start.split('-');
            const [eMonth, eDay] = end.split('-');
            return `${months[parseInt(sMonth)-1]} ${parseInt(sDay)} - ${months[parseInt(eMonth)-1]} ${parseInt(eDay)}`;
        }

        // Select theme
        function selectTheme(themeId) {
            console.log('Theme selected:', themeId);
            selectedTheme = themeId;
            
            // Update visual selection
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.theme === themeId) {
                    card.classList.add('selected');
                }
            });
            
            // Enable/disable apply button
            const btn = document.getElementById('applyThemeBtn');
            btn.disabled = (selectedTheme === currentTheme);
            
            if (selectedTheme !== currentTheme) {
                btn.innerHTML = '<i class="fas fa-check"></i> Apply ' + getThemeName(themeId);
            } else {
                btn.innerHTML = '<i class="fas fa-check"></i> Apply Selected Theme';
            }
        }
        
        function getThemeName(themeId) {
            const allThemes = [...themes.holiday, ...themes.seasonal, ...themes.aesthetic];
            const theme = allThemes.find(t => t.id === themeId);
            return theme ? theme.name : themeId;
        }

        // Apply theme
        async function applyTheme() {
            if (!selectedTheme || selectedTheme === currentTheme) return;
            
            const indicator = document.getElementById('savingIndicator');
            indicator.classList.add('show');
            indicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Applying theme...</span>';
            
            try {
                const response = await SecureAuth.fetch('/api/v3/theme/set', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ themeName: selectedTheme })
                });
                
                if (!response.ok) throw new Error('Failed to save theme');
                
                currentTheme = selectedTheme;
                updateCurrentThemeDisplay();
                renderThemes();
                
                indicator.classList.add('success');
                indicator.innerHTML = '<i class="fas fa-check" style="color: var(--alert-green)"></i><span>Theme applied!</span>';
                
                setTimeout(() => {
                    indicator.classList.remove('show', 'success');
                    // Reload page to apply theme
                    location.reload();
                }, 1500);
            } catch (error) {
                console.error('Error:', error);
                indicator.innerHTML = '<i class="fas fa-times" style="color: var(--alert-red)"></i><span>Failed to apply theme</span>';
                setTimeout(() => indicator.classList.remove('show'), 2000);
            }
        }

        // Toggle schedule
        async function toggleSchedule(themeId) {
            const idx = enabledSchedules.indexOf(themeId);
            if (idx > -1) {
                enabledSchedules.splice(idx, 1);
            } else {
                enabledSchedules.push(themeId);
            }
            
            try {
                await SecureAuth.fetch('/api/v3/theme/auto-holiday', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enabledSchedules.length > 0 })
                });
            } catch (e) {
                console.error('Failed to save schedule:', e);
            }
            
            renderSchedule();
        }

        // Update current theme display
        function updateCurrentThemeDisplay() {
            const allThemes = [...themes.holiday, ...themes.seasonal, ...themes.aesthetic];
            const theme = allThemes.find(t => t.id === currentTheme);
            if (theme) {
                document.getElementById('currentThemeEmoji').textContent = theme.emoji;
                document.getElementById('currentThemeName').textContent = theme.name;
                document.getElementById('currentThemeDesc').textContent = theme.desc;
            }
        }

        // Load current settings
        async function loadSettings() {
            try {
                const response = await SecureAuth.fetch('/api/v3/themes', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 403) {
                        alert('Access denied. Owner role required.');
                        window.location.href = '/admin';
                        return;
                    }
                    throw new Error('Failed to load settings');
                }
                
                const data = await response.json();
                currentTheme = data.active || 'darklock';
                enabledSchedules = data.autoHoliday ? ['auto'] : [];
                
                updateCurrentThemeDisplay();
                renderThemes();
                renderSchedule();
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize SecureAuth to get CSRF token
            await SecureAuth.init();
            
            // Add click listener to apply button
            document.getElementById('applyThemeBtn').addEventListener('click', applyTheme);
            
            // Load settings
            loadSettings();
        });
    </script>
</body>
</html>
