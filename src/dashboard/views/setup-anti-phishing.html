<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anti-Phishing Settings - DarkLock</title>
    <link rel="stylesheet" href="/css/dashboard-modern.css">
    <link id="dynamic-theme-stylesheet" rel="stylesheet" href="/css/themes/christmas.css">
    <script src="/js/global-theme.js"></script>
    <script src="/js/theme-effects.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%); min-height: 100vh; margin: 0; font-family: 'Inter', sans-serif; color: #fff; }
        .setup-container { max-width: 900px; margin: 0 auto; padding: 30px; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; color: #00d4ff; text-decoration: none; margin-bottom: 20px; font-size: 14px; }
        .back-btn:hover { text-decoration: underline; }
        .setup-header { text-align: center; margin-bottom: 40px; }
        .setup-header h1 { font-size: 2.5em; margin: 0; background: linear-gradient(135deg, #00d4ff 0%, #06ffa5 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .setup-header p { color: #8892b0; margin-top: 10px; }
        .settings-card { background: rgba(18, 23, 39, 0.9); border-radius: 16px; padding: 24px; margin-bottom: 20px; border: 1px solid rgba(0, 212, 255, 0.2); }
        .settings-card h3 { margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; color: #00d4ff; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: #ccd6f6; }
        .form-desc { font-size: 13px; color: #8892b0; margin-bottom: 8px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; background: #000000; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px; box-sizing: border-box; }
        .form-select option { background: #1a1a1a; color: #ffffff; }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #00d4ff; background: #0a0a0a; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: rgba(10, 14, 39, 0.5); border-radius: 10px; margin-bottom: 12px; }
        .toggle-info h4 { margin: 0 0 4px 0; font-size: 15px; }
        .toggle-info p { margin: 0; font-size: 13px; color: #8892b0; }
        .toggle-switch { position: relative; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #2d3748; border-radius: 26px; transition: 0.3s; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch input:checked + .toggle-slider { background: linear-gradient(135deg, #00d4ff, #06ffa5); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
        .save-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #00d4ff 0%, #06ffa5 100%); border: none; border-radius: 10px; color: #0a0e27; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 20px; }
        .save-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .save-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .status-msg { text-align: center; padding: 12px; border-radius: 8px; margin-top: 16px; display: none; }
        .status-msg.success { display: block; background: rgba(6, 255, 165, 0.2); color: #06ffa5; }
        .status-msg.error { display: block; background: rgba(255, 82, 82, 0.2); color: #ff5252; }
        .feature-disabled-banner { background: rgba(255, 152, 0, 0.2); border: 1px solid #ff9800; border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; }
        .feature-disabled-banner i { color: #ff9800; font-size: 24px; }
        .feature-disabled-banner-content h4 { margin: 0 0 4px 0; color: #ff9800; }
        .feature-disabled-banner-content p { margin: 0; font-size: 13px; color: #ccd6f6; }
        .settings-card.disabled { opacity: 0.5; pointer-events: none; }
        .configuration-section.disabled { opacity: 0.5; pointer-events: none; }
        .info-box { background: rgba(88, 101, 242, 0.15); border: 1px solid rgba(88, 101, 242, 0.3); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: flex-start; gap: 10px; }
        .info-box i { color: #5865f2; margin-top: 2px; }
        .info-box p { margin: 0; font-size: 13px; color: #ccd6f6; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 8px; }
        .badge-recommended { background: rgba(6, 255, 165, 0.2); color: #06ffa5; }
        .badge-caution { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
        .two-col { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        @media (max-width: 600px) { .two-col { grid-template-columns: 1fr; } }
        .channel-select-wrapper { position: relative; }
        .channel-select-wrapper select { padding-left: 36px; }
        .channel-select-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #8892b0; pointer-events: none; }
        
        /* Multi-select channel/role picker */
        .multi-select-container { max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px; }
        .multi-select-container::-webkit-scrollbar { width: 6px; }
        .multi-select-container::-webkit-scrollbar-thumb { background: rgba(0,212,255,0.3); border-radius: 3px; }
        .multi-select-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; margin: 2px 0; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
        .multi-select-item:hover { background: rgba(0,212,255,0.1); }
        .multi-select-item.selected { background: rgba(0,212,255,0.2); border: 1px solid rgba(0,212,255,0.3); }
        .multi-select-item input[type="checkbox"] { width: 16px; height: 16px; accent-color: #00d4ff; }
        .multi-select-item .item-name { flex: 1; font-size: 14px; color: #ccd6f6; }
        .multi-select-item .item-id { font-size: 11px; color: #8892b0; font-family: monospace; }
        .multi-select-loading { padding: 20px; text-align: center; color: #8892b0; }
    </style>
</head>
<body>
    <div class="setup-container">
        <a href="/dashboard" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
        
        <div class="setup-header">
            <h1><i class="fas fa-fish"></i> Anti-Phishing Settings</h1>
            <p>Protect your members from malicious links, scam attempts, and impersonation</p>
        </div>

        <div id="featureDisabledBanner" class="feature-disabled-banner" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <div class="feature-disabled-banner-content">
                <h4>Anti-Phishing is Currently Disabled</h4>
                <p>Enable the toggle below to activate phishing protection. While disabled, phishing links will not be blocked.</p>
            </div>
        </div>

        <!-- Main Toggle -->
        <div class="settings-card">
            <h3><i class="fas fa-shield-alt"></i> Phishing Protection</h3>
            
            <div class="toggle-row">
                <div class="toggle-info">
                    <h4>Enable Anti-Phishing</h4>
                    <p>Automatically scan messages for phishing links and suspicious content</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="antiPhishingEnabled">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Detection Settings -->
        <div class="settings-card configuration-section" id="detectionSettingsCard">
            <h3><i class="fas fa-search"></i> Detection Settings</h3>
            
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <p>Configure what types of phishing attempts to detect. More detection types = better protection but may increase false positives.</p>
            </div>
            
            <div class="toggle-row">
                <div class="toggle-info">
                    <h4>Scan Links <span class="badge badge-recommended">Recommended</span></h4>
                    <p>Check URLs against known phishing databases</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="phishingCheckLinks" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="toggle-row">
                <div class="toggle-info">
                    <h4>Username Impersonation Detection</h4>
                    <p>Detect usernames that mimic staff members or "Discord"</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="phishingCheckUsernames" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="toggle-row">
                <div class="toggle-info">
                    <h4>Detect Fake Admin Names</h4>
                    <p>Flag users with "admin/mod/staff" in username but no permissions</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="phishingCheckFakeAdmin" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="toggle-row">
                <div class="toggle-info">
                    <h4>Detect Unicode Confusables</h4>
                    <p>Catch lookalike characters used to bypass detection (е vs e)</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="phishingCheckUnicode" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">Detection Sensitivity</label>
                <p class="form-desc">How strict should the detection be? Higher = catches more but may have false positives</p>
                <select class="form-select" id="phishingSensitivity">
                    <option value="low">Low - Only obvious phishing attempts</option>
                    <option value="medium" selected>Medium - Balanced detection (Recommended)</option>
                    <option value="high">High - Aggressive detection, may have false positives</option>
                </select>
            </div>
        </div>

        <!-- Action Settings -->
        <div class="settings-card configuration-section" id="actionSettingsCard">
            <h3><i class="fas fa-gavel"></i> Action Settings</h3>
            
            <div class="form-group">
                <label class="form-label">Action on First Detection</label>
                <p class="form-desc">What happens when phishing is first detected from a user</p>
                <select class="form-select" id="phishingAction">
                    <option value="warn">Warn Only - Send warning, log incident</option>
                    <option value="delete" selected>Delete + Warn - Remove message and warn user</option>
                    <option value="mute">Mute - Delete message and timeout user</option>
                    <option value="kick">Kick - Remove user from server</option>
                    <option value="ban">Ban - Permanently ban user</option>
                </select>
            </div>

            <div class="toggle-row">
                <div class="toggle-info">
                    <h4>Auto-Delete Phishing Messages <span class="badge badge-recommended">Recommended</span></h4>
                    <p>Automatically delete messages containing phishing content</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="phishingDeleteMessages" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="toggle-row">
                <div class="toggle-info">
                    <h4>DM User on Detection</h4>
                    <p>Send a warning DM to the user explaining why action was taken</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="phishingDmUser" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">Mute Duration</label>
                <p class="form-desc">How long to mute users (when mute action is selected)</p>
                <select class="form-select" id="phishingMuteDuration">
                    <option value="300">5 minutes</option>
                    <option value="600">10 minutes</option>
                    <option value="1800">30 minutes</option>
                    <option value="3600" selected>1 hour</option>
                    <option value="86400">24 hours</option>
                    <option value="604800">7 days</option>
                </select>
            </div>
        </div>

        <!-- Repeat Offender Settings -->
        <div class="settings-card configuration-section" id="repeatOffenderCard">
            <h3><i class="fas fa-exclamation-triangle"></i> Repeat Offender Settings</h3>
            
            <div class="info-box">
                <i class="fas fa-shield-virus"></i>
                <p>Escalate punishment for users who repeatedly attempt phishing attacks.</p>
            </div>

            <div class="toggle-row">
                <div class="toggle-info">
                    <h4>Escalate for Repeat Offenders</h4>
                    <p>Automatically increase punishment severity for repeat offenders</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="phishingEscalate" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="two-col">
                <div class="form-group">
                    <label class="form-label">Attempts Before Ban</label>
                    <p class="form-desc">Auto-ban after this many phishing attempts</p>
                    <input type="number" class="form-input" id="phishingBanThreshold" value="3" min="1" max="10">
                </div>
                <div class="form-group">
                    <label class="form-label">Reset Period (hours)</label>
                    <p class="form-desc">Clear offense count after this many hours</p>
                    <input type="number" class="form-input" id="phishingResetHours" value="24" min="1" max="168">
                </div>
            </div>
        </div>

        <!-- Logging Settings -->
        <div class="settings-card configuration-section" id="loggingCard">
            <h3><i class="fas fa-clipboard-list"></i> Logging & Notifications</h3>
            
            <div class="form-group">
                <label class="form-label">Phishing Alert Channel</label>
                <p class="form-desc">Channel where phishing detection alerts are sent (leave empty to use default log channel)</p>
                <div class="channel-select-wrapper">
                    <i class="fas fa-hashtag"></i>
                    <select class="form-select" id="phishingLogChannel">
                        <option value="">Use Default Log Channel</option>
                    </select>
                </div>
            </div>

            <div class="toggle-row">
                <div class="toggle-info">
                    <h4>Log All Detections</h4>
                    <p>Create a log entry for every phishing detection</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="phishingLogAll" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="toggle-row">
                <div class="toggle-info">
                    <h4>Notify Staff via Ping</h4>
                    <p>Ping moderators when critical phishing is detected</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="phishingNotifyStaff">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Whitelist Settings -->
        <div class="settings-card configuration-section" id="whitelistCard">
            <h3><i class="fas fa-user-shield"></i> Whitelist & Exemptions</h3>
            
            <div class="form-group">
                <label class="form-label">Whitelisted Roles</label>
                <p class="form-desc">Roles that bypass phishing checks</p>
                <div class="multi-select-container" id="phishingWhitelistRolesContainer">
                    <div class="multi-select-loading">Loading roles...</div>
                </div>
                <input type="hidden" id="phishingWhitelistRoles">
            </div>

            <div class="form-group">
                <label class="form-label">Whitelisted Channels</label>
                <p class="form-desc">Channels where phishing checks are disabled</p>
                <div class="multi-select-container" id="phishingWhitelistChannelsContainer">
                    <div class="multi-select-loading">Loading channels...</div>
                </div>
                <input type="hidden" id="phishingWhitelistChannels">
            </div>

            <div class="form-group">
                <label class="form-label">Whitelisted Domains</label>
                <p class="form-desc">Trusted domains that should never be flagged (one per line)</p>
                <textarea class="form-textarea" id="phishingWhitelistDomains" placeholder="example.com&#10;trusted-site.org" spellcheck="false"></textarea>
            </div>
        </div>

        <!-- Custom Blocked Domains -->
        <div class="settings-card configuration-section" id="customBlockCard">
            <h3><i class="fas fa-ban"></i> Custom Blocked Domains</h3>
            
            <div class="info-box">
                <i class="fas fa-plus-circle"></i>
                <p>Add your own domains to block in addition to the built-in phishing database.</p>
            </div>

            <div class="form-group">
                <label class="form-label">Custom Blocked Domains</label>
                <p class="form-desc">Additional domains to always block (one per line)</p>
                <textarea class="form-textarea" id="phishingCustomBlocked" placeholder="scam-site.com&#10;fake-discord.gg" spellcheck="false"></textarea>
            </div>
        </div>

        <button class="save-btn" id="saveBtn" onclick="saveSettings()">
            <i class="fas fa-save"></i> Save Settings
        </button>
        <div class="status-msg" id="statusMsg"></div>
    </div>

    <script src="/js/secure-auth.js"></script>
    <script>
        const guildId = localStorage.getItem('selectedGuildId');
        let channels = [];
        let roles = [];
        
        // Redirect if no server selected
        if (!guildId) {
            alert('Please select a server first');
            window.location.href = '/dashboard';
        }

        function updateFeatureState(enabled) {
            const banner = document.getElementById('featureDisabledBanner');
            const configSections = document.querySelectorAll('.configuration-section');
            
            if (enabled) {
                banner.style.display = 'none';
                configSections.forEach(section => section.classList.remove('disabled'));
            } else {
                banner.style.display = 'flex';
                configSections.forEach(section => section.classList.add('disabled'));
            }
        }

        async function loadChannelsAndRoles() {
            try {
                const [chRes, roleRes] = await Promise.all([
                    fetch(`/api/guild/${guildId}/channels`, { credentials: 'include' }),
                    fetch(`/api/guild/${guildId}/roles`, { credentials: 'include' })
                ]);
                
                const chPayload = await chRes.json();
                const rolePayload = await roleRes.json();
                
                const chData = chPayload.data || chPayload;
                channels = (chData.channels || chData || []).filter(ch => ch.type === 0);
                
                const roleData = rolePayload.data || rolePayload;
                roles = (roleData.roles || roleData || []).filter(r => r.name !== '@everyone');
                
                // Populate log channel dropdown
                const select = document.getElementById('phishingLogChannel');
                channels.forEach(ch => {
                    const option = document.createElement('option');
                    option.value = ch.id;
                    option.textContent = `#${ch.name}`;
                    select.appendChild(option);
                });
                
                renderChannelMultiSelect();
                renderRoleMultiSelect();
            } catch (e) {
                console.error('Failed to load channels/roles:', e);
            }
        }
        
        function renderChannelMultiSelect() {
            const container = document.getElementById('phishingWhitelistChannelsContainer');
            const selectedIds = (document.getElementById('phishingWhitelistChannels').value || '').split(',').filter(Boolean);
            
            if (!channels.length) {
                container.innerHTML = '<div class="multi-select-loading">No text channels found</div>';
                return;
            }
            
            container.innerHTML = channels.map(ch => {
                const isSelected = selectedIds.includes(ch.id);
                return `
                    <label class="multi-select-item ${isSelected ? 'selected' : ''}" data-id="${ch.id}">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleItem('phishingWhitelistChannels', '${ch.id}', this)">
                        <span class="item-name">#${ch.name}</span>
                        <span class="item-id">${ch.id}</span>
                    </label>
                `;
            }).join('');
        }
        
        function renderRoleMultiSelect() {
            const container = document.getElementById('phishingWhitelistRolesContainer');
            const selectedIds = (document.getElementById('phishingWhitelistRoles').value || '').split(',').filter(Boolean);
            
            if (!roles.length) {
                container.innerHTML = '<div class="multi-select-loading">No roles found</div>';
                return;
            }
            
            container.innerHTML = roles.map(r => {
                const isSelected = selectedIds.includes(r.id);
                const colorStyle = r.color ? `style="color: #${r.color.toString(16).padStart(6, '0')}"` : '';
                return `
                    <label class="multi-select-item ${isSelected ? 'selected' : ''}" data-id="${r.id}">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleItem('phishingWhitelistRoles', '${r.id}', this)">
                        <span class="item-name" ${colorStyle}>@${r.name}</span>
                        <span class="item-id">${r.id}</span>
                    </label>
                `;
            }).join('');
        }
        
        function toggleItem(inputId, id, checkbox) {
            const input = document.getElementById(inputId);
            let ids = (input.value || '').split(',').filter(Boolean);
            
            if (checkbox.checked) {
                if (!ids.includes(id)) ids.push(id);
            } else {
                ids = ids.filter(i => i !== id);
            }
            
            input.value = ids.join(',');
            checkbox.closest('.multi-select-item').classList.toggle('selected', checkbox.checked);
        }
        
        async function loadSettings() {
            if (!guildId) return;
            
            try {
                const res = await fetch(`/api/guild/${guildId}/settings`, { credentials: 'include' });
                if (res.ok) {
                    const response = await res.json();
                    const data = response.data || response;
                    
                    // Main toggle
                    const enabled = data.anti_phishing_enabled || false;
                    document.getElementById('antiPhishingEnabled').checked = enabled;
                    
                    // Detection settings
                    document.getElementById('phishingCheckLinks').checked = data.phishing_check_links !== false;
                    document.getElementById('phishingCheckUsernames').checked = data.phishing_check_usernames !== false;
                    document.getElementById('phishingCheckFakeAdmin').checked = data.phishing_check_fake_admin !== false;
                    document.getElementById('phishingCheckUnicode').checked = data.phishing_check_unicode !== false;
                    document.getElementById('phishingSensitivity').value = data.phishing_sensitivity || 'medium';
                    
                    // Action settings
                    document.getElementById('phishingAction').value = data.phishing_action || 'delete';
                    document.getElementById('phishingDeleteMessages').checked = data.phishing_delete_messages !== false;
                    document.getElementById('phishingDmUser').checked = data.phishing_dm_user !== false;
                    document.getElementById('phishingMuteDuration').value = data.phishing_mute_duration || '3600';
                    
                    // Repeat offender settings
                    document.getElementById('phishingEscalate').checked = data.phishing_escalate !== false;
                    document.getElementById('phishingBanThreshold').value = data.phishing_ban_threshold || 3;
                    document.getElementById('phishingResetHours').value = data.phishing_reset_hours || 24;
                    
                    // Logging settings
                    document.getElementById('phishingLogChannel').value = data.phishing_log_channel || '';
                    document.getElementById('phishingLogAll').checked = data.phishing_log_all !== false;
                    document.getElementById('phishingNotifyStaff').checked = data.phishing_notify_staff || false;
                    
                    // Whitelist settings
                    document.getElementById('phishingWhitelistRoles').value = data.phishing_whitelist_roles || '';
                    document.getElementById('phishingWhitelistChannels').value = data.phishing_whitelist_channels || '';
                    
                    // Re-render multi-selects with loaded values
                    renderRoleMultiSelect();
                    renderChannelMultiSelect();
                    
                    // Parse JSON arrays for textareas
                    try {
                        const whitelistDomains = JSON.parse(data.phishing_whitelist_domains || '[]');
                        document.getElementById('phishingWhitelistDomains').value = whitelistDomains.join('\n');
                    } catch (e) {
                        document.getElementById('phishingWhitelistDomains').value = '';
                    }
                    
                    try {
                        const customBlocked = JSON.parse(data.phishing_custom_blocked || '[]');
                        document.getElementById('phishingCustomBlocked').value = customBlocked.join('\n');
                    } catch (e) {
                        document.getElementById('phishingCustomBlocked').value = '';
                    }
                    
                    updateFeatureState(enabled);
                }
            } catch (e) { console.error('Failed to load settings:', e); }
        }

        async function saveSettings() {
            const btn = document.getElementById('saveBtn');
            const msg = document.getElementById('statusMsg');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            // Parse textarea values into arrays
            const whitelistDomains = document.getElementById('phishingWhitelistDomains').value
                .split('\n')
                .map(d => d.trim().toLowerCase())
                .filter(d => d.length > 0);
            
            const customBlocked = document.getElementById('phishingCustomBlocked').value
                .split('\n')
                .map(d => d.trim().toLowerCase())
                .filter(d => d.length > 0);
            
            try {
                const res = await SecureAuth.fetch(`/api/guild/${guildId}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        // Main toggle
                        anti_phishing_enabled: document.getElementById('antiPhishingEnabled').checked,
                        
                        // Detection settings
                        phishing_check_links: document.getElementById('phishingCheckLinks').checked,
                        phishing_check_usernames: document.getElementById('phishingCheckUsernames').checked,
                        phishing_check_fake_admin: document.getElementById('phishingCheckFakeAdmin').checked,
                        phishing_check_unicode: document.getElementById('phishingCheckUnicode').checked,
                        phishing_sensitivity: document.getElementById('phishingSensitivity').value,
                        
                        // Action settings
                        phishing_action: document.getElementById('phishingAction').value,
                        phishing_delete_messages: document.getElementById('phishingDeleteMessages').checked,
                        phishing_dm_user: document.getElementById('phishingDmUser').checked,
                        phishing_mute_duration: parseInt(document.getElementById('phishingMuteDuration').value),
                        
                        // Repeat offender settings
                        phishing_escalate: document.getElementById('phishingEscalate').checked,
                        phishing_ban_threshold: parseInt(document.getElementById('phishingBanThreshold').value),
                        phishing_reset_hours: parseInt(document.getElementById('phishingResetHours').value),
                        
                        // Logging settings
                        phishing_log_channel: document.getElementById('phishingLogChannel').value,
                        phishing_log_all: document.getElementById('phishingLogAll').checked,
                        phishing_notify_staff: document.getElementById('phishingNotifyStaff').checked,
                        
                        // Whitelist settings
                        phishing_whitelist_roles: document.getElementById('phishingWhitelistRoles').value.trim(),
                        phishing_whitelist_channels: document.getElementById('phishingWhitelistChannels').value.trim(),
                        phishing_whitelist_domains: JSON.stringify(whitelistDomains),
                        phishing_custom_blocked: JSON.stringify(customBlocked)
                    })
                });
                
                const response = await res.json();
                if (res.ok && (response.success !== false)) {
                    msg.className = 'status-msg success';
                    msg.textContent = '✓ Settings saved successfully!';
                } else {
                    throw new Error(response.error || 'Failed to save');
                }
            } catch (e) {
                msg.className = 'status-msg error';
                msg.textContent = '✗ ' + (e.message || 'Failed to save settings');
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Save Settings';
            setTimeout(() => msg.className = 'status-msg', 3000);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await SecureAuth.init();
            await loadChannelsAndRoles();
            await loadSettings();
            
            // Real-time toggle update
            document.getElementById('antiPhishingEnabled').addEventListener('change', function() {
                updateFeatureState(this.checked);
            });
        });
    </script>
    <script src="/js/language-loader.js"></script>
</body>
</html>
