<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="">
    <title>Server Backups - DarkLock Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="/css/design-system.css">
    <link rel="stylesheet" href="/css/settings-panel.css">
    <link id="dynamic-theme-stylesheet" rel="stylesheet" href="">
    <script src="/js/global-theme.js"></script>
    <script src="/js/theme-effects.js"></script>
    <script src="/js/settings-panel.js"></script>
    <style>
        body {
            background: var(--ds-surface-0);
            font-family: var(--ds-font-family);
            color: var(--ds-text-primary);
        }
        
        .backup-code {
            font-family: var(--ds-font-mono);
            background: var(--ds-surface-2);
            padding: 0.75rem 1rem;
            border-radius: var(--ds-radius-md);
            border: 1px dashed var(--ds-border);
            user-select: all;
            color: var(--ds-primary);
            font-size: 0.9rem;
            display: inline-block;
        }
        
        .backup-card {
            background: var(--ds-surface-1);
            border: 1px solid var(--ds-border);
            border-radius: var(--ds-radius-lg);
            padding: 1.5rem;
            transition: all var(--ds-transition-base);
        }
        
        .backup-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--ds-shadow-lg), var(--ds-shadow-glow);
            border-color: var(--ds-primary-border);
        }
        
        .integrity-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--ds-radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .integrity-badge.verified {
            background: var(--ds-success-bg);
            color: var(--ds-success);
            border: 1px solid var(--ds-success-border);
        }
        
        .integrity-badge.legacy {
            background: var(--ds-warning-bg);
            color: var(--ds-warning);
            border: 1px solid var(--ds-warning-border);
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, var(--ds-surface-1) 25%, var(--ds-surface-2) 50%, var(--ds-surface-1) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--ds-radius-lg);
            height: 150px;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .stat-card {
            background: var(--ds-surface-1);
            border: 1px solid var(--ds-border);
            border-radius: var(--ds-radius-lg);
            padding: 1.5rem;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--ds-primary);
        }
        
        .stat-title {
            color: var(--ds-text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .collapse-panel {
            background: var(--ds-surface-1);
            border: 1px solid var(--ds-border);
            border-radius: var(--ds-radius-lg);
            overflow: hidden;
        }
        
        .collapse-header {
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all var(--ds-transition-fast);
            background: var(--ds-surface-1);
        }
        
        .collapse-header:hover {
            background: var(--ds-surface-2);
        }
        
        .collapse-content {
            padding: 0 1.5rem 1.5rem;
            display: none;
        }
        
        .collapse-panel.expanded .collapse-content {
            display: block;
        }
        
        .collapse-panel.expanded .collapse-icon {
            transform: rotate(90deg);
        }
        
        .collapse-icon {
            transition: transform var(--ds-transition-base);
            color: var(--ds-text-secondary);
        }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-box {
            background: var(--ds-surface-1);
            border: 1px solid var(--ds-border);
            border-radius: var(--ds-radius-xl);
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--ds-shadow-xl);
        }
        
        .modal-box.large {
            max-width: 800px;
        }
        
        .divider {
            height: 1px;
            background: var(--ds-border);
            margin: 1.5rem 0;
        }
        
        @media (max-width: 768px) {
            .backup-card .flex {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .backup-card .flex {
                flex-direction: column;
            }
            
            .backup-card .flex > div:last-child {
                align-self: flex-end;
                margin-top: 1rem;
            }
        }
    </style>
</head>
<body class="bg-base-300 min-h-screen">
    <!-- Navigation -->
    <nav class="ds-nav">
        <div class="ds-container" style="display: flex; justify-content: space-between; align-items: center;">
            <a href="/dashboard" class="ds-btn ds-btn-ghost">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Dashboard</span>
            </a>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="server-selector-container"></div>
                <span class="text-sm" style="color: var(--ds-text-secondary);" id="guildName">Loading...</span>
            </div>
        </div>
    </nav>

    <!-- Include shared server selector component -->
    <script src="/js/server-selector.js"></script>

    <div class="ds-container" style="padding: 2rem 1rem; max-width: 1200px;">
        <!-- Header -->
        <div class="ds-header" style="text-align: center; margin-bottom: 3rem;">
            <h1 class="ds-heading" style="font-size: 2.5rem; margin-bottom: 0.5rem;">
                <i class="fas fa-database" style="color: var(--ds-primary); margin-right: 0.75rem;"></i>
                Server Backups
            </h1>
            <p style="color: var(--ds-text-secondary);">
                Manage your server backup codes. Save these codes to restore your server later.
            </p>
        </div>

        <!-- Important Notice -->
        <div class="ds-alert ds-alert-warning" style="margin-bottom: 2rem;">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <h3 style="font-weight: 600; margin-bottom: 0.25rem;">Important: Save Your Backup Codes!</h3>
                <p style="font-size: 0.875rem; color: var(--ds-text-secondary);">Copy and save your backup codes in a safe place. You'll need these codes to restore your server if anything goes wrong.</p>
            </div>
        </div>

        <!-- Stats and Create Button -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
            <div class="stat-card">
                <div class="stat-title">Total Backups</div>
                <div class="stat-value" id="backupCount">-</div>
            </div>
            <button class="ds-btn ds-btn-primary ds-btn-lg" onclick="createBackup()">
                <i class="fas fa-plus"></i>
                <span>Create New Backup</span>
            </button>
        </div>

        <!-- Scheduled Backup Settings -->
        <div class="collapse-panel" id="schedulePanel" style="margin-bottom: 2rem;">
            <div class="collapse-header" onclick="toggleCollapse('schedulePanel')">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <i class="fas fa-clock" style="color: var(--ds-primary);"></i>
                    <span style="font-size: 1.125rem; font-weight: 600;">Automatic Backup Schedule</span>
                </div>
                <i class="fas fa-chevron-right collapse-icon"></i>
            </div>
            <div class="collapse-content">
                <div class="divider"></div>
                <form id="scheduleForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Enable/Disable -->
                    <div class="ds-form-group">
                        <label class="ds-label" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                            <span>
                                <i class="fas fa-toggle-on" style="margin-right: 0.5rem; color: var(--ds-primary);"></i>
                                Enable Automatic Backups
                            </span>
                            <input type="checkbox" id="scheduleEnabled" class="ds-toggle" onchange="toggleScheduleOptions()" />
                        </label>
                        <small style="color: var(--ds-text-muted); font-size: 0.875rem;">Automatically create backups at scheduled times</small>
                    </div>

                    <div id="scheduleOptions" style="display: flex; flex-direction: column; gap: 1.5rem; opacity: 0.5; pointer-events: none;">
                        <!-- Frequency -->
                        <div class="ds-form-group">
                            <label class="ds-label">Backup Frequency</label>
                            <select id="scheduleFrequency" class="ds-select">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>

                        <!-- Time -->
                        <div class="ds-form-group">
                            <label class="ds-label">Backup Time (UTC)</label>
                            <input type="time" id="scheduleTime" value="03:00" class="ds-input" />
                            <small style="color: var(--ds-text-muted); font-size: 0.875rem;">Time in UTC (Universal Coordinated Time)</small>
                        </div>

                        <!-- Retention -->
                        <div class="ds-form-group">
                            <label class="ds-label">Keep Last N Backups</label>
                            <input type="number" id="scheduleRetention" value="7" min="1" max="30" class="ds-input" />
                            <small style="color: var(--ds-text-muted); font-size: 0.875rem;">Older backups will be automatically deleted</small>
                        </div>

                        <!-- Include Options -->
                        <div class="ds-form-group">
                            <label class="ds-label" style="font-weight: 600; margin-bottom: 0.75rem;">What to Include</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-left: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="autoIncludeChannels" class="ds-checkbox" checked />
                                    <span>Channels</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="autoIncludeRoles" class="ds-checkbox" checked />
                                    <span>Roles</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="autoIncludeEmojis" class="ds-checkbox" checked />
                                    <span>Emojis</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="autoIncludeBans" class="ds-checkbox" />
                                    <span>Bans</span>
                                </label>
                            </div>
                    </div>

                    <div class="divider"></div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 0.75rem;">
                        <button type="button" class="ds-btn ds-btn-ghost" onclick="loadScheduleSettings()">
                            <i class="fas fa-undo"></i>
                            <span>Reset</span>
                        </button>
                        <button type="button" class="ds-btn ds-btn-primary" onclick="saveScheduleSettings()">
                            <i class="fas fa-save"></i>
                            <span>Save Schedule</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Backups List -->
        <div id="backupsList" style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- Loading skeleton -->
            <div class="loading-skeleton"></div>
            <div class="loading-skeleton"></div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" style="display: none; text-align: center; padding: 4rem 0;">
            <i class="fas fa-box-open" style="font-size: 4rem; color: var(--ds-text-muted); margin-bottom: 1rem;"></i>
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">No Backups Yet</h3>
            <p style="color: var(--ds-text-secondary); margin-bottom: 1.5rem;">Create your first backup to protect your server configuration.</p>
            <button class="ds-btn ds-btn-primary" onclick="createBackup()">
                <i class="fas fa-plus"></i>
                <span>Create First Backup</span>
            </button>
        </div>
    </div>

    <!-- Create Backup Modal -->
    <dialog id="createBackupModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">
                <i class="fas fa-database text-primary mr-2"></i>
                Create Server Backup
            </h3>
            <form id="createBackupForm">
                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text">Description (optional)</span>
                    </label>
                    <input type="text" id="backupDescription" placeholder="e.g., Before major changes" class="input input-bordered w-full" />
                </div>
                
                <div class="form-control mb-2">
                    <label class="label cursor-pointer">
                        <span class="label-text">Include Roles</span>
                        <input type="checkbox" id="includeRoles" checked class="checkbox checkbox-primary" />
                    </label>
                </div>
                <div class="form-control mb-2">
                    <label class="label cursor-pointer">
                        <span class="label-text">Include Channels</span>
                        <input type="checkbox" id="includeChannels" checked class="checkbox checkbox-primary" />
                    </label>
                </div>
                <div class="form-control mb-2">
                    <label class="label cursor-pointer">
                        <span class="label-text">Include Settings</span>
                        <input type="checkbox" id="includeSettings" checked class="checkbox checkbox-primary" />
                    </label>
                </div>
                <div class="form-control mb-4">
                    <label class="label cursor-pointer">
                        <span class="label-text">Include Bans</span>
                        <input type="checkbox" id="includeBans" class="checkbox checkbox-primary" />
                    </label>
                </div>
            </form>
            <div class="modal-action">
                <button class="btn" onclick="document.getElementById('createBackupModal').close()">Cancel</button>
                <button class="btn btn-primary" onclick="submitCreateBackup()">
                    <i class="fas fa-save mr-2"></i> Create Backup
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Backup Created Modal -->
    <dialog id="backupCreatedModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg text-success mb-4">
                <i class="fas fa-check-circle mr-2"></i>
                Backup Created Successfully!
            </h3>
            <div class="alert alert-info mb-4">
                <i class="fas fa-key"></i>
                <div>
                    <h4 class="font-bold">Your Backup Code</h4>
                    <p class="text-sm">Save this code! You'll need it to restore your server.</p>
                </div>
            </div>
            <div class="flex items-center gap-2 mb-4">
                <code class="backup-code flex-1 text-lg" id="newBackupCode">-</code>
                <button class="btn btn-square btn-primary copy-btn" onclick="copyNewBackupCode()">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            <div class="text-sm text-base-content/70">
                <p><strong>Size:</strong> <span id="newBackupSize">-</span></p>
                <p><strong>Includes:</strong> <span id="newBackupIncludes">-</span></p>
            </div>
            <div class="modal-action">
                <button class="btn btn-primary" onclick="document.getElementById('backupCreatedModal').close(); loadBackups();">
                    Done
                </button>
            </div>
        </div>
    </dialog>

    <!-- Backup Details Modal -->
    <dialog id="backupDetailsModal" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">
                <i class="fas fa-info-circle text-primary mr-2"></i>
                Backup Details
            </h3>
            <div id="backupDetailsContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-action">
                <button class="btn" onclick="document.getElementById('backupDetailsModal').close()">Close</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Delete Confirmation Modal -->
    <dialog id="deleteConfirmModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg text-error mb-4">
                <i class="fas fa-trash-alt mr-2"></i>
                Delete Backup?
            </h3>
            <p class="mb-4">Are you sure you want to delete this backup? This action cannot be undone.</p>
            <p class="text-sm text-base-content/70 mb-4">
                Backup Code: <code class="backup-code text-sm" id="deleteBackupCode">-</code>
            </p>
            <div class="modal-action">
                <button class="btn" onclick="document.getElementById('deleteConfirmModal').close()">Cancel</button>
                <button class="btn btn-error" id="confirmDeleteBtn">
                    <i class="fas fa-trash-alt mr-2"></i> Delete
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Restore Backup Modal -->
    <dialog id="restoreBackupModal" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg text-warning mb-4">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Restore Backup - Warning!
            </h3>
            
            <div class="alert alert-error mb-4">
                <i class="fas fa-skull-crossbones"></i>
                <div>
                    <h4 class="font-bold">⚠️ DESTRUCTIVE ACTION</h4>
                    <p class="text-sm">This will overwrite your current server configuration!</p>
                </div>
            </div>

            <div class="mb-4">
                <p class="text-sm mb-2">
                    <strong>Backup Code:</strong> <code class="backup-code text-sm" id="restoreBackupCode">-</code>
                </p>
                <p class="text-sm mb-4" id="restoreBackupDescription"></p>
            </div>

            <div class="divider">Restore Options</div>

            <div class="form-control mb-3">
                <label class="label cursor-pointer justify-start gap-3">
                    <input type="checkbox" id="restoreDeleteChannels" class="checkbox checkbox-warning" />
                    <div>
                        <span class="label-text font-semibold">Delete existing channels</span>
                        <p class="text-xs text-base-content/70">Remove all current channels before restoring</p>
                    </div>
                </label>
            </div>

            <div class="form-control mb-3">
                <label class="label cursor-pointer justify-start gap-3">
                    <input type="checkbox" id="restoreDeleteRoles" class="checkbox checkbox-warning" />
                    <div>
                        <span class="label-text font-semibold">Delete existing roles</span>
                        <p class="text-xs text-base-content/70">Remove all current roles before restoring (except @everyone)</p>
                    </div>
                </label>
            </div>

            <div class="form-control mb-4">
                <label class="label cursor-pointer justify-start gap-3">
                    <input type="checkbox" id="restoreSettings" checked class="checkbox checkbox-primary" />
                    <div>
                        <span class="label-text font-semibold">Restore server settings</span>
                        <p class="text-xs text-base-content/70">Restore server name, icon, and other settings</p>
                    </div>
                </label>
            </div>

            <div class="divider">Confirmation Required</div>

            <div class="alert alert-warning mb-4">
                <i class="fas fa-exclamation-triangle"></i>
                <p class="text-sm">Type the confirmation text below to proceed:</p>
            </div>

            <div class="form-control mb-4">
                <input 
                    type="text" 
                    id="restoreConfirmation" 
                    placeholder="I UNDERSTAND THIS WILL OVERWRITE CURRENT SETTINGS" 
                    class="input input-bordered w-full font-mono text-sm" 
                />
                <label class="label">
                    <span class="label-text-alt text-error">Required: "I UNDERSTAND THIS WILL OVERWRITE CURRENT SETTINGS"</span>
                </label>
            </div>

            <div class="modal-action">
                <button class="btn" onclick="document.getElementById('restoreBackupModal').close()">Cancel</button>
                <button class="btn btn-warning" id="confirmRestoreBtn" onclick="executeRestore()">
                    <i class="fas fa-redo mr-2"></i> Restore Backup
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Restore Progress Modal -->
    <dialog id="restoreProgressModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">
                <i class="fas fa-spinner fa-spin text-primary mr-2"></i>
                Restoring Backup...
            </h3>
            <p class="text-sm text-base-content/70 mb-4">Please wait while your server is being restored. This may take several minutes.</p>
            
            <div class="w-full bg-base-300 rounded-full h-2.5 mb-4">
                <div class="bg-primary h-2.5 rounded-full animate-pulse" style="width: 100%"></div>
            </div>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <p class="text-sm">Do not close this window or refresh the page.</p>
            </div>
        </div>
    </dialog>

    <script>
        // Toggle collapse panel
        function toggleCollapse(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.toggle('expanded');
            }
        }
        
        // Get guild ID from URL or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        let guildId = urlParams.get('guild');
        
        // If no guild in URL, try localStorage
        if (!guildId) {
            guildId = localStorage.getItem('selectedGuildId');
        }
        
        if (!guildId) {
            showToast('No server selected. Redirecting...', 'error');
            setTimeout(() => window.location.href = '/dashboard', 2000);
        }

        // Helper function to get guild ID
        function getGuildId() {
            return guildId;
        }

        // Get CSRF token helper
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]')?.content || '';
        }

        // Fetch CSRF token from server
        async function fetchCSRFToken() {
            try {
                const response = await fetch('/api/csrf-token', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    document.querySelector('meta[name="csrf-token"]').content = data.csrfToken;
                }
            } catch (error) {
                console.error('Failed to fetch CSRF token:', error);
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast toast-end';
            const alertClass = type === 'error' ? 'alert-error' : type === 'warning' ? 'alert-warning' : 'alert-success';
            const icon = type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-check-circle';
            
            toast.innerHTML = `
                <div class="alert ${alertClass}">
                    <i class="fas ${icon}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Load backups on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchCSRFToken();
            if (guildId) {
                loadBackups();
            }
        });

        async function loadBackups() {
            try {
                const response = await fetch(`/api/guilds/${guildId}/backups`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to load backups' }));
                    
                    // Handle specific error cases
                    if (response.status === 403 && errorData.error?.includes('not a member')) {
                        document.getElementById('backupsList').innerHTML = `
                            <div style="text-align: center; padding: 3rem; background: var(--ds-surface-1); border: 1px solid var(--ds-border); border-radius: var(--ds-radius-lg);">
                                <i class="fas fa-user-slash" style="font-size: 4rem; color: var(--ds-text-muted); margin-bottom: 1.5rem;"></i>
                                <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--ds-text-primary);">Access Denied</h3>
                                <p style="color: var(--ds-text-secondary); margin-bottom: 1.5rem;">You are not a member of this server.</p>
                                <a href="/dashboard" class="ds-btn ds-btn-primary">
                                    <i class="fas fa-arrow-left"></i>
                                    <span>Back to Dashboard</span>
                                </a>
                            </div>
                        `;
                        document.getElementById('emptyState').style.display = 'none';
                        return;
                    }
                    
                    throw new Error(errorData.error || 'Failed to load backups');
                }
                
                const data = await response.json();
                
                document.getElementById('guildName').textContent = data.guildName || 'Unknown Server';
                document.getElementById('backupCount').textContent = data.backupCount || 0;
                
                renderBackups(data.backups || []);
            } catch (error) {
                console.error('Error loading backups:', error);
                document.getElementById('backupsList').innerHTML = `
                    <div style="padding: 1.5rem; background: var(--ds-danger-bg); border: 1px solid var(--ds-danger-border); border-radius: var(--ds-radius-lg);">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <i class="fas fa-exclamation-circle" style="color: var(--ds-danger); font-size: 1.5rem; margin-top: 0.25rem;"></i>
                            <div>
                                <h3 style="font-weight: 600; color: var(--ds-danger); margin-bottom: 0.5rem;">Failed to Load Backups</h3>
                                <p style="color: var(--ds-text-secondary); font-size: 0.875rem;">${error.message}</p>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('emptyState').style.display = 'none';
            }
        }

        function renderBackups(backups) {
            const container = document.getElementById('backupsList');
            const emptyState = document.getElementById('emptyState');
            
            if (backups.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            container.innerHTML = backups.map(backup => {
                const includesText = Object.entries(backup.includes || {})
                    .filter(([k, v]) => v)
                    .map(([k]) => k.charAt(0).toUpperCase() + k.slice(1))
                    .join(', ') || 'None';
                
                return `
                <div class="card bg-base-100 shadow-xl backup-card">
                    <div class="card-body">
                        <div class="flex flex-wrap items-start justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-3 mb-2 flex-wrap">
                                    <h2 class="card-title text-lg truncate">
                                        <i class="fas fa-archive text-primary"></i>
                                        ${backup.description || 'Server Backup'}
                                    </h2>
                                    <span class="badge ${backup.type === 'auto' ? 'badge-secondary' : 'badge-primary'}">
                                        ${backup.type === 'auto' ? 'Auto' : 'Manual'}
                                    </span>
                                    <span class="integrity-badge ${backup.integrityStatus}">
                                        ${backup.integrityStatus === 'verified' ? '✓ Verified' : '⚠ Legacy'}
                                    </span>
                                </div>
                                
                                <div class="flex items-center gap-2 mb-3 flex-wrap">
                                    <span class="text-sm text-base-content/70">Code:</span>
                                    <code class="backup-code text-xs">${backup.backupCode}</code>
                                    <button class="btn btn-xs btn-ghost copy-btn" onclick="copyToClipboard('${backup.backupCode}', event)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                
                                <div class="flex flex-wrap gap-4 text-sm text-base-content/70">
                                    <span><i class="fas fa-calendar mr-1"></i> ${backup.createdAtFormatted}</span>
                                    <span><i class="fas fa-hdd mr-1"></i> ${backup.sizeFormatted}</span>
                                    <span><i class="fas fa-layer-group mr-1"></i> ${includesText}</span>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button class="btn btn-sm btn-success" onclick="confirmRestore('${backup.id}', '${backup.backupCode}', '${backup.description || 'Server Backup'}')" title="Restore">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button class="btn btn-sm btn-info" onclick="viewBackupDetails('${backup.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-error" onclick="confirmDelete('${backup.id}', '${backup.backupCode}')" title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function createBackup() {
            document.getElementById('createBackupModal').showModal();
        }

        async function submitCreateBackup() {
            const description = document.getElementById('backupDescription').value;
            const includeRoles = document.getElementById('includeRoles').checked;
            const includeChannels = document.getElementById('includeChannels').checked;
            const includeSettings = document.getElementById('includeSettings').checked;
            const includeBans = document.getElementById('includeBans').checked;
            
            const submitBtn = document.querySelector('#createBackupModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Creating...';
            
            try {
                const response = await fetch(`/api/guilds/${guildId}/backups`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCSRFToken()
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        description,
                        includeRoles,
                        includeChannels,
                        includeSettings,
                        includeBans
                    })
                });
                
                const data = await response.json();
                
                document.getElementById('createBackupModal').close();
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (response.ok && data.success) {
                    // Show success modal with backup code
                    document.getElementById('newBackupCode').textContent = data.backup.backupCode;
                    document.getElementById('newBackupSize').textContent = data.backup.sizeFormatted;
                    
                    const includesText = Object.entries(data.backup.includes)
                        .filter(([k, v]) => v)
                        .map(([k]) => k.charAt(0).toUpperCase() + k.slice(1))
                        .join(', ');
                    document.getElementById('newBackupIncludes').textContent = includesText || 'None';
                    document.getElementById('backupCreatedModal').showModal();
                } else {
                    showToast(data.error || data.message || 'Failed to create backup', 'error');
                }
            } catch (error) {
                console.error('Error creating backup:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                showToast('Failed to create backup. Please try again.', 'error');
            }
        }

        async function viewBackupDetails(backupId) {
            try {
                const response = await fetch(`/api/guilds/${guildId}/backups/${backupId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load backup details');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const backup = data.backup;
                    const includesText = Object.entries(backup.includes || {})
                        .filter(([k, v]) => v)
                        .map(([k]) => k.charAt(0).toUpperCase() + k.slice(1))
                        .join(', ');
                    
                    document.getElementById('backupDetailsContent').innerHTML = `
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="font-semibold">Backup Code:</span>
                                <code class="backup-code">${backup.backupCode}</code>
                                <button class="btn btn-xs btn-primary copy-btn" onclick="copyToClipboard('${backup.backupCode}', event)">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <span class="text-base-content/70">Type:</span>
                                    <span class="badge ${backup.type === 'auto' ? 'badge-secondary' : 'badge-primary'} ml-2">
                                        ${backup.type}
                                    </span>
                                </div>
                                <div>
                                    <span class="text-base-content/70">Size:</span>
                                    <span class="ml-2">${backup.sizeFormatted}</span>
                                </div>
                                <div>
                                    <span class="text-base-content/70">Created:</span>
                                    <span class="ml-2">${backup.createdAtFormatted}</span>
                                </div>
                                <div>
                                    <span class="text-base-content/70">Integrity:</span>
                                    <span class="integrity-badge ${backup.integrity?.valid ? 'verified' : 'legacy'} ml-2">
                                        ${backup.integrity?.valid ? '✓ Verified' : '⚠ Legacy'}
                                    </span>
                                </div>
                                <div class="col-span-1 md:col-span-2">
                                    <span class="text-base-content/70">Includes:</span>
                                    <span class="ml-2">${includesText}</span>
                                </div>
                            </div>
                            
                            ${backup.contentSummary ? `
                                <div class="divider">Content Summary</div>
                                <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
                                    <div class="stat">
                                        <div class="stat-title">Roles</div>
                                        <div class="stat-value text-primary">${backup.contentSummary.roles}</div>
                                    </div>
                                    <div class="stat">
                                        <div class="stat-title">Channels</div>
                                        <div class="stat-value text-secondary">${backup.contentSummary.channels}</div>
                                    </div>
                                    <div class="stat">
                                        <div class="stat-title">Categories</div>
                                        <div class="stat-value text-accent">${backup.contentSummary.categories}</div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${backup.description ? `
                                <div>
                                    <span class="text-base-content/70">Description:</span>
                                    <p class="mt-1">${backup.description}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    document.getElementById('backupDetailsModal').showModal();
                }
            } catch (error) {
                console.error('Error loading backup details:', error);
                showToast('Failed to load backup details.', 'error');
            }
        }

        function confirmDelete(backupId, backupCode) {
            document.getElementById('deleteBackupCode').textContent = backupCode;
            document.getElementById('confirmDeleteBtn').onclick = () => deleteBackup(backupId);
            document.getElementById('deleteConfirmModal').showModal();
        }

        async function deleteBackup(backupId) {
            const deleteBtn = document.getElementById('confirmDeleteBtn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Deleting...';
            
            try {
                const response = await fetch(`/api/guilds/${guildId}/backups/${backupId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'X-CSRF-Token': getCSRFToken()
                    }
                });
                
                const data = await response.json();
                
                document.getElementById('deleteConfirmModal').close();
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
                
                if (data.success) {
                    showToast('Backup deleted successfully', 'success');
                    loadBackups();
                } else {
                    showToast(data.error || 'Failed to delete backup', 'error');
                }
            } catch (error) {
                console.error('Error deleting backup:', error);
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
                showToast('Failed to delete backup. Please try again.', 'error');
            }
        }

        function copyToClipboard(text, event) {
            if (event) event.preventDefault();
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }

        function copyNewBackupCode() {
            const code = document.getElementById('newBackupCode').textContent;
            copyToClipboard(code);
        }

        // Restore backup functions
        let currentRestoreId = null;

        function confirmRestore(backupId, backupCode, description) {
            currentRestoreId = backupId;
            document.getElementById('restoreBackupCode').textContent = backupCode;
            document.getElementById('restoreBackupDescription').textContent = description;
            document.getElementById('restoreConfirmation').value = '';
            document.getElementById('restoreDeleteChannels').checked = false;
            document.getElementById('restoreDeleteRoles').checked = false;
            document.getElementById('restoreSettings').checked = true;
            document.getElementById('restoreBackupModal').showModal();
        }

        async function executeRestore() {
            const confirmation = document.getElementById('restoreConfirmation').value;
            const expectedText = 'I UNDERSTAND THIS WILL OVERWRITE CURRENT SETTINGS';
            
            if (confirmation !== expectedText) {
                showToast('Please type the confirmation text exactly as shown', 'error');
                return;
            }

            const deleteChannels = document.getElementById('restoreDeleteChannels').checked;
            const deleteRoles = document.getElementById('restoreDeleteRoles').checked;
            const restoreSettings = document.getElementById('restoreSettings').checked;

            // Close restore modal and show progress
            document.getElementById('restoreBackupModal').close();
            document.getElementById('restoreProgressModal').showModal();

            try {
                const response = await fetch(`/api/guilds/${guildId}/backups/${currentRestoreId}/restore`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCSRFToken()
                    },
                    body: JSON.stringify({
                        deleteChannels,
                        deleteRoles,
                        restoreSettings,
                        confirmation: expectedText
                    })
                });

                const data = await response.json();
                
                document.getElementById('restoreProgressModal').close();

                if (response.ok && data.success) {
                    showToast('✅ Backup restored successfully!', 'success');
                    
                    // Show stats if available
                    if (data.stats) {
                        const statsMsg = `Restored: ${data.stats.roles || 0} roles, ${data.stats.channels || 0} channels`;
                        setTimeout(() => showToast(statsMsg, 'success'), 1000);
                    }
                    
                    // Show warnings if any
                    if (data.warnings && data.warnings.length > 0) {
                        setTimeout(() => {
                            data.warnings.forEach(warn => showToast(warn, 'warning'));
                        }, 2000);
                    }

                    // Reload backups list
                    setTimeout(() => loadBackups(), 3000);
                } else {
                    showToast(data.error || 'Failed to restore backup', 'error');
                    if (data.details) {
                        console.error('Restore details:', data.details);
                    }
                }
            } catch (error) {
                document.getElementById('restoreProgressModal').close();
                console.error('Error restoring backup:', error);
                showToast('Failed to restore backup. Please try again.', 'error');
            }
        }

        // ===== Scheduled Backup Functions =====
        
        function toggleScheduleOptions() {
            const enabled = document.getElementById('scheduleEnabled').checked;
            const options = document.getElementById('scheduleOptions');
            
            if (enabled) {
                options.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                options.classList.add('opacity-50', 'pointer-events-none');
            }
        }

        async function loadScheduleSettings() {
            const guildId = getGuildId();
            if (!guildId) return;

            try {
                const response = await fetch(`/api/guilds/${guildId}/backup-schedule`, {
                    credentials: 'include'
                });
                
                // Silently fail if user doesn't have access (403) or feature not enabled
                if (!response.ok) {
                    if (response.status === 403) {
                        console.log('User does not have access to backup schedule settings');
                        return;
                    }
                    throw new Error('Failed to load schedule settings');
                }
                
                const data = await response.json();
                
                if (data.success && data.schedule) {
                    document.getElementById('scheduleEnabled').checked = data.schedule.enabled || false;
                    document.getElementById('scheduleFrequency').value = data.schedule.frequency || 'daily';
                    document.getElementById('scheduleTime').value = data.schedule.time || '03:00';
                    document.getElementById('scheduleRetention').value = data.schedule.retention || 7;
                    document.getElementById('autoIncludeChannels').checked = data.schedule.include_channels !== false;
                    document.getElementById('autoIncludeRoles').checked = data.schedule.include_roles !== false;
                    document.getElementById('autoIncludeEmojis').checked = data.schedule.include_emojis !== false;
                    document.getElementById('autoIncludeBans').checked = data.schedule.include_bans || false;
                    
                    toggleScheduleOptions();
                }
            } catch (error) {
                console.error('Error loading schedule settings:', error);
            }
        }

        async function saveScheduleSettings() {
            const guildId = getGuildId();
            if (!guildId) {
                showToast('Guild ID not found', 'error');
                return;
            }

            const schedule = {
                enabled: document.getElementById('scheduleEnabled').checked,
                frequency: document.getElementById('scheduleFrequency').value,
                time: document.getElementById('scheduleTime').value,
                retention: parseInt(document.getElementById('scheduleRetention').value),
                include_channels: document.getElementById('autoIncludeChannels').checked,
                include_roles: document.getElementById('autoIncludeRoles').checked,
                include_emojis: document.getElementById('autoIncludeEmojis').checked,
                include_bans: document.getElementById('autoIncludeBans').checked
            };

            // Validate retention
            if (schedule.retention < 1 || schedule.retention > 30) {
                showToast('Retention must be between 1 and 30 backups', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/guilds/${guildId}/backup-schedule`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCSRFToken()
                    },
                    body: JSON.stringify(schedule)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Backup schedule saved successfully', 'success');
                    if (schedule.enabled) {
                        showToast(`Next backup: ${data.nextBackup || 'Scheduled'}`, 'info');
                    }
                } else {
                    showToast(data.error || 'Failed to save schedule', 'error');
                }
            } catch (error) {
                console.error('Error saving schedule:', error);
                showToast('Failed to save schedule. Please try again.', 'error');
            }
        }

        // Load schedule settings when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Wait a bit for guild ID to be set
            setTimeout(() => {
                loadScheduleSettings();
            }, 1000);
        });
    </script>
    <script src="/js/language-loader.js"></script>
</body>
</html>
