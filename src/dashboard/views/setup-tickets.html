<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="">
    <title>Ticket System Settings - DarkLock Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/design-system.css">
    <link rel="stylesheet" href="/css/premium-gating.css">
    <link id="dynamic-theme-stylesheet" rel="stylesheet" href="/api/v4/admin/theme/css">
    <script src="/js/global-theme.js"></script>
    <script src="/js/theme-effects.js"></script>
    <script src="/js/premium-gating.js"></script>
    <style>
        .setup-page { min-height: 100vh; background: var(--ds-surface-0); }
        .setup-nav { position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: var(--ds-space-md) var(--ds-space-xl); background: var(--ds-surface-1); border-bottom: 1px solid var(--ds-border); backdrop-filter: blur(12px); }
        .back-button { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--ds-surface-2); border: 1px solid var(--ds-border); border-radius: var(--ds-radius-md); color: var(--ds-text-primary); text-decoration: none; font-size: 14px; font-weight: 500; transition: all var(--ds-transition-fast); }
        .back-button:hover { background: var(--ds-surface-3); border-color: var(--ds-primary); transform: translateX(-2px); }
        .back-button i { font-size: 12px; }
        .setup-breadcrumb { display: flex; align-items: center; gap: var(--ds-space-sm); font-size: 14px; color: var(--ds-text-muted); }
        .setup-breadcrumb a { color: var(--ds-text-muted); text-decoration: none; }
        .setup-breadcrumb a:hover { color: var(--ds-primary); }
        .setup-breadcrumb-current { color: var(--ds-text-primary); font-weight: 500; }
        .setup-container { max-width: 900px; margin: 0 auto; padding: var(--ds-space-xl) var(--ds-space-lg); }
        .setup-header { margin-bottom: var(--ds-space-xl); }
        .setup-header-icon { display: inline-flex; align-items: center; justify-content: center; width: 56px; height: 56px; background: var(--ds-primary-bg); border: 1px solid var(--ds-primary-border); border-radius: var(--ds-radius-lg); margin-bottom: var(--ds-space-md); }
        .setup-header-icon i { font-size: 24px; color: var(--ds-primary); }
        .setup-header h1 { font-size: 28px; font-weight: 700; color: var(--ds-text-primary); margin: 0 0 var(--ds-space-sm) 0; }
        .setup-header p { color: var(--ds-text-muted); font-size: 15px; margin: 0; }
        .setup-status { display: inline-flex; align-items: center; gap: var(--ds-space-xs); padding: 4px 12px; border-radius: var(--ds-radius-full); font-size: 12px; font-weight: 500; }
        .setup-status.enabled { background: var(--ds-success-bg); color: var(--ds-success); border: 1px solid var(--ds-success-border); }
        .setup-status.disabled { background: var(--ds-surface-2); color: var(--ds-text-muted); border: 1px solid var(--ds-border); }
        .setup-card { background: var(--ds-surface-1); border: 1px solid var(--ds-border); border-radius: var(--ds-radius-lg); margin-bottom: var(--ds-space-lg); overflow: hidden; }
        .setup-card-header { display: flex; align-items: center; justify-content: space-between; padding: var(--ds-space-lg); border-bottom: 1px solid var(--ds-border); background: var(--ds-surface-2); }
        .setup-card-title { display: flex; align-items: center; gap: var(--ds-space-sm); }
        .setup-card-title i { color: var(--ds-primary); font-size: 16px; }
        .setup-card-title h3 { font-size: 15px; font-weight: 600; color: var(--ds-text-primary); margin: 0; }
        .setup-card-body { padding: var(--ds-space-lg); }
        .setup-toggle-row { display: flex; align-items: center; justify-content: space-between; padding: var(--ds-space-md); background: var(--ds-surface-0); border: 1px solid var(--ds-border); border-radius: var(--ds-radius-md); margin-bottom: var(--ds-space-md); }
        .setup-toggle-row:last-child { margin-bottom: 0; }
        .setup-toggle-info h4 { margin: 0 0 4px 0; font-size: 14px; font-weight: 500; color: var(--ds-text-primary); }
        .setup-toggle-info p { margin: 0; font-size: 13px; color: var(--ds-text-muted); }
        .setup-form-group { margin-bottom: var(--ds-space-lg); }
        .setup-form-group:last-child { margin-bottom: 0; }
        .setup-form-label { display: block; font-size: 14px; font-weight: 500; color: var(--ds-text-primary); margin-bottom: var(--ds-space-xs); }
        .setup-form-label .required { color: var(--ds-danger, #ff5252); margin-left: 3px; }
        .setup-form-desc { font-size: 13px; color: var(--ds-text-muted); margin-bottom: var(--ds-space-sm); }
        .setup-form-input, .setup-form-select, .setup-form-textarea { width: 100%; padding: 10px 14px; background: var(--ds-surface-0); border: 1px solid var(--ds-border); border-radius: var(--ds-radius-md); color: var(--ds-text-primary); font-size: 14px; transition: all var(--ds-transition-fast); box-sizing: border-box; }
        .setup-form-input:focus, .setup-form-select:focus, .setup-form-textarea:focus { outline: none; border-color: var(--ds-primary); box-shadow: 0 0 0 3px var(--ds-primary-shadow); }
        .setup-form-textarea { resize: vertical; min-height: 100px; font-family: inherit; }
        .setup-form-select option { background: #1a1a2e; }
        .alert-info { display: flex; align-items: flex-start; gap: var(--ds-space-md); padding: var(--ds-space-md); background: var(--ds-info-bg); border: 1px solid var(--ds-info-border); border-radius: var(--ds-radius-md); color: var(--ds-info); margin-bottom: var(--ds-space-md); font-size: 13px; }
        .alert-info i { font-size: 16px; margin-top: 2px; flex-shrink: 0; }
        .alert-success { display: flex; align-items: flex-start; gap: var(--ds-space-md); padding: var(--ds-space-md); background: var(--ds-success-bg); border: 1px solid var(--ds-success-border); border-radius: var(--ds-radius-md); color: var(--ds-success); margin-bottom: var(--ds-space-md); font-size: 13px; }
        .btn-save { width: 100%; padding: 14px 24px; background: var(--ds-primary); color: white; border: none; border-radius: var(--ds-radius-md); font-size: 15px; font-weight: 600; cursor: pointer; transition: all var(--ds-transition-fast); }
        .btn-save:hover { background: var(--ds-primary-hover); transform: translateY(-1px); }
        .btn-save:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: var(--ds-space-lg); }
        @media (max-width: 640px) { .grid-2 { grid-template-columns: 1fr; } }
        .badge-required { display: inline-block; background: rgba(255,82,82,0.15); color: #ff5252; font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
        #toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 500; z-index: 9999; display: none; min-width: 200px; }
        #toast.success { background: #1a3a2a; border: 1px solid #06ffa5; color: #06ffa5; }
        #toast.error { background: #3a1a1a; border: 1px solid #ff5252; color: #ff5252; }
    </style>
</head>
<body class="setup-page">
    <div id="toast"></div>
    <nav class="setup-nav">
        <div style="display: flex; align-items: center; gap: var(--ds-space-lg);">
            <a href="/dashboard" class="back-button">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Dashboard</span>
            </a>
            <div class="setup-breadcrumb">
                <a href="/dashboard"><i class="fas fa-home"></i></a>
                <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
                <a href="/dashboard">Dashboard</a>
                <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
                <span class="setup-breadcrumb-current">Ticket Settings</span>
            </div>
        </div>
        <div class="setup-status disabled" id="featureStatus">
            <i class="fas fa-circle" style="font-size: 8px;"></i>
            <span>Disabled</span>
        </div>
    </nav>

    <main class="setup-container">
        <div class="setup-header">
            <div class="setup-header-icon"><i class="fas fa-ticket-alt"></i></div>
            <h1>Ticket System Settings</h1>
            <p>Configure your support ticket system. Settings here sync directly with the bot in Discord.</p>
        </div>

        <!-- Enable / Disable -->
        <div class="setup-card">
            <div class="setup-card-header">
                <div class="setup-card-title"><i class="fas fa-power-off"></i><h3>Enable Tickets</h3></div>
            </div>
            <div class="setup-card-body">
                <div class="setup-toggle-row">
                    <div class="setup-toggle-info">
                        <h4>Enable Ticket System</h4>
                        <p>Allow server members to create support tickets</p>
                    </div>
                    <label class="ds-toggle"><input type="checkbox" id="ticketsEnabled"><span class="ds-toggle-slider"></span></label>
                </div>
            </div>
        </div>

        <!-- Roles ‚Äî most critical for the bot -->
        <div class="setup-card">
            <div class="setup-card-header">
                <div class="setup-card-title">
                    <i class="fas fa-user-shield"></i>
                    <h3>Roles <span class="badge-required">Required for bot to work</span></h3>
                </div>
            </div>
            <div class="setup-card-body">
                <div class="alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>The <strong>Staff Role</strong> is pinged when a ticket is created and gets access to the ticket channel. Make sure the bot's role is positioned <strong>above</strong> the staff role in Discord's role hierarchy (Server Settings ‚Üí Roles).</div>
                </div>
                <div class="grid-2">
                    <div class="setup-form-group">
                        <label class="setup-form-label">Staff Role <span class="required">*</span></label>
                        <p class="setup-form-desc">Role pinged when a ticket opens ‚Äî gets access to all ticket channels</p>
                        <select class="setup-form-select" id="staffRoleId">
                            <option value="">Select a role...</option>
                        </select>
                    </div>
                    <div class="setup-form-group">
                        <label class="setup-form-label">Manage Role</label>
                        <p class="setup-form-desc">Optional higher-tier role (admins) with extra permissions in tickets</p>
                        <select class="setup-form-select" id="manageRoleId">
                            <option value="">None (optional)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Channels -->
        <div class="setup-card">
            <div class="setup-card-header">
                <div class="setup-card-title"><i class="fas fa-hashtag"></i><h3>Channels</h3></div>
            </div>
            <div class="setup-card-body">
                <div class="grid-2">
                    <div class="setup-form-group">
                        <label class="setup-form-label">Panel Channel <span class="required">*</span></label>
                        <p class="setup-form-desc">Channel where the <code>/ticket setup</code> panel is posted</p>
                        <select class="setup-form-select" id="panelChannelId">
                            <option value="">Select a channel...</option>
                        </select>
                    </div>
                    <div class="setup-form-group">
                        <label class="setup-form-label">Ticket Category</label>
                        <p class="setup-form-desc">Discord category where new ticket channels are created</p>
                        <select class="setup-form-select" id="categoryId">
                            <option value="">Select a category...</option>
                        </select>
                    </div>
                </div>
                <div class="setup-form-group">
                    <label class="setup-form-label">Log Channel</label>
                    <p class="setup-form-desc">Channel where ticket events (open/close/claim) are logged</p>
                    <select class="setup-form-select" id="logChannelId">
                        <option value="">None (optional)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Welcome Message -->
        <div class="setup-card">
            <div class="setup-card-header">
                <div class="setup-card-title"><i class="fas fa-comment-alt"></i><h3>Welcome Message</h3></div>
            </div>
            <div class="setup-card-body">
                <div class="setup-form-group">
                    <label class="setup-form-label">Message shown when a ticket is created</label>
                    <p class="setup-form-desc">Sent in the ticket channel. Leave blank for default.</p>
                    <textarea class="setup-form-textarea" id="ticketWelcomeMessage" placeholder="Thank you for creating a ticket! A support team member will be with you shortly."></textarea>
                </div>
            </div>
        </div>

        <!-- Advanced -->
        <div class="setup-card">
            <div class="setup-card-header">
                <div class="setup-card-title"><i class="fas fa-sliders-h"></i><h3>Advanced Settings</h3></div>
            </div>
            <div class="setup-card-body">
                <div class="grid-2">
                    <div class="setup-form-group">
                        <label class="setup-form-label">Max Open Tickets per User</label>
                        <p class="setup-form-desc">How many tickets a single user can have open at once</p>
                        <input type="number" class="setup-form-input" id="maxOpen" value="1" min="1" max="10">
                    </div>
                </div>
                <div class="setup-toggle-row">
                    <div class="setup-toggle-info">
                        <h4>Auto-Close Inactive Tickets</h4>
                        <p>Automatically close tickets with no activity after a set number of hours</p>
                    </div>
                    <label class="ds-toggle"><input type="checkbox" id="ticketAutoclose"><span class="ds-toggle-slider"></span></label>
                </div>
                <div class="setup-form-group" style="margin-top:12px;">
                    <label class="setup-form-label">Auto-Close After (hours)</label>
                    <input type="number" class="setup-form-input" id="ticketAutocloseHours" value="48" min="1" max="168">
                </div>
            </div>
        </div>

        <button class="btn-save" id="saveBtn" onclick="saveSettings()">
            <i class="fas fa-save"></i> Save Settings
        </button>

        <div style="margin-top: 16px; text-align: center; color: var(--ds-text-muted); font-size: 13px;">
            After saving, run <code>/ticket setup</code> in your Discord server for any channel changes to take effect.
        </div>
    </main>

    <script src="/js/secure-auth.js"></script>
    <script>
        const guildId = localStorage.getItem('selectedGuildId');
        if (!guildId) { alert('Please select a server first'); window.location.href = '/dashboard'; }

        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = type;
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 3500);
        }

        async function loadSettings() {
            try {
                const res = await fetch(`/api/settings/tickets?guildId=${guildId}`, { 
                    credentials: 'include',
                    headers: { 'X-Guild-Id': guildId }
                });
                
                const contentType = res.headers.get('content-type');
                if (!contentType?.includes('application/json')) {
                    console.error('Received non-JSON response from /api/settings/tickets');
                    return;
                }

                if (res.status === 503) {
                    setTimeout(loadSettings, 3000);
                    return;
                }
                
                const response = await res.json();
                const data = response.settings || response;
                const channels = response.channels || [];
                const roles = response.roles || [];

                // Populate role selects
                populateRoles(roles, 'staffRoleId', data.staffRoleId);
                populateRoles(roles, 'manageRoleId', data.manageRoleId, true);

                // Populate channel/category selects
                populateChannels(channels, 'panelChannelId', data.panelChannelId);
                populateChannels(channels, 'categoryId', data.categoryId, true);
                populateChannels(channels, 'logChannelId', data.logChannelId, true);

                // Set other field values
                document.getElementById('ticketsEnabled').checked = data.enabled || false;
                document.getElementById('ticketWelcomeMessage').value = data.welcomeMessage || '';
                document.getElementById('maxOpen').value = data.maxOpen || 1;
                document.getElementById('ticketAutoclose').checked = data.autoClose?.enabled || false;
                document.getElementById('ticketAutocloseHours').value = data.autoClose?.hours || 48;

                updateFeatureStatus(data.enabled);
            } catch (error) {
                console.error('Error loading ticket settings:', error);
                showToast('Failed to load settings: ' + error.message, 'error');
            }
        }

        function populateRoles(roles, selectId, currentValue, allowNone = false) {
            const select = document.getElementById(selectId);
            select.innerHTML = allowNone
                ? '<option value="">None (optional)</option>'
                : '<option value="">Select a role...</option>';
            roles.forEach(role => {
                const opt = document.createElement('option');
                opt.value = role.id;
                opt.textContent = '@' + role.name;
                if (role.color && role.color !== '#000000') {
                    opt.style.color = role.color;
                }
                if (role.id === currentValue) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function populateChannels(channels, selectId, currentValue, allowNone = false) {
            const select = document.getElementById(selectId);
            const isCategory = selectId === 'categoryId';
            select.innerHTML = allowNone
                ? `<option value="">None (optional)</option>`
                : `<option value="">Select a ${isCategory ? 'category' : 'channel'}...</option>`;
            
            // Filter: categoryId gets type 4, others get type 0
            const filtered = channels.filter(ch => isCategory ? ch.type === 4 : ch.type === 0);
            filtered.forEach(ch => {
                const opt = document.createElement('option');
                opt.value = ch.id;
                opt.textContent = isCategory ? 'üìÅ ' + ch.name : '# ' + ch.name;
                if (ch.id === currentValue) opt.selected = true;
                select.appendChild(opt);
            });
        }

        async function saveSettings() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                const settings = {
                    enabled: document.getElementById('ticketsEnabled').checked,
                    panelChannelId: document.getElementById('panelChannelId').value,
                    categoryId: document.getElementById('categoryId').value,
                    staffRoleId: document.getElementById('staffRoleId').value,
                    manageRoleId: document.getElementById('manageRoleId').value,
                    logChannelId: document.getElementById('logChannelId').value,
                    welcomeMessage: document.getElementById('ticketWelcomeMessage').value,
                    maxOpen: parseInt(document.getElementById('maxOpen').value) || 1,
                    autoClose: {
                        enabled: document.getElementById('ticketAutoclose').checked,
                        hours: parseInt(document.getElementById('ticketAutocloseHours').value) || 48
                    }
                };

                if (!settings.staffRoleId) {
                    showToast('‚ö†Ô∏è Staff Role is required for the ticket system to work', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-save"></i> Save Settings';
                    return;
                }
                
                const res = await SecureAuth.fetch(`/api/settings/tickets?guildId=${guildId}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Guild-Id': guildId
                    },
                    body: JSON.stringify(settings),
                    credentials: 'include'
                });
                
                if (res.ok) {
                    showToast('‚úÖ Settings saved! Run /ticket setup in Discord to apply panel changes.', 'success');
                    updateFeatureStatus(settings.enabled);
                } else {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || `HTTP ${res.status}`);
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('Failed to save: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Save Settings';
            }
        }

        function updateFeatureStatus(enabled) {
            const status = document.getElementById('featureStatus');
            if (enabled) {
                status.className = 'setup-status enabled';
                status.innerHTML = '<i class="fas fa-circle" style="font-size: 8px;"></i><span>Enabled</span>';
            } else {
                status.className = 'setup-status disabled';
                status.innerHTML = '<i class="fas fa-circle" style="font-size: 8px;"></i><span>Disabled</span>';
            }
        }

        document.getElementById('ticketsEnabled').addEventListener('change', (e) => updateFeatureStatus(e.target.checked));
        loadSettings();
    </script>
</body>
</html>
