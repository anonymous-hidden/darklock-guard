<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="">
    <title>Access Code Generator - DarkLock Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/design-system.css">
    <link id="dynamic-theme-stylesheet" rel="stylesheet" href="">
    <script src="/js/global-theme.js"></script>
    <script src="/js/theme-effects.js"></script>
    <style>
        .page { min-height: 100vh; background: var(--ds-surface-0); }

        .page-nav {
            position: sticky; top: 0; z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            padding: var(--ds-space-md) var(--ds-space-xl);
            background: var(--ds-surface-1);
            border-bottom: 1px solid var(--ds-border);
            backdrop-filter: blur(12px);
        }

        .breadcrumb {
            display: flex; align-items: center; gap: var(--ds-space-sm);
            font-size: 14px; color: var(--ds-text-muted);
        }
        .breadcrumb a { color: var(--ds-text-muted); text-decoration: none; }
        .breadcrumb a:hover { color: var(--ds-primary); }
        .breadcrumb-current { color: var(--ds-text-primary); font-weight: 500; }

        .page-container { max-width: 900px; margin: 0 auto; padding: var(--ds-space-xl) var(--ds-space-lg); }

        .page-header { margin-bottom: var(--ds-space-xl); }
        .page-header-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 56px; height: 56px;
            background: var(--ds-success-bg);
            border: 1px solid var(--ds-success-border);
            border-radius: var(--ds-radius-lg);
            margin-bottom: var(--ds-space-md);
        }
        .page-header-icon i { font-size: 24px; color: var(--ds-success); }
        .page-header h1 { font-size: 28px; font-weight: 700; color: var(--ds-text-primary); margin: 0 0 var(--ds-space-sm) 0; }
        .page-header p { color: var(--ds-text-muted); font-size: 15px; margin: 0; }

        /* Cards */
        .card {
            background: var(--ds-surface-1);
            border: 1px solid var(--ds-border);
            border-radius: var(--ds-radius-lg);
            margin-bottom: var(--ds-space-lg);
            overflow: hidden;
        }
        .card-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: var(--ds-space-lg);
            border-bottom: 1px solid var(--ds-border);
            background: var(--ds-surface-2);
        }
        .card-title { display: flex; align-items: center; gap: var(--ds-space-sm); }
        .card-title i { color: var(--ds-primary); font-size: 16px; }
        .card-title h3 { font-size: 15px; font-weight: 600; color: var(--ds-text-primary); margin: 0; }
        .card-body { padding: var(--ds-space-lg); }

        /* Permission cards */
        .perm-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--ds-space-md); margin-bottom: var(--ds-space-lg); }
        @media (max-width: 640px) { .perm-grid { grid-template-columns: 1fr; } }

        .perm-card {
            padding: var(--ds-space-lg);
            background: var(--ds-surface-0);
            border: 2px solid var(--ds-border);
            border-radius: var(--ds-radius-lg);
            cursor: pointer;
            text-align: center;
            transition: all var(--ds-transition-fast);
        }
        .perm-card:hover { border-color: var(--ds-primary-border); }
        .perm-card.active { border-color: var(--ds-primary); background: var(--ds-primary-bg); }

        .perm-card-icon {
            width: 48px; height: 48px;
            border-radius: var(--ds-radius-md);
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto var(--ds-space-sm);
            font-size: 20px;
        }
        .perm-card.viewer .perm-card-icon { background: var(--ds-info-bg); color: var(--ds-info); }
        .perm-card.moderator .perm-card-icon { background: var(--ds-warning-bg); color: var(--ds-warning); }
        .perm-card.admin .perm-card-icon { background: var(--ds-danger-bg); color: var(--ds-danger); }

        .perm-card h4 { margin: 0 0 4px 0; font-size: 14px; font-weight: 600; color: var(--ds-text-primary); }
        .perm-card p { margin: 0; font-size: 12px; color: var(--ds-text-muted); }

        /* Form */
        .form-group { margin-bottom: var(--ds-space-lg); }
        .form-label { display: block; font-size: 14px; font-weight: 500; color: var(--ds-text-primary); margin-bottom: var(--ds-space-xs); }
        .form-desc { font-size: 13px; color: var(--ds-text-muted); margin-bottom: var(--ds-space-sm); }
        .form-input, .form-select {
            width: 100%; padding: 10px 14px;
            background: var(--ds-surface-0);
            border: 1px solid var(--ds-border);
            border-radius: var(--ds-radius-md);
            color: var(--ds-text-primary);
            font-size: 14px;
            transition: all var(--ds-transition-fast);
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--ds-primary);
            box-shadow: 0 0 0 3px var(--ds-primary-bg);
        }
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 10px center;
            background-repeat: no-repeat;
            background-size: 20px;
            padding-right: 40px;
        }
        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--ds-space-md); }
        @media (max-width: 640px) { .form-row { grid-template-columns: 1fr; } }

        /* Code display */
        .code-display {
            display: none;
            margin-top: var(--ds-space-lg);
            padding: var(--ds-space-xl);
            background: var(--ds-success-bg);
            border: 2px solid var(--ds-success-border);
            border-radius: var(--ds-radius-lg);
            text-align: center;
        }
        .code-display.show { display: block; }
        .code-success { color: var(--ds-success); font-weight: 600; margin-bottom: var(--ds-space-md); font-size: 15px; }
        .code-value {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 4px;
            font-family: var(--ds-font-mono);
            padding: var(--ds-space-lg) var(--ds-space-xl);
            background: var(--ds-surface-1);
            border: 1px solid var(--ds-border);
            border-radius: var(--ds-radius-md);
            margin: var(--ds-space-md) 0;
            user-select: all;
            color: var(--ds-success);
        }
        .code-hint { color: var(--ds-text-muted); font-size: 13px; margin-bottom: var(--ds-space-md); }
        .code-actions { display: flex; gap: var(--ds-space-md); justify-content: center; }

        /* Codes list */
        .code-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--ds-space-md);
            background: var(--ds-surface-0);
            border: 1px solid var(--ds-border);
            border-radius: var(--ds-radius-md);
            margin-bottom: var(--ds-space-sm);
            transition: border-color var(--ds-transition-fast);
        }
        .code-item:hover { border-color: var(--ds-primary-border); }
        .code-item:last-child { margin-bottom: 0; }

        .code-info { flex: 1; }
        .code-info-main { display: flex; align-items: center; gap: var(--ds-space-sm); margin-bottom: 6px; }
        .code-text {
            font-family: var(--ds-font-mono);
            font-size: 14px;
            color: var(--ds-primary);
            font-weight: 500;
        }

        .code-meta {
            display: flex; flex-wrap: wrap;
            gap: var(--ds-space-md);
            font-size: 12px;
            color: var(--ds-text-muted);
        }
        .code-meta span { display: flex; align-items: center; gap: 4px; }
        .code-meta i { font-size: 10px; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: var(--ds-space-2xl);
            color: var(--ds-text-muted);
        }
        .empty-state i { font-size: 48px; margin-bottom: var(--ds-space-md); opacity: 0.4; }
        .empty-state h4 { margin: 0 0 var(--ds-space-xs) 0; color: var(--ds-text-primary); }
        .empty-state p { margin: 0; font-size: 14px; }
    </style>
</head>
<body class="page">
    <nav class="page-nav">
        <div class="breadcrumb">
            <a href="/dashboard"><i class="fas fa-home"></i></a>
            <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
            <a href="/dashboard">Dashboard</a>
            <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
            <span class="breadcrumb-current">Access Codes</span>
        </div>
    </nav>

    <main class="page-container">
        <div class="page-header">
            <div class="page-header-icon"><i class="fas fa-key"></i></div>
            <h1>Access Code Generator</h1>
            <p>Create temporary access codes for team members to access the dashboard</p>
        </div>

        <!-- Generate Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-plus-circle"></i><h3>Generate New Code</h3></div>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Permission Level</label>
                    <p class="form-desc">Choose what the user can do with this access code</p>
                    
                    <div class="perm-grid">
                        <div class="perm-card viewer active" data-level="viewer" onclick="selectPermission('viewer')">
                            <div class="perm-card-icon"><i class="fas fa-eye"></i></div>
                            <h4>Viewer</h4>
                            <p>Read-only access to dashboard</p>
                        </div>
                        <div class="perm-card moderator" data-level="moderator" onclick="selectPermission('moderator')">
                            <div class="perm-card-icon"><i class="fas fa-user-shield"></i></div>
                            <h4>Moderator</h4>
                            <p>Limited editing permissions</p>
                        </div>
                        <div class="perm-card admin" data-level="admin" onclick="selectPermission('admin')">
                            <div class="perm-card-icon"><i class="fas fa-crown"></i></div>
                            <h4>Admin</h4>
                            <p>Full dashboard access</p>
                        </div>
                    </div>
                    <input type="hidden" id="permissionLevel" value="viewer">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Code Type</label>
                        <select class="form-select" id="codeType">
                            <option value="single">Single Use</option>
                            <option value="multi">Multi Use (Max 10)</option>
                            <option value="unlimited">Unlimited Uses</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expiration</label>
                        <select class="form-select" id="codeExpiry">
                            <option value="1h">1 Hour</option>
                            <option value="24h">24 Hours</option>
                            <option value="7d" selected>7 Days</option>
                            <option value="30d">30 Days</option>
                            <option value="never">Never</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Note (Optional)</label>
                    <input type="text" class="form-input" id="codeNote" placeholder="e.g., For John - Moderator Team">
                </div>

                <button class="ds-btn ds-btn-success" style="width: 100%; padding: 14px;" id="generateBtn" onclick="generateCode()">
                    <i class="fas fa-key"></i> Generate Access Code
                </button>

                <div class="code-display" id="codeDisplay">
                    <div class="code-success"><i class="fas fa-check-circle"></i> Code Generated Successfully!</div>
                    <div class="code-value" id="codeValue">XXXX-XXXX-XXXX-XXXX</div>
                    <p class="code-hint">Share this code with your team member. They can use it at the login page.</p>
                    <div class="code-actions">
                        <button class="ds-btn ds-btn-primary" onclick="copyCode()"><i class="fas fa-copy"></i> Copy Code</button>
                        <button class="ds-btn ds-btn-secondary" onclick="shareLink()"><i class="fas fa-share-alt"></i> Copy Link</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Codes Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-list"></i><h3>Active Access Codes</h3></div>
            </div>
            <div class="card-body">
                <div id="codesList">
                    <div class="empty-state">
                        <i class="fas fa-key"></i>
                        <h4>No Active Codes</h4>
                        <p>Generate a code above to get started</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/secure-auth.js"></script>
    <script>
        const guildId = localStorage.getItem('selectedGuildId');
        let generatedCode = '';
        
        if (!guildId) {
            alert('Please select a server first');
            window.location.href = '/dashboard';
        }

        function selectPermission(level) {
            document.querySelectorAll('.perm-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-level="${level}"]`).classList.add('active');
            document.getElementById('permissionLevel').value = level;
        }

        async function generateCode() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

            try {
                const res = await SecureAuth.fetch('/api/access-codes/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        guildId: guildId,
                        type: document.getElementById('codeType').value,
                        permission: document.getElementById('permissionLevel').value,
                        expiry: document.getElementById('codeExpiry').value,
                        note: document.getElementById('codeNote').value
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    generatedCode = data.code;
                    document.getElementById('codeValue').textContent = data.code;
                    document.getElementById('codeDisplay').classList.add('show');
                    loadCodes();
                } else {
                    const error = await res.json();
                    alert('Failed to generate code: ' + (error.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to generate code:', e);
                alert('Failed to generate code. Please try again.');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-key"></i> Generate Access Code';
        }

        function copyCode() {
            navigator.clipboard.writeText(generatedCode);
            const btn = event.target.closest('button');
            const orig = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => btn.innerHTML = orig, 2000);
        }

        function shareLink() {
            const link = `${window.location.origin}/access?code=${generatedCode}`;
            navigator.clipboard.writeText(link);
            const btn = event.target.closest('button');
            const orig = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => btn.innerHTML = orig, 2000);
        }

        async function loadCodes() {
            try {
                const res = await fetch(`/api/guild/${guildId}/access-codes`, { credentials: 'include' });
                if (res.ok) {
                    const codes = await res.json();
                    renderCodes(codes);
                }
            } catch (e) { console.error('Failed to load codes:', e); }
        }

        function renderCodes(codes) {
            const list = document.getElementById('codesList');
            
            if (!codes || codes.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-key"></i>
                        <h4>No Active Codes</h4>
                        <p>Generate a code above to get started</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = codes.map(code => {
                const isExpired = code.expiresAt && new Date(code.expiresAt) < new Date();
                const isUsed = code.usesRemaining === 0;
                let status = 'active', statusClass = 'ds-badge-success';
                if (isExpired) { status = 'expired'; statusClass = 'ds-badge-danger'; }
                else if (isUsed) { status = 'used'; statusClass = 'ds-badge-warning'; }

                return `
                    <div class="code-item">
                        <div class="code-info">
                            <div class="code-info-main">
                                <span class="code-text">${code.code}</span>
                                <span class="ds-badge ${statusClass}">${status.toUpperCase()}</span>
                            </div>
                            <div class="code-meta">
                                <span><i class="fas fa-user-shield"></i> ${code.permission || 'viewer'}</span>
                                <span><i class="fas fa-clock"></i> ${code.expiresAt ? new Date(code.expiresAt).toLocaleDateString() : 'Never'}</span>
                                ${code.note ? `<span><i class="fas fa-sticky-note"></i> ${code.note}</span>` : ''}
                            </div>
                        </div>
                        <button class="ds-btn ds-btn-danger ds-btn-sm" onclick="revokeCode('${code.code}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function revokeCode(code) {
            if (!confirm('Are you sure you want to revoke this code?')) return;
            try {
                const res = await SecureAuth.fetch(`/api/access-codes/${code}/revoke`, {
                    method: 'POST',
                    credentials: 'include'
                });
                if (res.ok) loadCodes();
            } catch (e) { console.error('Failed to revoke code:', e); }
        }

        document.addEventListener('DOMContentLoaded', loadCodes);
    </script>
</body>
</html>
