<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goodbye Message Settings - DarkLock</title>
    <link rel="stylesheet" href="/css/dashboard-modern.css">
    <link id="dynamic-theme-stylesheet" rel="stylesheet" href="/css/themes/christmas.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="/js/global-theme.js"></script>
    <script src="/js/theme-effects.js"></script>
    <style>
        body { background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%); min-height: 100vh; margin: 0; font-family: 'Inter', sans-serif; color: #fff; }
        .setup-container { max-width: 900px; margin: 0 auto; padding: 30px; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; color: #00d4ff; text-decoration: none; margin-bottom: 20px; font-size: 14px; }
        .back-btn:hover { text-decoration: underline; }
        .setup-header { text-align: center; margin-bottom: 40px; }
        .setup-header h1 { font-size: 2.5em; margin: 0; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .setup-header p { color: #8892b0; margin-top: 10px; }
        .settings-card { background: rgba(18, 23, 39, 0.9); border-radius: 16px; padding: 24px; margin-bottom: 20px; border: 1px solid rgba(255, 107, 107, 0.2); }
        .settings-card h3 { margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; color: #ff6b6b; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: #ccd6f6; }
        .form-desc { font-size: 13px; color: #8892b0; margin-bottom: 8px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; background: #000000; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px; box-sizing: border-box; font-family: inherit; }
        .form-select option { background: #1a1a1a; color: #ffffff; }
        .form-textarea { min-height: 120px; resize: vertical; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #ff6b6b; background: #0a0a0a; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: rgba(10, 14, 39, 0.5); border-radius: 10px; margin-bottom: 12px; }
        .toggle-info h4 { margin: 0 0 4px 0; font-size: 15px; }
        .toggle-info p { margin: 0; font-size: 13px; color: #8892b0; }
        .toggle-switch { position: relative; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #2d3748; border-radius: 26px; transition: 0.3s; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch input:checked + .toggle-slider { background: linear-gradient(135deg, #ff6b6b, #ee5a6f); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
        .checkbox-group { display: flex; gap: 12px; flex-wrap: wrap; }
        .checkbox-option { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: rgba(10, 14, 39, 0.5); border-radius: 8px; cursor: pointer; }
        .checkbox-option input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .save-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border: none; border-radius: 10px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 20px; }
        .save-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .save-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .status-msg { text-align: center; padding: 12px; border-radius: 8px; margin-top: 16px; display: none; }
        .status-msg.success { display: block; background: rgba(6, 255, 165, 0.2); color: #06ffa5; }
        .status-msg.error { display: block; background: rgba(255, 82, 82, 0.2); color: #ff5252; }
        .variable-hint { display: inline-block; padding: 4px 8px; background: rgba(255, 107, 107, 0.15); border-radius: 4px; font-size: 12px; font-family: 'Courier New', monospace; color: #ff6b6b; margin-right: 6px; margin-bottom: 6px; }
    </style>
</head>
<body>
    <div class="setup-container">
        <a href="/dashboard" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
        
        <div class="setup-header">
            <h1><i class="fas fa-door-closed"></i> Goodbye Message Settings</h1>
            <p>Say farewell when members leave your server</p>
        </div>

        <div class="settings-card">
            <h3><i class="fas fa-toggle-on"></i> Goodbye Messages</h3>
            
            <div class="toggle-row">
                <div class="toggle-info">
                    <h4>Enable Goodbye Messages</h4>
                    <p>Send a message when members leave</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="goodbyeEnabled">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="form-group">
                <label class="form-label">Goodbye Channel</label>
                <p class="form-desc">Channel where goodbye messages will be sent</p>
                <select class="form-select" id="goodbyeChannel">
                    <option value="">Select a channel...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Goodbye Message</label>
                <p class="form-desc">Use variables to personalize the message:</p>
                <div style="margin-bottom: 10px;">
                    <span class="variable-hint">{user}</span>
                    <span class="variable-hint">{server}</span>
                    <span class="variable-hint">{memberCount}</span>
                </div>
                <textarea class="form-textarea" id="goodbyeMessage" placeholder="Goodbye {user}! We'll miss you in {server}. ðŸ‘‹"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Options</label>
                <div class="checkbox-group">
                    <label class="checkbox-option">
                        <input type="checkbox" id="goodbyeEmbedEnabled">
                        <span>Send as Embed</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Auto-Delete After (seconds)</label>
                <p class="form-desc">Automatically delete the goodbye message after this many seconds (0 = never)</p>
                <input type="number" class="form-input" id="goodbyeDeleteAfter" value="0" min="0" max="300">
            </div>
        </div>

        <button class="save-btn" id="saveBtn" onclick="saveSettings()">
            <i class="fas fa-save"></i> Save Settings
        </button>

        <div class="status-msg" id="statusMsg"></div>
    </div>

    <script src="/js/secure-auth.js"></script>
<script>
        let currentGuildId = null;
        let channels = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await SecureAuth.init();
            currentGuildId = localStorage.getItem('selectedGuildId');
            if (!currentGuildId) {
                showStatus('error', 'No server selected. Please return to dashboard and select a server.');
                return;
            }

            await loadChannels();
            await loadSettings();
        });

        async function apiFetch(path, opts = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'X-Guild-Id': currentGuildId,
                ...(opts.headers || {})
            };

            const response = await SecureAuth.fetch(path, {
                ...opts,
                headers,
                credentials: 'include'
            });

            if (response.status === 401 || response.status === 403) {
                window.location.href = '/login';
                throw new Error('Authentication required');
            }

            return response;
        }

        async function loadChannels() {
            try {
                const response = await apiFetch(`/api/guild/${currentGuildId}/channels`);
                const payload = await response.json();
                const data = payload.data || payload;
                const list = data.channels || (Array.isArray(data) ? data : []);
                channels = Array.isArray(list) ? list : [];

                const select = document.getElementById('goodbyeChannel');
                select.innerHTML = '<option value="">Select a channel...</option>';
                
                channels.filter(ch => ch.type === 0).forEach(ch => {
                    const option = document.createElement('option');
                    option.value = ch.id;
                    option.textContent = '#' + ch.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading channels:', error);
            }
        }

        async function loadSettings() {
            try {
                const response = await apiFetch(`/api/guild/${currentGuildId}/settings`);
                const data = await response.json();

                document.getElementById('goodbyeEnabled').checked = data.goodbye_enabled || false;
                document.getElementById('goodbyeChannel').value = data.goodbye_channel_id || '';
                document.getElementById('goodbyeMessage').value = data.goodbye_message || '';
                document.getElementById('goodbyeEmbedEnabled').checked = data.goodbye_embed_enabled || false;
                document.getElementById('goodbyeDeleteAfter').value = data.goodbye_delete_after || 0;
            } catch (error) {
                console.error('Error loading settings:', error);
                showStatus('error', 'Failed to load settings');
            }
        }

        async function saveSettings() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const settings = {
                    goodbye_enabled: document.getElementById('goodbyeEnabled').checked,
                    goodbye_channel_id: document.getElementById('goodbyeChannel').value,
                    goodbye_message: document.getElementById('goodbyeMessage').value,
                    goodbye_embed_enabled: document.getElementById('goodbyeEmbedEnabled').checked,
                    goodbye_delete_after: parseInt(document.getElementById('goodbyeDeleteAfter').value) || 0
                };

                const response = await apiFetch(`/api/guild/${currentGuildId}/settings`, {
                    method: 'POST',
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showStatus('success', 'Settings saved successfully!');
                } else {
                    const error = await response.json();
                    showStatus('error', error.error || 'Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showStatus('error', 'Failed to save settings: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Save Settings';
            }
        }

        function showStatus(type, message) {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.className = 'status-msg ' + type;
            statusMsg.textContent = message;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusMsg.className = 'status-msg';
                }, 3000);
            }
        }
    </script>
</body>
</html>
