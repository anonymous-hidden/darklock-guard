<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Tickets - DarkLock Dashboard</title>
    <link rel="stylesheet" href="/css/dashboard-pro.css">
    <link rel="stylesheet" href="/css/enhanced-styles.css">
    <link id="dynamic-theme-stylesheet" rel="stylesheet" href="/css/themes/christmas.css">
    <script src="/js/global-theme.js"></script>
    <script src="/js/theme-effects.js"></script>
    <style>
        .tickets-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        .tickets-list {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ticket-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .ticket-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .ticket-item.active {
            background: rgba(0, 150, 255, 0.2);
            border-left-color: #0096ff;
        }

        .ticket-item.status-open { border-left-color: #4caf50; }
        .ticket-item.status-closed { border-left-color: #666; }
        .ticket-item.status-pending { border-left-color: #ff9800; }

        .ticket-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .ticket-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .ticket-user {
            font-weight: 600;
            color: #fff;
        }

        .ticket-status {
            margin-left: auto;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-open { background: #4caf50; color: #fff; }
        .status-closed { background: #666; color: #fff; }
        .status-pending { background: #ff9800; color: #fff; }

        .ticket-subject {
            font-size: 14px;
            color: #fff;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .ticket-meta {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        .ticket-detail {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 25px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .ticket-detail-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .ticket-detail-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 10px;
        }

        .ticket-detail-info {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 14px;
            color: #fff;
            font-weight: 600;
        }

        .moderation-container {
            flex: 1;
            overflow-y: auto;
            display: grid;
            gap: 20px;
            padding-right: 10px;
        }

        .mod-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mod-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .staff-grid {
            display: grid;
            gap: 10px;
        }

        .staff-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .staff-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: #0096ff;
        }

        .staff-item.selected {
            background: rgba(0, 150, 255, 0.2);
            border-color: #0096ff;
        }

        .staff-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .staff-info {
            flex: 1;
        }

        .staff-name {
            font-weight: 600;
            color: #fff;
            font-size: 14px;
        }

        .staff-role {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .form-select, .form-input, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-family: inherit;
            font-size: 14px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-select {
            cursor: pointer;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .history-log {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #0096ff;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .history-user {
            font-weight: 600;
            color: #fff;
            font-size: 13px;
        }

        .history-time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        .history-action {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        .template-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .template-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: #0096ff;
        }

        .template-title {
            font-weight: 600;
            color: #fff;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .template-preview {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .collaborators-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .collaborator-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(0, 150, 255, 0.2);
            border: 1px solid #0096ff;
            border-radius: 20px;
            font-size: 12px;
            color: #fff;
        }

        .collaborator-remove {
            cursor: pointer;
            color: #ff4d4d;
            font-weight: bold;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0096ff, #0066cc);
            color: #fff;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0066cc, #004499);
            transform: translateY(-2px);
        }

        .btn-close {
            background: rgba(255, 77, 77, 0.2);
            color: #ff4d4d;
            border: 1px solid rgba(255, 77, 77, 0.3);
        }

        .btn-close:hover {
            background: rgba(255, 77, 77, 0.3);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: rgba(0, 150, 255, 0.2);
            border-color: #0096ff;
            color: #0096ff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.5);
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #0096ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h1>&#127915; Support Tickets</h1>
        <div class="header-actions">
            <button onclick="refreshTickets()" class="btn btn-primary">&#128260; Refresh</button>
            <a href="/dashboard" class="btn">&#8592; Back to Dashboard</a>
        </div>
    </div>

    <div class="tickets-container">
        <!-- Tickets List -->
        <div class="tickets-list">
            <div class="filter-bar">
                <button class="filter-btn active" data-status="all" onclick="filterTickets('all')">All</button>
                <button class="filter-btn" data-status="open" onclick="filterTickets('open')">Open</button>
                <button class="filter-btn" data-status="closed" onclick="filterTickets('closed')">Closed</button>
            </div>
            <div id="tickets-list-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading tickets...</div>
                </div>
            </div>
        </div>

        <!-- Ticket Detail -->
        <div class="ticket-detail" id="ticket-detail">
            <div class="empty-state">
                <div class="empty-icon">&#128236;</div>
                <h3>Select a ticket to view details</h3>
                <p>Click on a ticket from the list to see the conversation and reply.</p>
            </div>
        </div>
    </div>

    <script src="/js/secure-auth.js"></script>
<script>
        let currentTicketId = null;
        let currentFilter = 'all';
        let allTickets = [];

        // Apply saved theme to Tickets dashboard
        (async function applySavedThemeToTickets(){
            try {
                const guildId = localStorage.getItem('selectedGuildId');
                if (!guildId) return;
                const headers = getAuthHeaders();
                const res = await fetch(`/api/settings/theme?guildId=${encodeURIComponent(guildId)}`, { headers });
                const data = await res.json();
                const theme = data?.theme || null;
                if (theme) {
                    const root = document.documentElement;
                    if (theme.primaryColor) root.style.setProperty('--color-primary', theme.primaryColor);
                    if (theme.accentColor) root.style.setProperty('--color-accent', theme.accentColor);
                    if (theme.bgColor) root.style.setProperty('--bg-body', theme.bgColor);
                    if (theme.sidebarColor) root.style.setProperty('--bg-sidebar', theme.sidebarColor);
                    if (theme.fontSize) root.style.setProperty('--font-size', theme.fontSize);
                    if (theme.borderRadius) root.style.setProperty('--radius-md', theme.borderRadius === 'medium' ? '12px' : '8px');
                }
            } catch(e) {
                console.warn('Failed to apply saved theme to Tickets:', e);
            }
        })();

        // HttpOnly cookies are sent automatically by the browser
        // No need to manually get and send the token
        function getAuthHeaders() {
            const guildId = localStorage.getItem('selectedGuildId');
            const headers = {
                'Content-Type': 'application/json'
                // Don't send Authorization header - token is in HttpOnly cookie
            };
            if (guildId) {
                headers['X-Guild-Id'] = guildId;
            }
            return headers;
        }

        // Helper to make authenticated API calls with HttpOnly cookie support
        async function apiFetch(path, opts = {}) {
            const headers = Object.assign({}, opts.headers || {}, getAuthHeaders());
            
            try {
                const response = await SecureAuth.fetch(path, {
                    ...opts,
                    headers,
                    credentials: 'include' // Include HttpOnly cookies automatically
                });

                if (response.status === 401) {
                    console.error('[AUTH] 401 Unauthorized - session expired');
                    window.location.href = '/login';
                    throw new Error('Authentication required');
                }

                if (response.status === 403) {
                    console.error('[AUTH] 403 Forbidden - insufficient permissions');
                    window.location.href = '/login';
                    throw new Error('Insufficient permissions');
                }

                return response;
            } catch (error) {
                console.error('[API] Error:', error);
                throw error;
            }
        }

        async function fetchTicketsWithFallback() {
            const guildId = localStorage.getItem('selectedGuildId');

            // Newer endpoint - use apiFetch for automatic HttpOnly cookie handling
            let response = await apiFetch('/api/tickets/list?limit=100').catch(() => null);

            // Older endpoint with same shape
            if (response && response.status === 404) {
                response = await apiFetch('/api/tickets?limit=100').catch(() => null);
            }

            // Guild-scoped endpoint (older rebuild)
            if ((response && response.status === 404) || !response) {
                if (guildId) {
                    response = await apiFetch(`/api/guilds/${encodeURIComponent(guildId)}/tickets`).catch(() => null);
                }
            }

            return response;
        }

        async function loadTickets() {
            try {
                const response = await fetchTicketsWithFallback();
                if (!response) {
                    throw new Error('No response from tickets endpoint');
                }

                const data = await response.json().catch(() => null);

                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/login';
                    return;
                }

                if (response.status === 404) {
                    allTickets = [];
                    renderTickets([]);
                    return;
                }

                const tickets = Array.isArray(data?.tickets)
                    ? data.tickets
                    : Array.isArray(data?.data)
                        ? data.data
                        : Array.isArray(data)
                            ? data
                            : [];

                if (!response.ok || !Array.isArray(tickets)) {
                    throw new Error(data?.error || 'Invalid tickets response');
                }
                allTickets = tickets;
                renderTickets(tickets);
            } catch (error) {
                console.error('Error loading tickets:', error);
                document.getElementById('tickets-list-content').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ff4d4d;">
                        ? Failed to load tickets
                    </div>
                `;
            }
        }

        function renderTickets(tickets) {
            const container = document.getElementById('tickets-list-content');
            
            if (tickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">&#128234;</div>
                        <p>No tickets found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tickets.map(ticket => `
                <div class="ticket-item status-${ticket.status}" onclick="viewTicket('${ticket.id}')" data-ticket-id="${ticket.id}">
                    <div class="ticket-header">
                        <img src="${ticket.userAvatar || '/images/default-avatar.png'}" class="ticket-avatar" alt="Avatar">
                        <div class="ticket-user">${ticket.userName || ticket.user}</div>
                        <span class="ticket-status status-${ticket.status}">${ticket.status}</span>
                    </div>
                    <div class="ticket-subject">${ticket.subject || 'Support Ticket'}</div>
                    <div class="ticket-meta">
                        ${ticket.category || 'General'} ‚Ä¢ ${ticket.created || 'Recently'}
                    </div>
                </div>
            `).join('');
        }

        function filterTickets(status) {
            currentFilter = status;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === status);
            });

            // Filter tickets
            const filtered = status === 'all' 
                ? allTickets 
                : allTickets.filter(t => t.status === status);
            
            renderTickets(filtered);
        }

        async function viewTicket(ticketId) {
            currentTicketId = ticketId.replace('ticket-', '');
            
            // Highlight active ticket
            document.querySelectorAll('.ticket-item').forEach(item => {
                item.classList.toggle('active', item.dataset.ticketId === ticketId);
            });

            // Load ticket details
            try {
                const [detailsResponse, messagesResponse] = await Promise.all([
                    apiFetch(`/api/tickets/${currentTicketId}`),
                    apiFetch(`/api/tickets/${currentTicketId}/messages`)
                ]);

                const details = await detailsResponse.json();
                const messages = await messagesResponse.json();

                if (!detailsResponse.ok || Array.isArray(details)) {
                    throw new Error(details?.error || 'Invalid ticket details');
                }
                if (!messagesResponse.ok || !Array.isArray(messages)) {
                    throw new Error(messages?.error || 'Invalid ticket messages');
                }

                renderTicketDetail(details, messages);
            } catch (error) {
                console.error('Error loading ticket:', error);
                document.getElementById('ticket-detail').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">&#10060;</div>
                        <h3>Error Loading Ticket</h3>
                        <p>Failed to load ticket details. Please try again.</p>
                    </div>
                `;
            }
        }

        async function renderTicketDetail(details, messages) {
            const container = document.getElementById('ticket-detail');
            
            // Fetch staff members
            const staffMembers = await fetchStaffMembers();
            const ticketHistory = await fetchTicketHistory(currentTicketId);
            
            container.innerHTML = `
                <div class="ticket-detail-header">
                    <div class="ticket-detail-title">${details.subject}</div>
                    <div class="ticket-detail-info">
                        <div class="info-item">
                            <div class="info-label">Status</div>
                            <div class="info-value">${details.status}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Category</div>
                            <div class="info-value">${details.category}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Priority</div>
                            <div class="info-value">${details.priority}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Created</div>
                            <div class="info-value">${new Date(details.createdAt).toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>

                <div class="moderation-container">
                    <!-- Transfer/Assign Section -->
                    <div class="mod-section">
                        <div class="mod-section-title">&#128101; Transfer Ticket</div>
                        <div class="form-group">
                            <label class="form-label">Assign to Staff Member</label>
                            <select class="form-select" id="assign-staff" onchange="assignTicket()">
                                <option value="">-- Select Staff --</option>
                                ${staffMembers.map(staff => `
                                    <option value="${staff.id}" ${details.assignedTo === staff.id ? 'selected' : ''}>
                                        ${staff.name} (${staff.role})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="collaborators-list" id="collaborators-list">
                            ${details.collaborators ? details.collaborators.map(c => `
                                <div class="collaborator-badge">
                                    ${c.name}
                                    <span class="collaborator-remove" onclick="removeCollaborator('${c.id}')">&times;</span>
                                </div>
                            `).join('') : ''}
                        </div>
                        <button class="btn btn-primary" onclick="showAddCollaborator()" style="margin-top: 10px; width: 100%;">+ Add Collaborator</button>
                    </div>

                    <!-- Status & Priority -->
                    <div class="mod-section">
                        <div class="mod-section-title">&#9881;&#65039; Ticket Management</div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="ticket-status" onchange="updateStatus()">
                                <option value="open" ${details.status === 'open' ? 'selected' : ''}>Open</option>
                                <option value="in-progress" ${details.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                <option value="waiting" ${details.status === 'waiting' ? 'selected' : ''}>Waiting for User</option>
                                <option value="resolved" ${details.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                <option value="closed" ${details.status === 'closed' ? 'selected' : ''}>Closed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select class="form-select" id="ticket-priority" onchange="updatePriority()">
                                <option value="low" ${details.priority === 'low' ? 'selected' : ''}>üü¢ Low</option>
                                <option value="normal" ${details.priority === 'normal' ? 'selected' : ''}>üü° Normal</option>
                                <option value="high" ${details.priority === 'high' ? 'selected' : ''}>üü† High</option>
                                <option value="urgent" ${details.priority === 'urgent' ? 'selected' : ''}>üî¥ Urgent</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="claimTicket()" style="width: 100%;">&#128587; Claim This Ticket</button>
                    </div>

                    <!-- Internal Notes -->
                    <div class="mod-section">
                        <div class="mod-section-title">&#128221; Internal Notes</div>
                        <textarea class="form-textarea" id="internal-note" placeholder="Add internal staff notes (not visible to user)..."></textarea>
                        <button class="btn btn-primary" onclick="addInternalNote()" style="margin-top: 10px; width: 100%;">Save Note</button>
                        <div id="notes-list" style="margin-top: 15px;">
                            <!-- Notes will be loaded here -->
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="mod-section">
                        <div class="mod-section-title">&#9889; Quick Actions</div>
                        <div class="quick-actions">
                            <button class="btn btn-primary" onclick="quickAction('resolve')">&#9989; Resolve &amp; Close</button>
                            <button class="btn btn-primary" onclick="quickAction('escalate')">&#128680; Escalate to Admin</button>
                            <button class="btn btn-primary" onclick="quickAction('spam')">&#128683; Mark as Spam</button>
                            <button class="btn btn-primary" onclick="quickAction('waiting')">&#8987; Waiting for User</button>
                            <button class="btn btn-close" onclick="closeTicket()">&#128274; Close Ticket</button>
                            <button class="btn btn-primary" onclick="reopenTicket()">&#128275; Reopen Ticket</button>
                        </div>
                    </div>

                    <!-- Response Templates -->
                    <div class="mod-section">
                        <div class="mod-section-title">&#128196; Response Templates</div>
                        <div id="templates-list">
                            <div class="template-item" onclick="useTemplate('resolved')">
                                <div class="template-title">&#9989; Issue Resolved</div>
                                <div class="template-preview">We've resolved your issue. Please let us know if you need further assistance.</div>
                            </div>
                            <div class="template-item" onclick="useTemplate('info')">
                                <div class="template-title">‚ÑπÔ∏è Need More Info</div>
                                <div class="template-preview">Thanks for reaching out. Could you provide more details about...</div>
                            </div>
                            <div class="template-item" onclick="useTemplate('investigating')">
                                <div class="template-title">üîç Investigating</div>
                                <div class="template-preview">We're currently investigating this issue and will update you soon.</div>
                            </div>
                            <div class="template-item" onclick="useTemplate('escalated')">
                                <div class="template-title">‚¨ÜÔ∏è Escalated</div>
                                <div class="template-preview">Your ticket has been escalated to our senior team for priority handling.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Ticket History -->
                    <div class="mod-section">
                        <div class="mod-section-title">üìú Ticket History</div>
                        <div class="history-log" id="history-log">
                            ${ticketHistory.map(entry => `
                                <div class="history-item">
                                    <div class="history-header">
                                        <span class="history-user">${entry.user}</span>
                                        <span class="history-time">${formatMessageTime(entry.timestamp)}</span>
                                    </div>
                                    <div class="history-action">${entry.action}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            loadInternalNotes(currentTicketId);
        }

        async function fetchStaffMembers() {
            try {
                const response = await apiFetch('/api/server/staff');
                if (response && response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Error fetching staff:', error);
            }
            return [];
        }

        async function fetchTicketHistory(ticketId) {
            try {
                const response = await apiFetch(`/api/tickets/${ticketId}/history`);
                if (response && response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Error fetching history:', error);
            }
            return [];
        }

        async function assignTicket() {
            const staffId = document.getElementById('assign-staff').value;
            if (!staffId) return;

            try {
                const response = await apiFetch(`/api/tickets/${currentTicketId}/assign`, {
                    method: 'POST',
                    body: JSON.stringify({ staffId })
                });

                if (response && response.ok) {
                    alert('Ticket assigned successfully!');
                    await viewTicket(`ticket-${currentTicketId}`);
                } else {
                    alert('Failed to assign ticket.');
                }
            } catch (error) {
                console.error('Error assigning ticket:', error);
                alert('Error assigning ticket.');
            }
        }

        async function updateStatus() {
            const status = document.getElementById('ticket-status').value;

            try {
                const response = await apiFetch(`/api/tickets/${currentTicketId}/status`, {
                    method: 'POST',
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    alert('Status updated!');
                    await loadTickets();
                } else {
                    alert('Failed to update status.');
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        async function updatePriority() {
            const priority = document.getElementById('ticket-priority').value;

            try {
                const response = await apiFetch(`/api/tickets/${currentTicketId}/priority`, {
                    method: 'POST',
                    body: JSON.stringify({ priority })
                });

                if (response.ok) {
                    alert('Priority updated!');
                } else {
                    alert('Failed to update priority.');
                }
            } catch (error) {
                console.error('Error updating priority:', error);
            }
        }

        async function claimTicket() {
            try {
                const response = await apiFetch(`/api/tickets/${currentTicketId}/claim`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('Ticket claimed!');
                    await viewTicket(`ticket-${currentTicketId}`);
                } else {
                    alert('Failed to claim ticket.');
                }
            } catch (error) {
                console.error('Error claiming ticket:', error);
            }
        }

        async function addInternalNote() {
            const note = document.getElementById('internal-note').value.trim();
            if (!note) {
                alert('Please enter a note');
                return;
            }

            try {
                const response = await apiFetch(`/api/tickets/${currentTicketId}/notes`, {
                    method: 'POST',
                    body: JSON.stringify({ note })
                });

                if (response.ok) {
                    document.getElementById('internal-note').value = '';
                    await loadInternalNotes(currentTicketId);
                } else {
                    alert('Failed to add note.');
                }
            } catch (error) {
                console.error('Error adding note:', error);
            }
        }

        async function loadInternalNotes(ticketId) {
            try {
                const response = await apiFetch(`/api/tickets/${ticketId}/notes`);
                if (response && response.ok) {
                    const notes = await response.json();
                    const notesList = document.getElementById('notes-list');
                    if (notesList) {
                        notesList.innerHTML = notes.map(note => `
                            <div class="history-item" style="margin-top: 10px;">
                                <div class="history-header">
                                    <span class="history-user">${note.staffName}</span>
                                    <span class="history-time">${formatMessageTime(note.createdAt)}</span>
                                </div>
                                <div class="history-action">${escapeHtml(note.note)}</div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }

        async function quickAction(action) {
            const actions = {
                'resolve': { status: 'resolved', message: 'Ticket marked as resolved' },
                'escalate': { priority: 'urgent', message: 'Ticket escalated to admin' },
                'spam': { status: 'closed', message: 'Ticket marked as spam and closed' },
                'waiting': { status: 'waiting', message: 'Ticket marked as waiting for user' }
            };

            const actionData = actions[action];
            if (!actionData) return;

            try {
                const updates = [];
                if (actionData.status) {
                    updates.push(apiFetch(`/api/tickets/${currentTicketId}/status`, {
                        method: 'POST',
                        body: JSON.stringify({ status: actionData.status })
                    }));
                }
                if (actionData.priority) {
                    updates.push(apiFetch(`/api/tickets/${currentTicketId}/priority`, {
                        method: 'POST',
                        body: JSON.stringify({ priority: actionData.priority })
                    }));
                }

                await Promise.all(updates);
                alert(actionData.message);
                await loadTickets();
                await viewTicket(`ticket-${currentTicketId}`);
            } catch (error) {
                console.error('Error performing quick action:', error);
                alert('Failed to perform action.');
            }
        }

        async function reopenTicket() {
            try {
                const response = await apiFetch(`/api/tickets/${currentTicketId}/status`, {
                    method: 'POST',
                    body: JSON.stringify({ status: 'open' })
                });

                if (response.ok) {
                    alert('Ticket reopened!');
                    await loadTickets();
                    await viewTicket(`ticket-${currentTicketId}`);
                } else {
                    alert('Failed to reopen ticket.');
                }
            } catch (error) {
                console.error('Error reopening ticket:', error);
            }
        }

        function useTemplate(type) {
            alert(`Template "${type}" would be sent to user via Discord DM or ticket channel`);
        }

        function showAddCollaborator() {
            alert('Add Collaborator feature - would show staff list modal');
        }

        function removeCollaborator(id) {
            if (confirm('Remove this collaborator?')) {
                alert(`Collaborator ${id} removed`);
            }
        }

        async function closeTicket() {
            if (!confirm('Are you sure you want to close this ticket?')) {
                return;
            }

            try {
                const response = await apiFetch(`/api/tickets/${currentTicketId}/close`, {
                    method: 'POST'
                });

                if (response.ok) {
                    await loadTickets();
                    await viewTicket(`ticket-${currentTicketId}`);
                } else {
                    alert('Failed to close ticket. Please try again.');
                }
            } catch (error) {
                console.error('Error closing ticket:', error);
                alert('Error closing ticket. Please try again.');
            }
        }

        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function refreshTickets() {
            loadTickets();
            if (currentTicketId) {
                viewTicket(`ticket-${currentTicketId}`);
            }
        }

        // Check authentication before loading tickets
        async function initializeTicketPage() {
            try {
                // Try to fetch user info to verify authentication
                const response = await apiFetch('/api/me');
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }
                // User authenticated, load tickets
                loadTickets();
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login';
            }
        }

        // Initialize page on load
        (async function() {
            await SecureAuth.init();
            initializeTicketPage();
        })();

        // Auto-refresh every 30 seconds
        setInterval(refreshTickets, 30000);
    </script>
</body>
</html>
