<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="">
    <title>CyberDefense AI - Security Dashboard</title>
    <link rel="stylesheet" href="/css/cyber-theme.css">
    <link rel="stylesheet" href="/css/settings-panel.css">
    <link id="dynamic-theme-stylesheet" rel="stylesheet" href="">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="/js/global-theme.js"></script>
    <script src="/js/theme-effects.js"></script>
    <script src="/js/settings-panel.js"></script>
</head>
<body x-data="dashboard()" x-init="init()">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">üõ°Ô∏è</div>
                <div class="sidebar-title">CyberDefense AI</div>
            </div>
                <span x-text="serverName"></span>
                <img :src="serverIcon" alt="Server Icon" class="server-icon">
            </div>
            <div class="navbar-actions">
                <button class="btn-icon" @click="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="btn-icon">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" x-show="notifications > 0" x-text="notifications"></span>
                </button>
                <div class="user-menu">
                    <img :src="userAvatar" alt="User" class="user-avatar">
                </div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" :class="{'collapsed': sidebarCollapsed}">
            <div class="sidebar-header">
                <button @click="sidebarCollapsed = !sidebarCollapsed" class="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <a href="#dashboard" @click="setActiveTab('dashboard')" 
                       :class="{'active': activeTab === 'dashboard'}" class="nav-item">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Security Settings</div>
                    <a href="#anti-raid" @click="setActiveTab('anti-raid')" 
                       :class="{'active': activeTab === 'anti-raid'}" class="nav-item">
                        <i class="fas fa-users-slash"></i>
                        <span>Anti-Raid</span>
                    </a>
                    <a href="#anti-spam" @click="setActiveTab('anti-spam')" 
                       :class="{'active': activeTab === 'anti-spam'}" class="nav-item">
                        <i class="fas fa-comment-slash"></i>
                        <span>Anti-Spam</span>
                    </a>
                    <a href="#link-protection" @click="setActiveTab('link-protection')" 
                       :class="{'active': activeTab === 'link-protection'}" class="nav-item">
                        <i class="fas fa-link"></i>
                        <span>Link Protection</span>
                    </a>
                    <a href="#role-protection" @click="setActiveTab('role-protection')" 
                       :class="{'active': activeTab === 'role-protection'}" class="nav-item">
                        <i class="fas fa-user-shield"></i>
                        <span>Role Protection</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Moderation Tools</div>
                    <a href="#auto-mod" @click="setActiveTab('auto-mod')" 
                       :class="{'active': activeTab === 'auto-mod'}" class="nav-item">
                        <i class="fas fa-robot"></i>
                        <span>Auto-Mod</span>
                    </a>
                    <a href="#message-filters" @click="setActiveTab('message-filters')" 
                       :class="{'active': activeTab === 'message-filters'}" class="nav-item">
                        <i class="fas fa-filter"></i>
                        <span>Message Filters</span>
                    </a>
                    <a href="#user-verification" @click="setActiveTab('user-verification')" 
                       :class="{'active': activeTab === 'user-verification'}" class="nav-item">
                        <i class="fas fa-user-check"></i>
                        <span>User Verification</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <a href="#logging" @click="setActiveTab('logging')" 
                       :class="{'active': activeTab === 'logging'}" class="nav-item">
                        <i class="fas fa-file-alt"></i>
                        <span>Logging</span>
                    </a>
                    <a href="#backup" @click="setActiveTab('backup')" 
                       :class="{'active': activeTab === 'backup'}" class="nav-item">
                        <i class="fas fa-download"></i>
                        <span>Backup & Restore</span>
                    </a>
                    <a href="#permissions" @click="setActiveTab('permissions')" 
                       :class="{'active': activeTab === 'permissions'}" class="nav-item">
                        <i class="fas fa-key"></i>
                        <span>Bot Permissions</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Analytics</div>
                    <a href="#threat-maps" @click="setActiveTab('threat-maps')" 
                       :class="{'active': activeTab === 'threat-maps'}" class="nav-item">
                        <i class="fas fa-map"></i>
                        <span>Threat Maps</span>
                    </a>
                    <a href="#behavior-stats" @click="setActiveTab('behavior-stats')" 
                       :class="{'active': activeTab === 'behavior-stats'}" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Behavior Stats</span>
                    </a>
                    <a href="#admin-activity" @click="setActiveTab('admin-activity')" 
                       :class="{'active': activeTab === 'admin-activity'}" class="nav-item">
                        <i class="fas fa-user-cog"></i>
                        <span>Admin Activity</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Home -->
            <div x-show="activeTab === 'dashboard'" class="tab-content">
                <div class="dashboard-header">
                    <div class="header-left">
                        <h1>Security Overview</h1>
                    </div>
                    <div class="dashboard-clock">
                        <div class="clock-time" id="clock-time">--:--:--</div>
                        <div class="clock-date" id="clock-date">Loading...</div>
                        <div class="clock-timezone" id="clock-timezone"></div>
                    </div>
                    <div class="quick-actions" id="quick-actions-widget">
                        <button @click="lockdownServer()" 
                                :class="{'danger': !lockdownMode, 'success': lockdownMode}"
                                class="btn-action">
                            <i class="fas fa-lock"></i>
                            <span x-text="lockdownMode ? 'End Lockdown' : 'Lockdown Server'"></span>
                        </button>
                        <button @click="pauseInvites()" 
                                :class="{'warning': !invitesPaused, 'success': invitesPaused}"
                                class="btn-action">
                            <i class="fas fa-ban"></i>
                            <span x-text="invitesPaused ? 'Resume Invites' : 'Pause Invites'"></span>
                        </button>
                        <button @click="clearRaidFlags()" class="btn-action secondary">
                            <i class="fas fa-broom"></i>
                            <span>Clear Raid Flags</span>
                        </button>
                    </div>
                </div>

                <!-- Top Widgets -->
                <div class="widgets-grid">
                    <div class="widget security-score">
                        <div class="widget-header">
                            <h3>Security Score</h3>
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="security-score-display">
                            <div class="score-circle" :class="getScoreClass(securityScore)">
                                <span class="score-number" x-text="securityScore"></span>
                                <span class="score-label">/100</span>
                            </div>
                            <div class="score-details">
                                <div class="score-item">
                                    <span class="score-metric">Protection Level</span>
                                    <span class="score-value" x-text="getProtectionLevel(securityScore)"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="widget threat-alerts">
                        <div class="widget-header">
                            <h3>Current Threats</h3>
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="threat-list">
                            <template x-for="threat in currentThreats" :key="threat.id">
                                <div class="threat-item" :class="'threat-' + threat.level">
                                    <div class="threat-icon">
                                        <i :class="threat.icon"></i>
                                    </div>
                                    <div class="threat-info">
                                        <span class="threat-title" x-text="threat.title"></span>
                                        <span class="threat-count" x-text="threat.count + ' incidents'"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="widget recent-incidents">
                        <div class="widget-header">
                            <h3>Recent Incidents</h3>
                            <span class="time-label">Last 24 hours</span>
                        </div>
                        <div class="incidents-list">
                            <template x-for="incident in recentIncidents" :key="incident.id">
                                <div class="incident-item">
                                    <div class="incident-time" x-text="formatTime(incident.time)"></div>
                                    <div class="incident-description" x-text="incident.description"></div>
                                    <div class="incident-status" :class="incident.status">
                                        <i :class="incident.statusIcon"></i>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Charts Panel -->
                <div class="charts-panel">
                    <div class="chart-container">
                        <h3>Server Activity</h3>
                        <canvas id="activityChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Security Events</h3>
                        <canvas id="eventsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Setup Wizard -->
            <div x-show="activeTab === 'setup-wizard'" class="tab-content setup-wizard">
                <div class="wizard-container">
                    <div class="wizard-header">
                        <h1>üõ°Ô∏è Security Bot Setup Wizard</h1>
                        <p>Let's configure your Discord server security in a few simple steps</p>
                    </div>

                    <div class="wizard-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" :style="`width: ${(wizardStep / 6) * 100}%`"></div>
                        </div>
                        <div class="progress-steps">
                            <template x-for="i in 6">
                                <div class="progress-step" :class="{'active': i <= wizardStep, 'completed': i < wizardStep}">
                                    <span x-text="i"></span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Step 1: Server Type -->
                    <div x-show="wizardStep === 1" class="wizard-step">
                        <h2>Step 1: What type of server is this?</h2>
                        <p>Choose a preset that matches your community type for optimized security settings</p>
                        
                        <div class="server-types">
                            <template x-for="type in serverTypes" :key="type.id">
                                <div class="server-type-card" 
                                     :class="{'selected': selectedServerType === type.id}"
                                     @click="selectedServerType = type.id">
                                    <div class="card-icon">
                                        <i :class="type.icon"></i>
                                    </div>
                                    <h3 x-text="type.name"></h3>
                                    <p x-text="type.description"></p>
                                    <div class="type-features">
                                        <template x-for="feature in type.features">
                                            <span class="feature-tag" x-text="feature"></span>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Step 2: Member Filtering -->
                    <div x-show="wizardStep === 2" class="wizard-step">
                        <h2>Step 2: Member Filtering</h2>
                        <p>Configure how new members are handled when they join</p>
                        
                        <div class="settings-grid">
                            <div class="setting-item">
                                <label>Minimum Account Age</label>
                                <div class="slider-container">
                                    <input type="range" min="0" max="168" x-model="memberSettings.minAccountAge" class="slider">
                                    <span class="slider-value" x-text="memberSettings.minAccountAge + ' hours'"></span>
                                </div>
                            </div>

                            <div class="setting-item">
                                <label>Flag New Accounts</label>
                                <div class="toggle-container">
                                    <input type="checkbox" x-model="memberSettings.flagNewAccounts" class="toggle">
                                    <span class="toggle-description">Automatically flag accounts younger than minimum age</span>
                                </div>
                            </div>

                            <div class="setting-item">
                                <label>Require CAPTCHA</label>
                                <div class="toggle-container">
                                    <input type="checkbox" x-model="memberSettings.requireCaptcha" class="toggle">
                                    <span class="toggle-description">New members must complete verification</span>
                                </div>
                            </div>

                            <div class="setting-item">
                                <label>Auto-assign Newcomer Role</label>
                                <div class="toggle-container">
                                    <input type="checkbox" x-model="memberSettings.autoAssignRole" class="toggle">
                                    <span class="toggle-description">Give new members a temporary role</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Wizard Navigation -->
                    <div class="wizard-navigation">
                        <button @click="previousStep()" 
                                x-show="wizardStep > 1" 
                                class="btn-secondary">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button @click="nextStep()" 
                                x-show="wizardStep < 6" 
                                class="btn-primary">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                        <button @click="finishSetup()" 
                                x-show="wizardStep === 6" 
                                class="btn-success">
                            <i class="fas fa-check"></i> Complete Setup
                        </button>
                    </div>
                </div>
            </div>

            <!-- Other tabs would go here -->
        </main>
    </div>

    <script src="/js/secure-auth.js"></script>
<script src="/js/dashboard.js"></script>
<script src="/js/language-loader.js"></script>
<script>
    // Clock functionality
    function updateClock() {
        const now = new Date();
        const timeEl = document.getElementById('clock-time');
        const dateEl = document.getElementById('clock-date');
        const tzEl = document.getElementById('clock-timezone');

        if (timeEl) {
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            timeEl.textContent = `${hours}:${minutes}:${seconds}`;
        }

        if (dateEl) {
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            dateEl.textContent = now.toLocaleDateString(undefined, options);
        }

        if (tzEl) {
            const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            tzEl.textContent = tz;
        }
    }

    // Initialize clock
    updateClock();
    setInterval(updateClock, 1000);

    // Load and apply dashboard settings
    async function loadDashboardSettings() {
        try {
            const response = await fetch('/api/settings', { credentials: 'include' });
            if (response.ok) {
                const data = await response.json();
                const settings = data.settings || {};
                
                // Show/hide Quick Actions widget
                const quickActionsWidget = document.getElementById('quick-actions-widget');
                if (quickActionsWidget) {
                    const showQuickActions = settings.show_quick_actions !== 'false';
                    quickActionsWidget.style.display = showQuickActions ? 'flex' : 'none';
                }
            }
        } catch (error) {
            console.error('Error loading dashboard settings:', error);
        }
    }

    // Load settings on page load
    loadDashboardSettings();
</script>
</body>
</html>