<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darklock Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f0f14;
            --bg-secondary: #16161d;
            --bg-tertiary: #1c1c26;
            --bg-elevated: #22222e;
            --border-color: #2a2a3a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #6b6b7b;
            --accent-primary: #7c3aed;
            --accent-hover: #8b5cf6;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --owner-color: #fbbf24;
            --co-owner-color: #f97316;
            --admin-color: #ef4444;
            --mod-color: #3b82f6;
            --helper-color: #22c55e;
            --sidebar-width: 260px;
            --topbar-height: 60px;
            --drawer-width: 320px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-hover));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .sidebar-brand {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 16px 12px;
        }

        .nav-group {
            margin-bottom: 24px;
        }

        .nav-group-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            padding: 0 12px;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 2px;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-primary);
            color: white;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 14px;
        }

        .nav-item-text {
            font-size: 14px;
            font-weight: 500;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--error);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Main Content */
        .main-wrapper {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
        }

        /* Top Bar */
        .topbar {
            height: var(--topbar-height);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 90;
        }

        /* Target Switch */
        .target-switch {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 4px;
        }

        .target-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .target-btn:hover {
            color: var(--text-primary);
        }

        .target-btn.active {
            background: var(--accent-primary);
            color: white;
        }

        /* Environment Badge */
        .env-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .env-badge.prod { background: rgba(220, 38, 38, 0.2); color: #ef4444; }
        .env-badge.staging { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .env-badge.dev { background: rgba(34, 197, 94, 0.2); color: #22c55e; }

        /* Search */
        .search-container {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s ease;
        }

        .search-input:focus {
            border-color: var(--accent-primary);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }

        .search-results.visible {
            display: block;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .search-result-item:hover {
            background: var(--bg-tertiary);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        /* Topbar Actions */
        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .topbar-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
            transition: all 0.15s ease;
        }

        .topbar-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .topbar-btn .badge {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            background: var(--error);
            border-radius: 50%;
        }

        /* Profile Menu */
        .profile-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 12px 6px 6px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .profile-menu:hover {
            background: var(--bg-elevated);
        }

        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
        }

        .profile-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .profile-role {
            font-size: 11px;
            font-weight: 500;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .stat-icon.success { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .stat-icon.warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .stat-icon.error { background: rgba(239, 68, 68, 0.2); color: var(--error); }
        .stat-icon.info { background: rgba(59, 130, 246, 0.2); color: var(--info); }
        .stat-icon.purple { background: rgba(124, 58, 237, 0.2); color: var(--accent-primary); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-trend {
            font-size: 12px;
            color: var(--text-muted);
        }

        .stat-trend.up { color: var(--success); }
        .stat-trend.down { color: var(--error); }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        /* Health Score */
        .health-score {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }

        .health-ring {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .health-ring svg {
            transform: rotate(-90deg);
        }

        .health-ring-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 8;
        }

        .health-ring-progress {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .health-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: 700;
        }

        .health-details {
            flex: 1;
        }

        .health-status {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .health-status.healthy { color: var(--success); }
        .health-status.degraded { color: var(--warning); }
        .health-status.critical { color: var(--error); }

        .health-metric {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .health-metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            width: 80px;
        }

        .health-metric-bar {
            flex: 1;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .health-metric-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .health-metric-value {
            font-size: 13px;
            font-weight: 500;
            width: 50px;
            text-align: right;
        }

        /* Services Grid */
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .service-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .service-status.operational { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .service-status.degraded { background: var(--warning); box-shadow: 0 0 8px var(--warning); }
        .service-status.down { background: var(--error); box-shadow: 0 0 8px var(--error); }

        .service-info {
            flex: 1;
        }

        .service-name {
            font-size: 14px;
            font-weight: 500;
        }

        .service-latency {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Activity Feed */
        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-text {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .activity-text strong {
            font-weight: 600;
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .quick-action-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-primary);
        }

        .quick-action-btn.dangerous {
            border-color: var(--error);
        }

        .quick-action-btn.dangerous:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            background: var(--bg-tertiary);
        }

        td {
            font-size: 14px;
        }

        tr:hover td {
            background: var(--bg-tertiary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-elevated);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Status Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .badge-error { background: rgba(239, 68, 68, 0.2); color: var(--error); }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: var(--info); }

        /* Role colors */
        .role-owner { background: rgba(251, 191, 36, 0.2); color: var(--owner-color); }
        .role-co-owner { background: rgba(249, 115, 22, 0.2); color: var(--co-owner-color); }
        .role-admin { background: rgba(239, 68, 68, 0.2); color: var(--admin-color); }
        .role-moderator { background: rgba(59, 130, 246, 0.2); color: var(--mod-color); }
        .role-helper { background: rgba(34, 197, 94, 0.2); color: var(--helper-color); }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--accent-primary);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Toggle */
        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-tertiary);
            border-radius: 13px;
            transition: 0.2s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }

        .toggle input:checked + .toggle-slider {
            background: var(--accent-primary);
        }

        .toggle input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }

        .modal-overlay.visible .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .modal-close:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(80vh - 140px);
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Tab Panels */
        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Right Drawer */
        .right-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--drawer-width);
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 150;
            overflow-y: auto;
        }

        .right-drawer.open {
            transform: translateX(0);
        }

        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .drawer-title {
            font-size: 16px;
            font-weight: 600;
        }

        .drawer-body {
            padding: 20px;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 14px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-success { background: var(--success); color: white; }
        .toast-error { background: var(--error); color: white; }
        .toast-warning { background: var(--warning); color: white; }
        .toast-info { background: var(--info); color: white; }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-wrapper {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: flex !important;
            }
        }

        .mobile-menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        /* Skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-elevated) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 48px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Maintenance Alert */
        .maintenance-alert {
            display: none;
            background: var(--warning);
            color: #000;
            padding: 12px 24px;
            text-align: center;
            font-weight: 500;
        }

        .maintenance-alert.active {
            display: block;
        }

        /* Grid layouts for different pages */
        .two-column {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1200px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="/platform/static/js/console-branding.js"></script>
    <script src="/platform/static/js/debug-controller.js"></script>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">D</div>
                <span class="sidebar-brand">Darklock</span>
            </div>
            <nav class="sidebar-nav" id="sidebarNav">
                <!-- Navigation will be populated by JS -->
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-wrapper">
            <div class="maintenance-alert" id="maintenanceAlert">
                <i class="fas fa-exclamation-triangle"></i>
                Maintenance mode is active
            </div>

            <!-- Top Bar -->
            <header class="topbar">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="target-switch" id="targetSwitch">
                    <!-- Targets populated by JS -->
                </div>

                <div class="env-badge" id="envBadge">DEV</div>

                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search..." id="searchInput">
                    <div class="search-results" id="searchResults"></div>
                </div>

                <div class="topbar-actions">
                    <button class="topbar-btn" id="alertsBtn" title="Alerts">
                        <i class="fas fa-bell"></i>
                        <span class="badge" id="alertsBadge" style="display: none;"></span>
                    </button>
                    <button class="topbar-btn" id="statusDrawerBtn" title="Live Status">
                        <i class="fas fa-signal"></i>
                    </button>
                    <div class="profile-menu" id="profileMenu">
                        <div class="profile-avatar" id="profileAvatar" style="background: var(--accent-primary);">A</div>
                        <div class="profile-info">
                            <span class="profile-name" id="profileName">Loading...</span>
                            <span class="profile-role badge" id="profileRole">-</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="main-content" id="mainContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </main>
        </div>

        <!-- Right Drawer - Live Status -->
        <div class="right-drawer" id="statusDrawer">
            <div class="drawer-header">
                <span class="drawer-title">Live Status</span>
                <button class="modal-close" id="closeDrawerBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="drawer-body" id="drawerBody">
                <!-- Status content -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="confirmTitle">Confirm Action</span>
                <button class="modal-close" onclick="closeModal('confirmModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure you want to proceed?</p>
                <div id="confirmInputContainer" style="margin-top: 16px; display: none;">
                    <label class="form-label">Type <strong id="confirmWord"></strong> to confirm:</label>
                    <input type="text" class="form-input" id="confirmInput">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        const state = {
            user: null,
            currentTab: 'overview',
            currentTarget: 'site',
            tabs: [],
            targets: [],
            loading: false,
            isInitializing: false
        };

        // API helper
        async function api(endpoint, options = {}) {
            try {
                const response = await fetch(`/api${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    credentials: 'include'
                });

                if (response.status === 401) {
                    console.warn('[Dashboard] 401 Unauthorized - redirecting to signin');
                    window.location.href = '/signin';
                    return null;
                }

                if (response.status === 404) {
                    return { success: false, notFound: true };
                }

                if (!response.ok) {
                    console.error('[Dashboard] API error:', response.status, response.statusText);
                    return { success: false, error: `Server error: ${response.status}` };
                }

                const data = await response.json();
                return data;
            } catch (err) {
                console.error('[Dashboard] API Error:', err);
                // Don't show toast for initial load to avoid spam
                if (endpoint !== '/v3/shell') {
                    showToast('Network error', 'error');
                }
                return { success: false, error: err.message };
            }
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // Modal helpers
        function openModal(id) {
            document.getElementById(id).classList.add('visible');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('visible');
        }

        function confirmAction(title, message, confirmWord, onConfirm) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            const inputContainer = document.getElementById('confirmInputContainer');
            const input = document.getElementById('confirmInput');
            
            if (confirmWord) {
                inputContainer.style.display = 'block';
                document.getElementById('confirmWord').textContent = confirmWord;
                input.value = '';
            } else {
                inputContainer.style.display = 'none';
            }

            document.getElementById('confirmBtn').onclick = () => {
                if (confirmWord && input.value !== confirmWord) {
                    showToast('Confirmation text does not match', 'error');
                    return;
                }
                closeModal('confirmModal');
                onConfirm();
            };

            openModal('confirmModal');
        }

        // Custom modal helper for complex modals
        function showCustomModal(title, content, buttons) {
            // Remove existing custom modal if present
            const existingModal = document.getElementById('customModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'customModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <span class="modal-title">${title}</span>
                        <button class="modal-close" onclick="closeModal('customModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                    <div class="modal-footer" id="customModalFooter">
                        ${buttons.map((btn, i) => `
                            <button class="btn ${btn.class}" id="customModalBtn${i}">${btn.text}</button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Attach button handlers
            buttons.forEach((btn, i) => {
                document.getElementById(`customModalBtn${i}`).onclick = btn.action;
            });
            
            // Close on overlay click
            modal.onclick = (e) => {
                if (e.target === modal) closeModal('customModal');
            };
            
            // Show modal
            requestAnimationFrame(() => {
                modal.classList.add('visible');
            });
        }

        // Initialize dashboard
        async function init() {
            if (state.isInitializing) {
                console.warn('[Dashboard] Already initializing, skipping duplicate call');
                return;
            }
            
            state.isInitializing = true;
            console.log('[Dashboard] Starting initialization...');
            
            const shellData = await api('/v3/shell');
            
            if (!shellData || !shellData.success) {
                console.error('[Dashboard] Shell data failed, redirecting to signin');
                state.isInitializing = false;
                window.location.href = '/signin';
                return;
            }

            console.log('[Dashboard] Shell data loaded successfully');

            state.user = shellData.user;
            state.tabs = shellData.navigation.tabs;
            state.targets = shellData.navigation.targets;

            // Update UI
            updateProfile();
            buildNavigation();
            buildTargetSwitch();
            updateEnvBadge(shellData.environment);
            updateAlertsBadge(shellData.alerts.unread);

            // Load initial tab
            await loadTab('overview');

            // Set up event listeners
            setupEventListeners();

            // Start live updates
            startLiveUpdates();
            
            state.isInitializing = false;
            console.log('[Dashboard] Initialization complete');
        }

        function updateProfile() {
            document.getElementById('profileAvatar').textContent = state.user.avatar;
            document.getElementById('profileAvatar').style.background = state.user.roleColor;
            document.getElementById('profileName').textContent = state.user.displayName;
            document.getElementById('profileRole').textContent = state.user.role;
            document.getElementById('profileRole').className = `profile-role badge role-${state.user.role}`;
        }

        function buildNavigation() {
            const nav = document.getElementById('sidebarNav');
            const groups = {};

            // Group tabs by category
            state.tabs.forEach(tab => {
                const group = tab.group || 'General';
                if (!groups[group]) groups[group] = [];
                groups[group].push(tab);
            });

            nav.innerHTML = Object.entries(groups).map(([groupName, tabs]) => `
                <div class="nav-group">
                    <div class="nav-group-title">${groupName}</div>
                    ${tabs.map(tab => `
                        <a class="nav-item ${tab.id === state.currentTab ? 'active' : ''}" data-tab="${tab.id}">
                            <i class="fas fa-${tab.icon}"></i>
                            <span class="nav-item-text">${tab.name}</span>
                            ${tab.badge ? `<span class="nav-badge">${tab.badge}</span>` : ''}
                        </a>
                    `).join('')}
                </div>
            `).join('');

            // Add click handlers
            nav.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => loadTab(item.dataset.tab));
            });
        }

        function buildTargetSwitch() {
            const container = document.getElementById('targetSwitch');
            container.innerHTML = state.targets.map(target => `
                <button class="target-btn ${target.active ? 'active' : ''}" data-target="${target.id}">
                    ${target.name}
                </button>
            `).join('');

            container.querySelectorAll('.target-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTarget(btn.dataset.target));
            });
        }

        function updateEnvBadge(env) {
            const badge = document.getElementById('envBadge');
            badge.textContent = env.badge.toUpperCase();
            badge.className = `env-badge ${env.badge}`;
        }

        function updateAlertsBadge(count) {
            const badge = document.getElementById('alertsBadge');
            if (count > 0) {
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        function switchTarget(targetId) {
            state.currentTarget = targetId;
            document.querySelectorAll('.target-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.target === targetId);
            });
            loadTab(state.currentTab);
        }

        // Tab loading
        async function loadTab(tabId) {
            if (state.loading) {
                console.warn('[Dashboard] Already loading a tab, skipping request for:', tabId);
                return;
            }
            
            state.loading = true;
            state.currentTab = tabId;
            console.log('[Dashboard] Loading tab:', tabId);

            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.tab === tabId);
            });

            // Show loading
            const content = document.getElementById('mainContent');
            content.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

            // Load tab content
            try {
                switch (tabId) {
                    case 'overview':
                        await loadOverview();
                        break;
                    case 'status':
                        await loadStatus();
                        break;
                    case 'maintenance':
                        await loadMaintenance();
                        break;
                    case 'users':
                        await loadUsers();
                        break;
                    case 'permissions':
                        await loadPermissions();
                        break;
                    case 'bot':
                        await loadBot();
                        break;
                    case 'platform':
                        await loadPlatform();
                        break;
                    case 'logs':
                        await loadLogs();
                        break;
                    case 'audit':
                        await loadAudit();
                        break;
                    case 'security':
                        await loadSecurity();
                        break;
                    case 'integrations':
                        await loadIntegrations();
                        break;
                    case 'settings':
                        await loadSettings();
                        break;
                    default:
                        content.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-folder-open"></i></div><div class="empty-state-title">Page not found</div></div>';
                }
            } catch (err) {
                console.error('[Dashboard] Tab load error:', err);
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="empty-state-title">Error loading page</div><div class="empty-state-text">' + err.message + '</div></div>';
            } finally {
                state.loading = false;
            }
        }

        // ============================================================================
        // OVERVIEW TAB
        // ============================================================================
        async function loadOverview() {
            const data = await api('/v3/overview');
            if (!data || !data.success) return show404();

            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Dashboard Overview</h1>
                    <p class="page-subtitle">Welcome back, ${state.user.displayName}</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Health Score</span>
                            <div class="stat-icon ${data.health.status === 'healthy' ? 'success' : data.health.status === 'degraded' ? 'warning' : 'error'}">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.health.score}%</div>
                        <div class="stat-trend">${data.health.status}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Bot Status</span>
                            <div class="stat-icon ${data.bot.status === 'online' ? 'success' : 'warning'}">
                                <i class="fab fa-discord"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.bot.guilds}</div>
                        <div class="stat-trend">${data.bot.ping}ms ping</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Uptime</span>
                            <div class="stat-icon purple">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.health.uptimeFormatted}</div>
                        <div class="stat-trend">System uptime</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Open Incidents</span>
                            <div class="stat-icon ${data.incidents.length > 0 ? 'error' : 'success'}">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.incidents.length}</div>
                        <div class="stat-trend">${data.incidents.length > 0 ? 'Needs attention' : 'All clear'}</div>
                    </div>
                </div>

                <div class="two-column">
                    <div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">System Health</span>
                            </div>
                            <div class="health-score">
                                <div class="health-ring">
                                    <svg width="100" height="100">
                                        <circle class="health-ring-bg" cx="50" cy="50" r="42"></circle>
                                        <circle class="health-ring-progress" cx="50" cy="50" r="42" 
                                            stroke="${data.health.status === 'healthy' ? 'var(--success)' : data.health.status === 'degraded' ? 'var(--warning)' : 'var(--error)'}"
                                            stroke-dasharray="${2 * Math.PI * 42}"
                                            stroke-dashoffset="${2 * Math.PI * 42 * (1 - data.health.score / 100)}">
                                        </circle>
                                    </svg>
                                    <span class="health-ring-text">${data.health.score}</span>
                                </div>
                                <div class="health-details">
                                    <div class="health-status ${data.health.status}">${data.health.status.charAt(0).toUpperCase() + data.health.status.slice(1)}</div>
                                    <div class="health-metric">
                                        <span class="health-metric-label">Memory</span>
                                        <div class="health-metric-bar">
                                            <div class="health-metric-fill" style="width: ${data.health.memory.percent}%; background: ${data.health.memory.percent > 90 ? 'var(--error)' : data.health.memory.percent > 70 ? 'var(--warning)' : 'var(--success)'}"></div>
                                        </div>
                                        <span class="health-metric-value">${data.health.memory.percent}%</span>
                                    </div>
                                    <div class="health-metric">
                                        <span class="health-metric-label">CPU</span>
                                        <div class="health-metric-bar">
                                            <div class="health-metric-fill" style="width: ${data.health.cpu.percent}%; background: ${data.health.cpu.percent > 80 ? 'var(--error)' : data.health.cpu.percent > 60 ? 'var(--warning)' : 'var(--success)'}"></div>
                                        </div>
                                        <span class="health-metric-value">${data.health.cpu.percent}%</span>
                                    </div>
                                    <div class="health-metric">
                                        <span class="health-metric-label">Database</span>
                                        <div class="health-metric-bar">
                                            <div class="health-metric-fill" style="width: ${Math.min(100, data.health.database.latency)}%; background: ${data.health.database.latency > 100 ? 'var(--error)' : data.health.database.latency > 50 ? 'var(--warning)' : 'var(--success)'}"></div>
                                        </div>
                                        <span class="health-metric-value">${data.health.database.latency}ms</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Services</span>
                            </div>
                            <div class="card-body">
                                <div class="services-grid">
                                    ${(data.services || []).map(s => `
                                        <div class="service-card">
                                            <div class="service-status ${s.status}"></div>
                                            <div class="service-info">
                                                <div class="service-name">${s.service_name}</div>
                                                <div class="service-latency">${s.latency_ms || 0}ms</div>
                                            </div>
                                        </div>
                                    `).join('') || '<p style="color: var(--text-muted)">No services configured</p>'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Quick Actions</span>
                            </div>
                            <div class="card-body">
                                <div class="quick-actions">
                                    ${data.quickActions.map(a => `
                                        <button class="quick-action-btn ${a.dangerous ? 'dangerous' : ''}" onclick="quickAction('${a.id}')">
                                            <i class="fas fa-${a.icon}"></i>
                                            ${a.name}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Recent Activity</span>
                            </div>
                            <div class="card-body activity-feed">
                                ${data.recentActions.map(a => `
                                    <div class="activity-item">
                                        <div class="activity-icon" style="background: rgba(124, 58, 237, 0.2); color: var(--accent-primary);">
                                            <i class="fas fa-bolt"></i>
                                        </div>
                                        <div class="activity-content">
                                            <div class="activity-text"><strong>${a.admin_email || 'System'}</strong> ${a.action.toLowerCase().replace(/_/g, ' ')}</div>
                                            <div class="activity-time">${new Date(a.created_at).toLocaleString()}</div>
                                        </div>
                                    </div>
                                `).join('') || '<p style="color: var(--text-muted); padding: 20px; text-align: center;">No recent activity</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // STATUS TAB
        // ============================================================================
        async function loadStatus() {
            const data = await api('/v3/status');
            if (!data || !data.success) return show404();

            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Status & Monitoring</h1>
                    <p class="page-subtitle">Real-time system health and performance</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Gateway Status</span>
                            <div class="stat-icon ${data.gateway.status === 'connected' ? 'success' : 'error'}">
                                <i class="fas fa-plug"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.gateway.status}</div>
                        <div class="stat-trend">${data.gateway.ping}ms latency</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Active Shards</span>
                            <div class="stat-icon info">
                                <i class="fas fa-server"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.shards.length || 1}</div>
                        <div class="stat-trend">${data.shards.filter(s => s.status === 'ready').length} ready</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Process Uptime</span>
                            <div class="stat-icon purple">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.uptime.formatted}</div>
                        <div class="stat-trend">Since last restart</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Services Status</span>
                    </div>
                    <div class="card-body">
                        <div class="services-grid">
                            ${data.services.map(s => `
                                <div class="service-card">
                                    <div class="service-status ${s.status}"></div>
                                    <div class="service-info">
                                        <div class="service-name">${s.service_name}</div>
                                        <div class="service-latency">${s.latency_ms}ms  ${s.status}</div>
                                    </div>
                                </div>
                            `).join('') || '<p style="color: var(--text-muted)">No services registered</p>'}
                        </div>
                    </div>
                </div>

                ${data.shards.length > 0 ? `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Discord Shards</span>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Shard ID</th>
                                        <th>Status</th>
                                        <th>Ping</th>
                                        <th>Guilds</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.shards.map(s => `
                                        <tr>
                                            <td>#${s.id}</td>
                                            <td><span class="badge ${s.status === 'ready' ? 'badge-success' : 'badge-warning'}">${s.status}</span></td>
                                            <td>${s.ping}ms</td>
                                            <td>${s.guilds}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }

        // ============================================================================
        // MAINTENANCE TAB
        // ============================================================================
        async function loadMaintenance() {
            const data = await api('/v3/maintenance');
            if (!data || !data.success) return show404();

            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Maintenance Mode</h1>
                    <p class="page-subtitle">Control service availability per scope</p>
                </div>

                <div class="stats-grid">
                    ${data.scopes.map(s => `
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">${formatScopeName(s.scope)}</span>
                                <div class="stat-icon ${s.enabled ? 'warning' : 'success'}">
                                    <i class="fas fa-${s.enabled ? 'wrench' : 'check-circle'}"></i>
                                </div>
                            </div>
                            <div class="stat-value">${s.enabled ? 'Active' : 'Off'}</div>
                            <div class="stat-trend">${s.enabled && s.scheduled_end ? 'Ends ' + new Date(s.scheduled_end).toLocaleString() : s.enabled ? 'No end time' : 'Running normally'}</div>
                        </div>
                    `).join('')}
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Maintenance Scopes</span>
                    </div>
                    <div class="card-body">
                        ${data.scopes.map(s => `
                            <div class="maintenance-scope-card" style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid ${s.enabled ? 'var(--warning)' : 'var(--border-color)'};">
                                <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px; display: flex; align-items: center; gap: 12px;">
                                            ${formatScopeName(s.scope)}
                                            <span class="badge ${s.enabled ? 'badge-warning' : 'badge-success'}">${s.enabled ? 'Maintenance Active' : 'Normal Operation'}</span>
                                        </div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">
                                            ${s.title || 'No title set'}  ${s.subtitle || 'No subtitle'}
                                        </div>
                                    </div>
                                    <label class="toggle">
                                        <input type="checkbox" ${s.enabled ? 'checked' : ''} onchange="quickToggleMaintenance('${s.scope}', this.checked, this)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Current Message</div>
                                    <div style="font-size: 14px;">${s.message || '<em style="color: var(--text-muted)">No message configured</em>'}</div>
                                </div>
                                
                                ${s.enabled && s.scheduled_end ? `
                                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 16px;">
                                        <div>
                                            <div style="font-size: 12px; color: var(--text-muted);">Scheduled End</div>
                                            <div style="font-weight: 500;">${new Date(s.scheduled_end).toLocaleString()}</div>
                                        </div>
                                        <div style="font-size: 24px; font-weight: 700; color: var(--warning);" id="countdown-${s.scope}">
                                            --:--:--
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div style="display: flex; gap: 12px;">
                                    <button class="btn btn-secondary btn-sm" onclick="openMaintenanceConfig('${s.scope}')">
                                        <i class="fas fa-cog"></i> Configure
                                    </button>
                                    ${s.enabled ? `
                                        <button class="btn btn-secondary btn-sm" onclick="extendMaintenance('${s.scope}')">
                                            <i class="fas fa-clock"></i> Extend
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="addStatusUpdate('${s.scope}')">
                                            <i class="fas fa-comment"></i> Add Update
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Maintenance History</span>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Scope</th>
                                        <th>Action</th>
                                        <th>Admin</th>
                                        <th>Reason</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.history.map(h => `
                                        <tr>
                                            <td>${formatScopeName(h.scope)}</td>
                                            <td><span class="badge ${h.action === 'ENABLED' ? 'badge-warning' : h.action === 'DISABLED' ? 'badge-success' : 'badge-info'}">${h.action}</span></td>
                                            <td>${h.admin_email || 'System'}</td>
                                            <td style="color: var(--text-muted);">${h.reason || '-'}</td>
                                            <td style="font-size: 12px; color: var(--text-muted);">${new Date(h.created_at).toLocaleString()}</td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No history</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Start countdowns for active maintenance
            data.scopes.filter(s => s.enabled && s.scheduled_end).forEach(s => {
                startMaintenanceCountdown(s.scope, s.scheduled_end);
            });
        }

        function formatScopeName(scope) {
            const names = {
                'darklock_site': 'Darklock Platform',
                'platform': 'Platform/Dashboard',
                'bot_dashboard': 'Bot Dashboard',
                'api': 'API Services',
                'discord_bot': 'Discord Bot',
                'workers': 'Background Workers'
            };
            return names[scope] || scope.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function startMaintenanceCountdown(scope, endTime) {
            const el = document.getElementById(`countdown-${scope}`);
            if (!el) return;
            
            const end = new Date(endTime).getTime();
            
            const update = () => {
                const now = Date.now();
                const diff = end - now;
                
                if (diff <= 0) {
                    el.textContent = 'Ended';
                    return;
                }
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                el.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };
            
            update();
            setInterval(update, 1000);
        }

        async function quickToggleMaintenance(scope, enabled, toggleElement) {
            // If enabling, show config modal first instead of just toggling
            if (enabled) {
                // Revert toggle visually until config is saved
                if (toggleElement) {
                    toggleElement.checked = false;
                }
                // Open config modal
                openMaintenanceConfigForEnable(scope);
                return;
            }
            
            // If disabling, just turn it off immediately
            const result = await api(`/v3/maintenance/${scope}`, {
                method: 'PUT',
                body: JSON.stringify({ enabled: false })
            });

            if (result?.success) {
                showToast(`Maintenance disabled for ${formatScopeName(scope)}`, 'success');
                setTimeout(() => loadMaintenance(), 500);
            } else {
                showToast(result?.error || 'Failed to update', 'error');
                loadMaintenance();
            }
        }
        
        function openMaintenanceConfigForEnable(scope) {
            // Fetch current config and show modal for enabling
            api(`/v3/maintenance/${scope}`).then(data => {
                if (!data?.success) {
                    showToast('Failed to load configuration', 'error');
                    return;
                }
                
                const s = data.scope;
                const modalContent = `
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Configure maintenance mode settings before enabling.</p>
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" id="maint-title" placeholder="Scheduled Maintenance" value="${s.title || 'Scheduled Maintenance'}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subtitle</label>
                        <input type="text" class="form-input" id="maint-subtitle" placeholder="We'll be back shortly" value="${s.subtitle || "We'll be back shortly"}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message (Markdown supported)</label>
                        <textarea class="form-textarea" id="maint-message" rows="4" placeholder="We're performing scheduled maintenance to improve your experience.">${s.message || "We're performing scheduled maintenance to improve your experience."}</textarea>
                    </div>
                    
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-weight: 500; margin-bottom: 12px;">Schedule Options</div>
                        
                        <div class="form-group" id="duration-group">
                            <label class="form-label">Duration (minutes) <span style="color: var(--text-muted); font-size: 12px;">- Start now, end after X minutes</span></label>
                            <input type="number" class="form-input" id="maint-duration" placeholder="60" onchange="handleScheduleChange('duration')">
                        </div>
                        
                        <div style="text-align: center; color: var(--text-muted); margin: 16px 0; font-size: 13px;"> OR </div>
                        
                        <div id="datetime-group">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label class="form-label">Start Time <span style="color: var(--text-muted); font-size: 12px;">- (optional)</span></label>
                                    <input type="datetime-local" class="form-input" id="maint-start" onchange="handleScheduleChange('datetime')">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">End Time <span style="color: var(--text-muted); font-size: 12px;">- (optional)</span></label>
                                    <input type="datetime-local" class="form-input" id="maint-end" onchange="handleScheduleChange('datetime')">
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">
                             Leave all empty to start immediately with no end time (manual disable required)
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-top: 1px solid var(--border-color);">
                        <div>
                            <div style="font-weight: 500;">Admin Bypass</div>
                            <div style="font-size: 13px; color: var(--text-muted);">Allow admins to access during maintenance</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="maint-admin-bypass" ${s.admin_bypass ? 'checked' : 'checked'}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-top: 1px solid var(--border-color);">
                        <div>
                            <div style="font-weight: 500;">Apply to Localhost</div>
                            <div style="font-size: 13px; color: var(--text-muted);">Block localhost access (for testing)</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="maint-apply-localhost" ${s.apply_localhost ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-top: 1px solid var(--border-color);">
                        <div>
                            <div style="font-weight: 500;">Discord Announcement</div>
                            <div style="font-size: 13px; color: var(--text-muted);">Post to Discord webhook when enabled</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="maint-discord-announce" ${s.discord_announce ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                `;
                
                showCustomModal('Enable Maintenance - ' + formatScopeName(scope), modalContent, [
                    { text: 'Cancel', class: 'btn-secondary', action: () => { closeModal('customModal'); loadMaintenance(); } },
                    { text: 'Enable Maintenance', class: 'btn-danger', action: () => enableMaintenanceWithConfig(scope) }
                ]);
                
                // Set scheduled times if they exist and add change handlers
                setTimeout(() => {
                    if (s.scheduled_start) {
                        document.getElementById('maint-start').value = new Date(s.scheduled_start).toISOString().slice(0, 16);
                    }
                    if (s.scheduled_end) {
                        document.getElementById('maint-end').value = new Date(s.scheduled_end).toISOString().slice(0, 16);
                    }
                    
                    // Add global handler function for schedule changes
                    window.handleScheduleChange = function(changedField) {
                        const durationInput = document.getElementById('maint-duration');
                        const startInput = document.getElementById('maint-start');
                        const endInput = document.getElementById('maint-end');
                        const durationGroup = document.getElementById('duration-group');
                        const datetimeGroup = document.getElementById('datetime-group');
                        
                        if (changedField === 'duration') {
                            // If duration is set, disable datetime fields
                            if (durationInput.value) {
                                startInput.value = '';
                                endInput.value = '';
                                datetimeGroup.style.opacity = '0.5';
                                datetimeGroup.style.pointerEvents = 'none';
                                durationGroup.style.opacity = '1';
                            } else {
                                // Duration cleared, re-enable datetime
                                datetimeGroup.style.opacity = '1';
                                datetimeGroup.style.pointerEvents = 'auto';
                            }
                        } else if (changedField === 'datetime') {
                            // If start or end time is set, disable duration
                            if (startInput.value || endInput.value) {
                                durationInput.value = '';
                                durationGroup.style.opacity = '0.5';
                                durationGroup.style.pointerEvents = 'none';
                                datetimeGroup.style.opacity = '1';
                            } else {
                                // Both datetime fields cleared, re-enable duration
                                durationGroup.style.opacity = '1';
                                durationGroup.style.pointerEvents = 'auto';
                            }
                        }
                    };
                }, 100);
            });
        }
        
        async function enableMaintenanceWithConfig(scope) {
            const config = {
                enabled: true,
                title: document.getElementById('maint-title').value,
                subtitle: document.getElementById('maint-subtitle').value,
                message: document.getElementById('maint-message').value,
                scheduledStart: document.getElementById('maint-start').value || null,
                scheduledEnd: document.getElementById('maint-end').value || null,
                duration: parseInt(document.getElementById('maint-duration').value) || null,
                adminBypass: document.getElementById('maint-admin-bypass').checked,
                applyLocalhost: document.getElementById('maint-apply-localhost').checked,
                discordAnnounce: document.getElementById('maint-discord-announce').checked
            };
            
            const result = await api(`/v3/maintenance/${scope}`, {
                method: 'PUT',
                body: JSON.stringify(config)
            });
            
            if (result?.success) {
                showToast(`Maintenance enabled for ${formatScopeName(scope)}`, 'success');
                closeModal('customModal');
                setTimeout(() => loadMaintenance(), 500);
            } else {
                showToast(result?.error || 'Failed to enable', 'error');
            }
        }

        function openMaintenanceConfig(scope) {
            // Fetch current config and show modal
            api(`/v3/maintenance/${scope}`).then(data => {
                if (!data?.success) {
                    showToast('Failed to load configuration', 'error');
                    return;
                }
                
                const s = data.scope;
                const modalContent = `
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" id="maint-title" placeholder="Scheduled Maintenance">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subtitle</label>
                        <input type="text" class="form-input" id="maint-subtitle" placeholder="We'll be back shortly">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message (Markdown supported)</label>
                        <textarea class="form-textarea" id="maint-message" rows="4" placeholder="We're performing scheduled maintenance to improve your experience."></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Start Time</label>
                            <input type="datetime-local" class="form-input" id="maint-start">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Time</label>
                            <input type="datetime-local" class="form-input" id="maint-end">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Or Duration (minutes)</label>
                        <input type="number" class="form-input" id="maint-duration" placeholder="60">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-top: 1px solid var(--border-color); margin-top: 16px;">
                        <div>
                            <div style="font-weight: 500;">Admin Bypass</div>
                            <div style="font-size: 13px; color: var(--text-muted);">Allow admins to access during maintenance</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="maint-admin-bypass" ${s.adminBypass ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-top: 1px solid var(--border-color);">
                        <div>
                            <div style="font-weight: 500;">Discord Announcement</div>
                            <div style="font-size: 13px; color: var(--text-muted);">Post to Discord webhook when toggled</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="maint-discord-announce" ${s.discord_announce ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                `;
                
                showCustomModal('Configure ' + formatScopeName(scope), modalContent, [
                    { text: 'Cancel', class: 'btn-secondary', action: () => closeModal('customModal') },
                    { text: 'Save Configuration', class: 'btn-primary', action: () => saveMaintenanceConfig(scope) }
                ]);
                
                // Set values after modal is shown
                setTimeout(() => {
                    document.getElementById('maint-title').value = s.title || '';
                    document.getElementById('maint-subtitle').value = s.subtitle || '';
                    document.getElementById('maint-message').value = s.message || '';
                    if (s.scheduled_start) {
                        document.getElementById('maint-start').value = new Date(s.scheduled_start).toISOString().slice(0, 16);
                    }
                    if (s.scheduled_end) {
                        document.getElementById('maint-end').value = new Date(s.scheduled_end).toISOString().slice(0, 16);
                    }
                    document.getElementById('maint-admin-bypass').checked = s.adminBypass || false;
                    document.getElementById('maint-discord-announce').checked = s.discord_announce || false;
                }, 100);
            });
        }

        async function saveMaintenanceConfig(scope) {
            const config = {
                title: document.getElementById('maint-title').value,
                subtitle: document.getElementById('maint-subtitle').value,
                message: document.getElementById('maint-message').value,
                scheduledStart: document.getElementById('maint-start').value || null,
                scheduledEnd: document.getElementById('maint-end').value || null,
                duration: parseInt(document.getElementById('maint-duration').value) || null,
                adminBypass: document.getElementById('maint-admin-bypass').checked,
                discordAnnounce: document.getElementById('maint-discord-announce').checked
            };
            
            const result = await api(`/v3/maintenance/${scope}`, {
                method: 'PUT',
                body: JSON.stringify(config)
            });
            
            if (result?.success) {
                showToast('Configuration saved', 'success');
                closeModal('customModal');
                loadMaintenance();
            } else {
                showToast(result?.error || 'Failed to save', 'error');
            }
        }

        async function extendMaintenance(scope) {
            const modalContent = `
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Extend the maintenance window by the specified duration.</p>
                <div class="form-group">
                    <label class="form-label">Extend by (minutes)</label>
                    <input type="number" class="form-input" id="extend-minutes" value="30" min="1">
                </div>
            `;
            
            showCustomModal('Extend Maintenance', modalContent, [
                { text: 'Cancel', class: 'btn-secondary', action: () => closeModal('customModal') },
                { text: 'Extend', class: 'btn-primary', action: async () => {
                    const minutes = parseInt(document.getElementById('extend-minutes').value);
                    if (!minutes || minutes < 1) {
                        showToast('Enter valid duration', 'error');
                        return;
                    }
                    
                    const result = await api(`/v3/maintenance/${scope}/extend`, {
                        method: 'POST',
                        body: JSON.stringify({ minutes })
                    });
                    
                    if (result?.success) {
                        showToast(`Extended by ${minutes} minutes`, 'success');
                        closeModal('customModal');
                        loadMaintenance();
                    } else {
                        showToast(result?.error || 'Failed to extend', 'error');
                    }
                }}
            ]);
        }

        async function addStatusUpdate(scope) {
            const modalContent = `
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Add a status update that will be shown on the maintenance page.</p>
                <div class="form-group">
                    <label class="form-label">Update Message</label>
                    <textarea class="form-textarea" id="status-update-message" rows="3" placeholder="Progress update..."></textarea>
                </div>
            `;
            
            showCustomModal('Add Status Update', modalContent, [
                { text: 'Cancel', class: 'btn-secondary', action: () => closeModal('customModal') },
                { text: 'Add Update', class: 'btn-primary', action: async () => {
                    const message = document.getElementById('status-update-message').value;
                    if (!message.trim()) {
                        showToast('Enter a message', 'error');
                        return;
                    }
                    
                    const result = await api(`/v3/maintenance/${scope}/update`, {
                        method: 'POST',
                        body: JSON.stringify({ message })
                    });
                    
                    if (result?.success) {
                        showToast('Status update added', 'success');
                        closeModal('customModal');
                    } else {
                        showToast(result?.error || 'Failed to add update', 'error');
                    }
                }}
            ]);
        }

        async function toggleMaintenance(scope, enabled) {
            const result = await api(`/v3/maintenance/${scope}`, {
                method: 'PUT',
                body: JSON.stringify({ enabled })
            });

            if (result?.success) {
                showToast(`Maintenance ${enabled ? 'enabled' : 'disabled'} for ${scope}`, 'success');
            } else {
                showToast(result?.error || 'Failed to update', 'error');
                loadMaintenance();
            }
        }

        // ============================================================================
        // USERS TAB (Owner/Co-Owner only)
        // ============================================================================
        let currentUsersData = null;

        async function loadUsers() {
            const data = await api('/v3/users');
            if (!data || !data.success) return show404();
            if (data.notFound) return show404();

            currentUsersData = data;

            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 class="page-title">Users & Roles</h1>
                        <p class="page-subtitle">Manage admin users and their roles</p>
                    </div>
                    <button class="btn btn-primary" onclick="openInviteModal()">
                        <i class="fas fa-user-plus"></i> Invite User
                    </button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>2FA</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.users.map(u => `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 12px;">
                                                    <div style="width: 36px; height: 36px; border-radius: 8px; background: ${u.role_color || 'var(--accent-primary)'}; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                                        ${u.email.charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <div style="font-weight: 500;">${u.display_name || u.email.split('@')[0]}</div>
                                                        <div style="font-size: 12px; color: var(--text-muted);">${u.email}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><span class="badge role-${u.role_name}">${u.role_name}</span></td>
                                            <td><span class="badge ${u.status === 'active' ? 'badge-success' : u.status === 'pending' ? 'badge-warning' : 'badge-error'}">${u.status}</span></td>
                                            <td>${u.totp_enabled ? '<i class="fas fa-shield-alt" style="color: var(--success);"></i>' : '<i class="fas fa-times" style="color: var(--text-muted);"></i>'}</td>
                                            <td>
                                                <div style="display: flex; gap: 8px;">
                                                    ${u.role_name !== 'owner' ? `
                                                        <button class="btn btn-sm btn-secondary" onclick="editUser('${u.id}')" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-secondary" onclick="resetUserPassword('${u.id}')" title="Reset Password">
                                                            <i class="fas fa-key"></i>
                                                        </button>
                                                        ${state.user.role === 'owner' ? `
                                                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}', '${u.email}')" title="Delete">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        ` : ''}
                                                    ` : '<span style="color: var(--text-muted); font-size: 12px;">Protected</span>'}
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Roles Overview</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            ${data.roles.map(r => `
                                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 16px; border-left: 4px solid ${r.color};">
                                    <div style="font-weight: 600; margin-bottom: 4px;">${r.name.charAt(0).toUpperCase() + r.name.slice(1)}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Level ${r.rank_level}</div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                                        ${data.users.filter(u => u.role_name === r.name).length} user(s)
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function openInviteModal() {
            if (!currentUsersData) return;
            
            const roles = currentUsersData.roles.filter(r => {
                // Owner can only be set manually, never via invite
                if (r.name === 'owner') return false;
                // Co-owner can only be invited by owner
                if (r.name === 'co-owner' && state.user.role !== 'owner') return false;
                return true;
            });
            
            const modalContent = `
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Create a new admin account. A temporary password will be generated.
                </p>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="invite-email" placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Display Name (optional)</label>
                    <input type="text" class="form-input" id="invite-name" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="invite-role">
                        ${roles.map(r => `<option value="${r.name}">${r.name.charAt(0).toUpperCase() + r.name.slice(1)}</option>`).join('')}
                    </select>
                </div>
            `;
            
            showCustomModal('Invite New Admin', modalContent, [
                { text: 'Cancel', class: 'btn-secondary', action: () => closeModal('customModal') },
                { text: 'Create Account', class: 'btn-primary', action: submitInvite }
            ]);
        }

        async function submitInvite() {
            const email = document.getElementById('invite-email').value.trim();
            const displayName = document.getElementById('invite-name').value.trim();
            const roleName = document.getElementById('invite-role').value;
            
            if (!email) {
                showToast('Email is required', 'error');
                return;
            }
            
            const result = await api('/v3/users/invite', {
                method: 'POST',
                body: JSON.stringify({ email, displayName, roleName })
            });
            
            if (result?.success) {
                closeModal('customModal');
                
                // Show the temporary password
                showCustomModal('Account Created', `
                    <div style="text-align: center;">
                        <i class="fas fa-check-circle" style="font-size: 48px; color: var(--success); margin-bottom: 16px;"></i>
                        <p style="margin-bottom: 20px;">Admin account created successfully!</p>
                        <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Temporary Password</div>
                            <div style="font-family: monospace; font-size: 18px; font-weight: 600; word-break: break-all; user-select: all;">${result.tempPassword}</div>
                        </div>
                        <p style="font-size: 13px; color: var(--text-muted);">
                            <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>
                            Share this password securely. It cannot be retrieved later.
                        </p>
                    </div>
                `, [
                    { text: 'Copy Password', class: 'btn-secondary', action: () => {
                        navigator.clipboard.writeText(result.tempPassword);
                        showToast('Password copied', 'success');
                    }},
                    { text: 'Done', class: 'btn-primary', action: () => {
                        closeModal('customModal');
                        loadUsers();
                    }}
                ]);
            } else {
                showToast(result?.error || 'Failed to create account', 'error');
            }
        }

        function editUser(userId) {
            if (!currentUsersData) return;
            
            const user = currentUsersData.users.find(u => u.id === userId);
            if (!user) {
                showToast('User not found', 'error');
                return;
            }
            
            const roles = currentUsersData.roles.filter(r => {
                if (r.name === 'owner') return false;
                if (r.name === 'co-owner' && state.user.role !== 'owner') return false;
                return true;
            });
            
            const modalContent = `
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                    <div style="width: 48px; height: 48px; border-radius: 10px; background: ${user.role_color || 'var(--accent-primary)'}; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600;">
                        ${user.email.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <div style="font-weight: 600;">${user.display_name || user.email.split('@')[0]}</div>
                        <div style="font-size: 13px; color: var(--text-muted);">${user.email}</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Display Name</label>
                    <input type="text" class="form-input" id="edit-name">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="edit-role">
                        ${roles.map(r => `<option value="${r.name}" ${user.role_name === r.name ? 'selected' : ''}>${r.name.charAt(0).toUpperCase() + r.name.slice(1)}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="edit-status">
                        <option value="active" ${user.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="suspended" ${user.status === 'suspended' ? 'selected' : ''}>Suspended</option>
                        <option value="pending" ${user.status === 'pending' ? 'selected' : ''}>Pending</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-top: 1px solid var(--border-color); margin-top: 16px;">
                    <div>
                        <div style="font-weight: 500;">Require 2FA</div>
                        <div style="font-size: 13px; color: var(--text-muted);">Force this user to enable 2FA</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="edit-require-2fa" ${user.requires_2fa ? 'checked' : ''}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-top: 1px solid var(--border-color);">
                    <div>
                        <div style="font-weight: 500;">Force Logout</div>
                        <div style="font-size: 13px; color: var(--text-muted);">Terminate all active sessions</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="edit-force-logout">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            `;
            
            showCustomModal('Edit User', modalContent, [
                { text: 'Cancel', class: 'btn-secondary', action: () => closeModal('customModal') },
                { text: 'Save Changes', class: 'btn-primary', action: () => submitEditUser(userId) }
            ]);
            
            // Set value after modal is shown
            setTimeout(() => {
                document.getElementById('edit-name').value = user.display_name || '';
            }, 100);
        }

        async function submitEditUser(userId) {
            const data = {
                displayName: document.getElementById('edit-name').value.trim(),
                roleName: document.getElementById('edit-role').value,
                status: document.getElementById('edit-status').value,
                requires2FA: document.getElementById('edit-require-2fa').checked,
                forceLogout: document.getElementById('edit-force-logout').checked
            };
            
            const result = await api(`/v3/users/${userId}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });
            
            if (result?.success) {
                showToast('User updated successfully', 'success');
                closeModal('customModal');
                loadUsers();
            } else {
                showToast(result?.error || 'Failed to update user', 'error');
            }
        }

        async function resetUserPassword(userId) {
            confirmAction('Reset Password', 'This will generate a new temporary password and terminate all active sessions. Continue?', null, async () => {
                const result = await api(`/v3/users/${userId}/reset-password`, { method: 'POST' });
                
                if (result?.success) {
                    showCustomModal('Password Reset', `
                        <div style="text-align: center;">
                            <i class="fas fa-key" style="font-size: 48px; color: var(--warning); margin-bottom: 16px;"></i>
                            <p style="margin-bottom: 20px;">Password has been reset!</p>
                            <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">New Temporary Password</div>
                                <div style="font-family: monospace; font-size: 18px; font-weight: 600; word-break: break-all; user-select: all;">${result.tempPassword}</div>
                            </div>
                            <p style="font-size: 13px; color: var(--text-muted);">
                                ${result.note}
                            </p>
                        </div>
                    `, [
                        { text: 'Copy Password', class: 'btn-secondary', action: () => {
                            navigator.clipboard.writeText(result.tempPassword);
                            showToast('Password copied', 'success');
                        }},
                        { text: 'Done', class: 'btn-primary', action: () => closeModal('customModal') }
                    ]);
                } else {
                    showToast(result?.error || 'Failed to reset password', 'error');
                }
            });
        }

        async function deleteUser(userId, email) {
            confirmAction('Delete User', `This will permanently delete the admin account for ${email}. This action cannot be undone.`, 'DELETE', async () => {
                const result = await api(`/v3/users/${userId}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ confirmation: 'DELETE' })
                });
                
                if (result?.success) {
                    showToast('User deleted successfully', 'success');
                    loadUsers();
                } else {
                    showToast(result?.error || 'Failed to delete user', 'error');
                }
            });
        }

        // ============================================================================
        // PERMISSIONS TAB (Owner/Co-Owner only)
        // ============================================================================
        let currentPermissionsData = null;
        let permissionChanges = {};

        async function loadPermissions() {
            const data = await api('/v3/permissions');
            if (!data || !data.success) return show404();
            if (data.notFound) return show404();

            currentPermissionsData = data;
            permissionChanges = {};

            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 class="page-title">Permissions</h1>
                        <p class="page-subtitle">Configure role permissions</p>
                    </div>
                    <button class="btn btn-primary" id="savePermissionsBtn" style="display: none;" onclick="savePermissionChanges()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            <i class="fas fa-info-circle" style="color: var(--info);"></i>
                            Check/uncheck permissions for each role. Owner has all permissions by default. Changes require clicking "Save Changes".
                        </p>
                        <div class="table-container" style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="min-width: 200px;">Permission</th>
                                        ${data.roles.filter(r => r.name !== 'owner').map(r => `
                                            <th style="text-align: center; min-width: 100px;">
                                                <span class="badge role-${r.name}">${r.name}</span>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.categories.map(cat => `
                                        <tr style="background: var(--bg-tertiary);">
                                            <td colspan="${data.roles.length}" style="font-weight: 600; text-transform: uppercase; font-size: 12px; color: var(--text-muted); padding: 12px 16px;">
                                                <i class="fas fa-folder" style="margin-right: 8px;"></i>${cat}
                                            </td>
                                        </tr>
                                        ${data.permissions.filter(p => p.category === cat).map(p => `
                                            <tr>
                                                <td>
                                                    <div style="font-weight: 500;">${p.name}</div>
                                                    <div style="font-size: 12px; color: var(--text-muted); font-family: monospace;">${p.key}</div>
                                                </td>
                                                ${data.roles.filter(r => r.name !== 'owner').map(r => {
                                                    const isChecked = data.matrix[r.id]?.[p.id] ? 'checked' : '';
                                                    const isDisabled = (r.name === 'co-owner' && state.user.role !== 'owner') ? 'disabled' : '';
                                                    return `
                                                        <td style="text-align: center;">
                                                            <label class="toggle" style="margin: 0 auto;">
                                                                <input type="checkbox" ${isChecked} ${isDisabled}
                                                                    data-role-id="${r.id}" 
                                                                    data-perm-id="${p.id}"
                                                                    onchange="markPermissionChange('${r.id}', '${p.id}', this.checked)">
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                                        </td>
                                                    `;
                                                }).join('')}
                                            </tr>
                                        `).join('')}
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function markPermissionChange(roleId, permId, enabled) {
            // Initialize role changes if not exists
            if (!permissionChanges[roleId]) {
                permissionChanges[roleId] = {};
            }
            
            // Get original value
            const original = currentPermissionsData.matrix[roleId]?.[permId] || false;
            
            // If same as original, remove from changes
            if (enabled === original) {
                delete permissionChanges[roleId][permId];
                if (Object.keys(permissionChanges[roleId]).length === 0) {
                    delete permissionChanges[roleId];
                }
            } else {
                permissionChanges[roleId][permId] = enabled;
            }
            
            // Show/hide save button
            const hasChanges = Object.keys(permissionChanges).length > 0;
            document.getElementById('savePermissionsBtn').style.display = hasChanges ? 'flex' : 'none';
        }

        async function savePermissionChanges() {
            if (Object.keys(permissionChanges).length === 0) {
                showToast('No changes to save', 'info');
                return;
            }
            
            let success = true;
            let errorMsg = '';
            
            for (const [roleId, changes] of Object.entries(permissionChanges)) {
                // Build full permission list for this role
                const permissions = [];
                
                // Start with current permissions
                for (const [permId, hasIt] of Object.entries(currentPermissionsData.matrix[roleId] || {})) {
                    if (hasIt) permissions.push(permId);
                }
                
                // Apply changes
                for (const [permId, enabled] of Object.entries(changes)) {
                    const idx = permissions.indexOf(permId);
                    if (enabled && idx === -1) {
                        permissions.push(permId);
                    } else if (!enabled && idx !== -1) {
                        permissions.splice(idx, 1);
                    }
                }
                
                // Save
                const result = await api(`/v3/permissions/role/${roleId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ permissions })
                });
                
                if (!result?.success) {
                    success = false;
                    errorMsg = result?.error || 'Failed to save';
                    break;
                }
            }
            
            if (success) {
                showToast('Permissions saved successfully', 'success');
                permissionChanges = {};
                document.getElementById('savePermissionsBtn').style.display = 'none';
                loadPermissions(); // Reload to get fresh data
            } else {
                showToast(errorMsg, 'error');
            }
        }

        async function togglePermission(roleId, permId, enabled) {
            // This is now handled by markPermissionChange and savePermissionChanges
            markPermissionChange(roleId, permId, enabled);
        }

        // ============================================================================
        // BOT TAB
        // ============================================================================
        async function loadBot() {
            const data = await api('/v3/bot');
            if (!data || !data.success) return show404();

            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 class="page-title">Discord Bot Control</h1>
                        <p class="page-subtitle">Manage your Discord bot</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="resyncCommands()">
                            <i class="fas fa-sync"></i> Resync Commands
                        </button>
                        <button class="btn btn-danger" onclick="restartBot()">
                            <i class="fas fa-power-off"></i> Restart Bot
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Status</span>
                            <div class="stat-icon ${data.status === 'online' ? 'success' : 'warning'}">
                                <i class="fab fa-discord"></i>
                            </div>
                        </div>
                        <div class="stat-value" style="text-transform: capitalize;">${data.status}</div>
                        <div class="stat-trend">${data.ping}ms ping</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Guilds</span>
                            <div class="stat-icon info">
                                <i class="fas fa-server"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.guilds.length}</div>
                        <div class="stat-trend">Discord servers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Commands</span>
                            <div class="stat-icon purple">
                                <i class="fas fa-terminal"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.commands}</div>
                        <div class="stat-trend">Registered</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Shards</span>
                            <div class="stat-icon success">
                                <i class="fas fa-network-wired"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.shards.length || 1}</div>
                        <div class="stat-trend">Active shards</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Guilds</span>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Guild</th>
                                        <th>Members</th>
                                        <th>Shard</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.guilds.slice(0, 20).map(g => `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 12px;">
                                                    ${g.icon ? `<img src="${g.icon}" style="width: 32px; height: 32px; border-radius: 8px;">` : 
                                                    `<div style="width: 32px; height: 32px; border-radius: 8px; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center;">${g.name.charAt(0)}</div>`}
                                                    <span>${g.name}</span>
                                                </div>
                                            </td>
                                            <td>${g.memberCount.toLocaleString()}</td>
                                            <td>#${g.shardId || 0}</td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No guilds</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function resyncCommands() {
            const result = await api('/v3/bot/resync', { method: 'POST' });
            if (result?.success) {
                showToast(`Commands resynced (${result.count} commands)`, 'success');
            } else {
                showToast(result?.error || 'Failed to resync', 'error');
            }
        }

        async function restartBot() {
            confirmAction('Restart Bot', 'This will restart the Discord bot. Are you sure?', 'RESTART', async () => {
                const result = await api('/v3/bot/restart', { 
                    method: 'POST',
                    body: JSON.stringify({ confirmation: 'RESTART' })
                });
                if (result?.success) {
                    showToast('Bot restart initiated', 'success');
                } else {
                    showToast(result?.error || 'Failed to restart', 'error');
                }
            });
        }

        // ============================================================================
        // PLATFORM TAB
        // ============================================================================
        async function loadPlatform() {
            const data = await api('/v3/platform');
            if (!data || !data.success) return show404();

            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Platform Control</h1>
                    <p class="page-subtitle">Feature flags and deployments</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Version</span>
                            <div class="stat-icon purple">
                                <i class="fas fa-code-branch"></i>
                            </div>
                        </div>
                        <div class="stat-value">v${data.deploy.version}</div>
                        <div class="stat-trend">${data.deploy.nodeVersion}</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Feature Flags</span>
                    </div>
                    <div class="card-body">
                        ${data.features.length > 0 ? data.features.map(f => `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 12px;">
                                <div>
                                    <div style="font-weight: 600;">${f.name}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">${f.description || 'No description'}</div>
                                </div>
                                <label class="toggle">
                                    <input type="checkbox" ${f.is_enabled ? 'checked' : ''} onchange="toggleFeature('${f.id}', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        `).join('') : '<p style="color: var(--text-muted); text-align: center;">No feature flags configured</p>'}
                    </div>
                </div>
            `;
        }

        async function toggleFeature(id, enabled) {
            const result = await api(`/v3/platform/features/${id}`, {
                method: 'PUT',
                body: JSON.stringify({ enabled })
            });
            if (result?.success) {
                showToast(`Feature ${enabled ? 'enabled' : 'disabled'}`, 'success');
            } else {
                showToast(result?.error || 'Failed to update', 'error');
            }
        }

        // ============================================================================
        // LOGS TAB
        // ============================================================================
        async function loadLogs() {
            const data = await api('/v3/logs?limit=50');
            if (!data || !data.success) return show404();

            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Logs</h1>
                    <p class="page-subtitle">System and application logs</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Recent Logs</span>
                        <div style="display: flex; gap: 12px;">
                            <select class="form-select" style="width: auto;" onchange="filterLogs(this.value)">
                                <option value="">All Severities</option>
                                ${data.filters.severities.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Severity</th>
                                        <th>Action</th>
                                        <th>Admin</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.logs.map(l => `
                                        <tr>
                                            <td style="font-size: 12px; color: var(--text-muted);">${new Date(l.created_at).toLocaleString()}</td>
                                            <td><span class="badge badge-${l.severity === 'critical' ? 'error' : l.severity === 'high' ? 'warning' : 'info'}">${l.severity || 'info'}</span></td>
                                            <td>${l.action}</td>
                                            <td>${l.admin_email || 'System'}</td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No logs</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // AUDIT TAB
        // ============================================================================
        async function loadAudit() {
            const data = await api('/v3/audit');
            if (!data || !data.success) return show404();

            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Audit Trail</h1>
                    <p class="page-subtitle">Complete history of admin actions</p>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Action</th>
                                        <th>Admin</th>
                                        <th>IP Address</th>
                                        <th>Severity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.logs.map(l => `
                                        <tr>
                                            <td style="font-size: 12px;">${new Date(l.created_at).toLocaleString()}</td>
                                            <td><code style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;">${l.action}</code></td>
                                            <td>${l.admin_email || 'System'}</td>
                                            <td style="font-family: monospace; font-size: 12px;">${l.ip_address || '-'}</td>
                                            <td><span class="badge badge-${l.severity === 'critical' ? 'error' : l.severity === 'high' ? 'warning' : 'info'}">${l.severity || 'low'}</span></td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No audit logs</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                        ${data.pagination ? `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <span style="color: var(--text-muted); font-size: 13px;">Page ${data.pagination.page} of ${data.pagination.totalPages} (${data.pagination.total} total)</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-secondary" ${data.pagination.page <= 1 ? 'disabled' : ''}>Previous</button>
                                <button class="btn btn-sm btn-secondary" ${data.pagination.page >= data.pagination.totalPages ? 'disabled' : ''}>Next</button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // SECURITY TAB
        // ============================================================================
        async function loadSecurity() {
            const data = await api('/v3/security');
            if (!data || !data.success) return show404();

            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Security Center</h1>
                    <p class="page-subtitle">Monitor security events and threats</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Failed Logins (24h)</span>
                            <div class="stat-icon error">
                                <i class="fas fa-user-times"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.failedLogins.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Rate Limited</span>
                            <div class="stat-icon warning">
                                <i class="fas fa-hand-paper"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.rateLimitEvents.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Suspicious IPs</span>
                            <div class="stat-icon error">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.suspiciousIPs.length}</div>
                    </div>
                </div>

                <div class="two-column">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Failed Login Attempts</span>
                        </div>
                        <div class="card-body">
                            ${data.failedLogins.length > 0 ? `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>IP Address</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.failedLogins.slice(0, 10).map(e => `
                                            <tr>
                                                <td>${new Date(e.created_at).toLocaleString()}</td>
                                                <td style="font-family: monospace;">${e.ip_address}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ` : '<p style="color: var(--text-muted); text-align: center;">No failed logins</p>'}
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Security Checks</span>
                        </div>
                        <div class="card-body">
                            ${Object.entries(data.securityChecks).map(([key, value]) => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="text-transform: uppercase; font-size: 13px;">${key}</span>
                                    <span class="badge ${value ? 'badge-success' : 'badge-error'}">${value ? 'Enabled' : 'Disabled'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                ${data.activeSessions ? `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Active Sessions</span>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Admin</th>
                                        <th>IP Address</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.activeSessions.map(s => `
                                        <tr>
                                            <td>${s.admin_id}</td>
                                            <td style="font-family: monospace;">${s.ip_address}</td>
                                            <td>${new Date(s.created_at).toLocaleString()}</td>
                                            <td>
                                                <button class="btn btn-sm btn-danger" onclick="revokeSession('${s.id}')">Revoke</button>
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No active sessions</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }

        async function revokeSession(sessionId) {
            confirmAction('Revoke Session', 'This will force the user to log in again. Continue?', null, async () => {
                const result = await api(`/v3/security/sessions/${sessionId}/revoke`, { method: 'POST' });
                if (result?.success) {
                    showToast('Session revoked', 'success');
                    loadSecurity();
                } else {
                    showToast(result?.error || 'Failed to revoke', 'error');
                }
            });
        }

        // ============================================================================
        // INTEGRATIONS TAB
        // ============================================================================
        async function loadIntegrations() {
            const data = await api('/v3/integrations');
            if (!data || !data.success) return show404();

            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Integrations</h1>
                    <p class="page-subtitle">External service connections</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Discord</span>
                            <div class="stat-icon ${data.discord.configured ? 'success' : 'error'}">
                                <i class="fab fa-discord"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.discord.configured ? 'Connected' : 'Not configured'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Email</span>
                            <div class="stat-icon ${data.email.configured ? 'success' : 'warning'}">
                                <i class="fas fa-envelope"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.email.configured ? data.email.provider : 'Not configured'}</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Webhooks</span>
                    </div>
                    <div class="card-body">
                        ${data.webhooks.length > 0 ? `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>URL</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.webhooks.map(w => `
                                        <tr>
                                            <td>${w.name}</td>
                                            <td style="font-family: monospace; font-size: 12px;">${w.url?.substring(0, 50)}...</td>
                                            <td><span class="badge badge-success">Active</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : '<p style="color: var(--text-muted); text-align: center;">No webhooks configured</p>'}
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // SETTINGS TAB
        // ============================================================================
        async function loadSettings() {
            const data = await api('/v3/settings');
            if (!data || !data.success) return show404();

            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                    <p class="page-subtitle">System configuration</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Branding</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Site Name</label>
                            <input type="text" class="form-input" id="settingSiteName">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Primary Color</label>
                            <input type="color" id="settingPrimaryColor" style="width: 60px; height: 40px;">
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <span class="card-title">Developer Settings</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="settingDebugMode" style="margin-right: 8px;">
                                Debug Mode
                            </label>
                            <p style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">Show all console debug logs. When disabled, only errors and warnings will be shown.</p>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>
            `;
            
            // Set values after rendering
            setTimeout(() => {
                document.getElementById('settingSiteName').value = data.branding?.name || '';
                document.getElementById('settingPrimaryColor').value = data.branding?.primaryColor || '#7c4dff';
                document.getElementById('settingDebugMode').checked = data.debug?.enabled === true || data.debug?.enabled === 'true';
            }, 0);
        }

        async function saveSettings() {
            const settings = {
                siteName: document.getElementById('settingSiteName').value,
                primaryColor: document.getElementById('settingPrimaryColor').value,
                debugMode: document.getElementById('settingDebugMode').checked
            };

            const result = await api('/v3/settings', {
                method: 'PUT',
                body: JSON.stringify({ settings })
            });

            if (result?.success) {
                showToast('Settings saved', 'success');
            } else {
                showToast(result?.error || 'Failed to save', 'error');
            }
        }

        // ============================================================================
        // HELPER FUNCTIONS
        // ============================================================================
        function show404() {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-lock"></i></div>
                    <div class="empty-state-title">Page Not Found</div>
                    <div class="empty-state-text">This page doesn't exist or you don't have access.</div>
                </div>
            `;
        }

        async function quickAction(actionId) {
            if (actionId === 'toggle_maintenance' || actionId === 'restart_service') {
                const confirmWord = actionId === 'restart_service' ? 'RESTART' : null;
                confirmAction(
                    actionId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    'Are you sure you want to perform this action?',
                    confirmWord,
                    async () => {
                        const result = await api(`/v3/quick-action/${actionId}`, {
                            method: 'POST',
                            body: JSON.stringify({ confirmation: confirmWord })
                        });
                        if (result?.success) {
                            showToast(result.message, 'success');
                            loadTab('overview');
                        } else {
                            showToast(result?.error || 'Action failed', 'error');
                        }
                    }
                );
            } else {
                const result = await api(`/v3/quick-action/${actionId}`, { method: 'POST' });
                if (result?.success) {
                    showToast(result.message, 'success');
                } else {
                    showToast(result?.error || 'Action failed', 'error');
                }
            }
        }

        // ============================================================================
        // EVENT LISTENERS
        // ============================================================================
        function setupEventListeners() {
            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('open');
            });

            // Status drawer
            document.getElementById('statusDrawerBtn').addEventListener('click', () => {
                document.getElementById('statusDrawer').classList.add('open');
                loadDrawerStatus();
            });

            document.getElementById('closeDrawerBtn').addEventListener('click', () => {
                document.getElementById('statusDrawer').classList.remove('open');
            });

            // Search
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => performSearch(e.target.value), 300);
            });

            // Alerts
            document.getElementById('alertsBtn').addEventListener('click', loadAlerts);

            // Profile menu
            document.getElementById('profileMenu').addEventListener('click', () => {
                // Would show profile dropdown
            });
        }

        async function performSearch(query) {
            const resultsEl = document.getElementById('searchResults');
            if (!query || query.length < 2) {
                resultsEl.classList.remove('visible');
                return;
            }

            const data = await api(`/v3/search?q=${encodeURIComponent(query)}`);
            if (!data?.success) return;

            if (data.results.length === 0) {
                resultsEl.innerHTML = '<div class="search-result-item">No results found</div>';
            } else {
                resultsEl.innerHTML = data.results.map(r => `
                    <div class="search-result-item">
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">${r.type}</div>
                        <div>${r.name || r.email || r.action}</div>
                    </div>
                `).join('');
            }
            resultsEl.classList.add('visible');
        }

        async function loadAlerts() {
            const data = await api('/v3/alerts');
            if (!data?.success) return;
            
            if (data.alerts.length === 0) {
                showToast('No open alerts', 'info');
            } else {
                showToast(`${data.alerts.length} open alerts`, 'warning');
            }
        }

        async function loadDrawerStatus() {
            const body = document.getElementById('drawerBody');
            const data = await api('/v3/status');
            if (!data?.success) return;

            body.innerHTML = `
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Gateway</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="service-status ${data.gateway.status === 'connected' ? 'operational' : 'down'}"></div>
                        <span>${data.gateway.status}</span>
                        <span style="margin-left: auto; color: var(--text-muted);">${data.gateway.ping}ms</span>
                    </div>
                </div>
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Services</div>
                ${data.services.map(s => `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                        <div class="service-status ${s.status}"></div>
                        <span>${s.service_name}</span>
                        <span style="margin-left: auto; color: var(--text-muted);">${s.latency_ms}ms</span>
                    </div>
                `).join('')}
            `;
        }

        // Live updates
        function startLiveUpdates() {
            setInterval(async () => {
                // Update alerts badge
                const alerts = await api('/v3/alerts');
                if (alerts?.success) {
                    updateAlertsBadge(alerts.alerts.length);
                }
            }, 30000);
        }

        // Initialize
        init();
    </script>
</body>
</html>
