<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/platform/styles.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="platform-layout">
    <div class="platform-container">
        <!-- Back Button -->
        <div style="margin-bottom: 1rem;">
            <a href="/platform/devices" style="color: var(--accent-primary); font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
                Back to Devices
            </a>
        </div>

        <% if (error || !device) { %>
            <div class="empty-state">
                <div class="empty-state-icon">‚ö†Ô∏è</div>
                <h3 style="font-size: 1.25rem; margin-bottom: 0.5rem; color: var(--text-primary);">Device unavailable</h3>
                <p><%= error || 'We could not load this device right now.' %></p>
                <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="retry('<%= retryPath || '/platform/devices' %>')">
                        Retry
                    </button>
                    <a class="btn btn-secondary" href="/platform/devices">Back to list</a>
                </div>
            </div>
        <% } else { %>

        <!-- Header -->
        <% const status = device.status || 'offline'; const securityProfile = device.securityProfile || 'NORMAL'; %>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1 class="mono" style="font-size: 1.5rem; font-weight: 700;"><%= (device.id || device.name || 'DEVICE').toUpperCase() %></h1>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span class="status-dot status-dot-<%= status %>"></span>
                <span style="font-weight: 600; color: <%= status === 'online' ? 'var(--online)' : 'var(--offline)' %>;">
                    <%= status === 'online' ? 'Online' : 'Offline' %>
                </span>
                <span style="color: var(--text-muted);">‚Ä¢</span>
                <% if (securityProfile === 'ZERO_TRUST') { %>
                    <span class="badge badge-zerotrust">
                        <i data-lucide="shield" style="width: 12px; height: 12px;"></i>
                        Zero-Trust
                    </span>
                <% } else { %>
                    <span style="color: var(--text-secondary);">Normal</span>
                <% } %>
            </div>
        </div>
                            function copyText(text, label) {
                                navigator.clipboard.writeText(text).then(() => {
                                    const toast = document.createElement('div');
                                    toast.textContent = `${label} copied!`;
                                    toast.style.cssText = `
                                        position: fixed;
                                        top: 20px;
                                        right: 20px;
                                        background: rgba(16, 185, 129, 0.9);
                                        color: white;
                                        padding: 1rem 1.5rem;
                                        border-radius: 0.5rem;
                                        z-index: 1000;
                                        animation: slideIn 0.3s ease;
                                    `;
                                    document.body.appendChild(toast);
                                    setTimeout(() => toast.remove(), 2000);
                                });
                            }

                            (function setupEnterSafeMode() {
                                const btn = document.getElementById('btn-enter-safe-mode');
                                if (!btn) return;

                                const statusEl = document.getElementById('safe-mode-status');
                                const errEl = document.getElementById('safe-mode-error');
                                const spinner = document.getElementById('btn-safe-mode-spinner');
                                const label = document.getElementById('btn-safe-mode-label');

                                const initial = <%- JSON.stringify(safeModeCommand || null) %>;

                                function setState(state, opts = {}) {
                                    btn.dataset.state = state;
                                    errEl.style.display = 'none';
                                    errEl.textContent = '';
                                    statusEl.style.display = 'none';
                                    statusEl.textContent = '';
                                    spinner.style.display = state === 'pending' ? 'inline-block' : 'none';
                                    btn.disabled = state === 'pending' || state === 'completed';

                                    if (state === 'pending') {
                                        label.textContent = 'Entering Safe Mode...';
                                        statusEl.style.display = 'flex';
                                        statusEl.textContent = 'Command pending. Waiting for device response.';
                                    } else if (state === 'completed') {
                                        label.textContent = 'Safe Mode Active';
                                        btn.classList.remove('btn-warning');
                                        btn.classList.add('btn-secondary');
                                        statusEl.style.display = 'flex';
                                        statusEl.textContent = 'Safe Mode enabled. Exit must be performed locally on the device.';
                                    } else if (state === 'failed' || state === 'rejected') {
                                        label.textContent = 'Enter Safe Mode';
                                        errEl.style.display = 'block';
                                        errEl.textContent = opts.error || 'Request was rejected by device.';
                                        btn.disabled = false;
                                    } else {
                                        label.textContent = 'Enter Safe Mode';
                                        btn.disabled = false;
                                    }
                                }

                                if (initial) {
                                    if (initial.status === 'PENDING') {
                                        setState('pending');
                                    } else if (initial.status === 'COMPLETED') {
                                        setState('completed');
                                    } else if (initial.status === 'FAILED' || initial.status === 'REJECTED') {
                                        setState(initial.status.toLowerCase(), { error: initial.error || 'Request was rejected by device.' });
                                    }
                                }

                                btn.addEventListener('click', async () => {
                                    if (btn.disabled) return;
                                    const confirmed = confirm(
                                        'This will disable protection on the device.\n\nYou can exit Safe Mode locally on the device.\n\nContinue?'
                                    );
                                    if (!confirmed) return;
                                    setState('pending');
                                    try {
                                        const res = await fetch('/platform/devices/<%= device.id %>/enter-safe-mode', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' }
                                        });
                                        if (!res.ok) {
                                            const body = await res.json().catch(() => ({}));
                                            throw new Error(body.error || 'request_failed');
                                        }
                                        // remain pending until device responds
                                    } catch (e) {
                                        setState('failed', { error: e.message });
                                    }
                                });
                            })();

                            (function setupRequestLogs() {
                                const btn = document.getElementById('btn-request-logs');
                                if (!btn) return;

                                const statusEl = document.getElementById('logs-status');
                                const errEl = document.getElementById('logs-error');
                                const spinner = document.getElementById('btn-request-logs-spinner');
                                const label = document.getElementById('btn-request-logs-label');

                                const initial = <%- JSON.stringify(logsCommand || null) %>;

                                function setState(state, opts = {}) {
                                    btn.dataset.state = state;
                                    errEl.style.display = 'none';
                                    errEl.textContent = '';
                                    statusEl.style.display = 'none';
                                    statusEl.textContent = '';
                                    spinner.style.display = state === 'pending' ? 'inline-block' : 'none';
                                    btn.disabled = state === 'pending';

                                    if (state === 'pending') {
                                        label.textContent = 'Requesting Logs...';
                                        statusEl.style.display = 'flex';
                                        statusEl.textContent = 'Log request pending. Waiting for device response.';
                                    } else if (state === 'completed') {
                                        label.textContent = 'Request Logs';
                                        statusEl.style.display = 'flex';
                                        const link = document.createElement('a');
                                        link.href = opts.artifactUrl || '#';
                                        link.textContent = 'Download logs';
                                        link.style.color = 'var(--accent-primary)';
                                        link.style.fontWeight = '600';
                                        link.target = '_blank';
                                        statusEl.textContent = 'Logs ready: ';
                                        statusEl.appendChild(link);
                                    } else if (state === 'failed' || state === 'rejected') {
                                        label.textContent = 'Request Logs';
                                        errEl.style.display = 'block';
                                        errEl.textContent = opts.error || 'Request failed.';
                                        btn.disabled = false;
                                    } else {
                                        label.textContent = 'Request Logs';
                                        btn.disabled = false;
                                    }
                                }

                                if (initial) {
                                    if (initial.status === 'PENDING') {
                                        setState('pending');
                                    } else if (initial.status === 'COMPLETED') {
                                        const artifact = initial.result?.artifact_url || initial.result?.artifactUrl;
                                        setState('completed', { artifactUrl: artifact });
                                    } else if (initial.status === 'FAILED' || initial.status === 'REJECTED') {
                                        setState(initial.status.toLowerCase(), { error: initial.error || 'Request was rejected by device.' });
                                    }
                                }

                                btn.addEventListener('click', async () => {
                                    if (btn.disabled) return;
                                    setState('pending');
                                    try {
                                        const res = await fetch('/platform/devices/<%= device.id %>/request-logs', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' }
                                        });
                                        if (!res.ok) {
                                            const body = await res.json().catch(() => ({}));
                                            throw new Error(body.error || 'request_failed');
                                        }
                                        // remain pending until device responds
                                    } catch (e) {
                                        setState('failed', { error: e.message });
                                    }
                                });
                            })();
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Linked At</div>
                            <% const linkedAtDate = device.linkedAt ? new Date(device.linkedAt) : null; const linkedAtValid = linkedAtDate && !Number.isNaN(linkedAtDate.getTime()); %>
                            <div style="color: var(--text-primary);">
                                <%= linkedAtValid ? linkedAtDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit', timeZoneName: 'short' }) : 'Unknown' %>
                            </div>
                        </div>
                        
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Last Heartbeat</div>
                            <% 
                            const now = new Date();
                            const lastSeen = device.lastSeen ? new Date(device.lastSeen) : null;
                            const validLastSeen = lastSeen && !Number.isNaN(lastSeen.getTime());
                            const diffMs = validLastSeen ? now - lastSeen : null;
                            const diffMins = diffMs !== null ? Math.floor(diffMs / 60000) : null;
                            const diffHours = diffMs !== null ? Math.floor(diffMs / 3600000) : null;
                            %>
                            <div style="color: var(--text-primary);">
                                <% if (!validLastSeen || diffMins === null || diffHours === null) { %>
                                    Unknown
                                <% } else { %>
                                    <%= diffHours > 0 ? diffHours + ' hour' + (diffHours !== 1 ? 's' : '') : diffMins + ' minute' + (diffMins !== 1 ? 's' : '') %> ago
                                <% } %>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                                <% if (validLastSeen) { %>
                                    (<%= lastSeen.toISOString().replace('T', ' ').substring(0, 19) %> UTC)
                                <% } else { %>
                                    (No heartbeat recorded)
                                <% } %>
                            </div>
                        </div>
                        
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Security Profile</div>
                            <% if (securityProfile === 'ZERO_TRUST') { %>
                                <span class="badge badge-zerotrust">Zero-Trust</span>
                            <% } else { %>
                                <span style="color: var(--text-primary);">Normal</span>
                            <% } %>
                        </div>
                        
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Mode</div>
                            <span class="badge" style="background: var(--accent-primary); color: var(--bg-primary);"><%= device.mode %></span>
                        </div>
                        
                        <% if (device.publicKey) { %>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Public Key (ed25519)</div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="mono" style="font-size: 0.75rem; color: var(--text-secondary);">
                                    <%= device.publicKey.substring(0, 8) %>...<%= device.publicKey.substring(device.publicKey.length - 4) %>
                                </span>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="copyText('<%= device.publicKey %>', 'Public key')" title="Copy full public key">
                                    <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                                </button>
                            </div>
                        </div>
                        <% } %>
                    </div>
                </div>
                
                <!-- Recent Events -->
                <div class="platform-card platform-card-solid" style="margin-top: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary);">RECENT EVENTS</h2>
                        <button class="btn btn-secondary" style="font-size: 0.875rem;" disabled title="Read-only view">
                            View All
                        </button>
                    </div>
                    
                        <% if (!events || events.length === 0) { %>
                        <div class="empty-state" style="padding: 1.5rem; background: var(--bg-secondary); border: 1px dashed var(--border-color);">
                            <div class="empty-state-icon">üì≠</div>
                            <h3 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 0.25rem;">No events yet</h3>
                            <p style="color: var(--text-secondary);">Heartbeat and audit events will appear here when available.</p>
                        </div>
                    <% } else { %>
                        <ul class="events-list">
                            <% events.forEach(event => { %>
                                <li class="event-item">
                                    <span class="event-timestamp">
                                        <%= new Date(event.timestamp).toISOString().substring(0, 19).replace('T', ' ') %> UTC
                                    </span>
                                    <span class="event-dot event-dot-<%= event.type %>"></span>
                                    <span style="color: var(--text-primary);"><%= event.description %></span>
                                </li>
                            <% }) %>
                        </ul>
                        
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 1rem;" disabled title="Read-only view">
                            Load More
                        </button>
                    <% } %>
                </div>
            </div>

            <!-- Right Column: Actions Panel -->
            <div>
                <% if (securityProfile === 'ZERO_TRUST') { %>
                    <!-- Zero-Trust: Show Warning Banner -->
                    <div class="banner banner-warning">
                        <div style="display: flex; align-items: flex-start; gap: 1rem;">
                            <i data-lucide="alert-triangle" style="width: 24px; height: 24px; color: var(--zerotrust); flex-shrink: 0;"></i>
                            <div>
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">REMOTE ACTIONS DISABLED</h3>
                                <p style="font-size: 0.875rem; line-height: 1.6; margin-bottom: 0.75rem;">
                                    This device uses Zero-Trust mode. Remote commands are blocked by device policy for maximum security.
                                </p>
                                <p style="font-size: 0.875rem; line-height: 1.6;">
                                    The device owner must perform all actions locally.
                                </p>
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary" disabled style="width: 100%; margin-top: 1rem;" title="Zero-Trust devices do not accept remote commands">
                            <i data-lucide="eye-off" style="width: 16px; height: 16px;"></i>
                            View-Only Access
                        </button>
                    </div>
                <% } else { %>
                    <!-- Normal Mode: Show Actions Panel -->
                    <div class="platform-card platform-card-solid">
                        <h2 style="font-size: 1rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--text-primary);">ACTIONS</h2>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <button class="btn btn-primary" disabled title="Actions disabled in read-only mode">
                                <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                                Force Update
                            </button>
                            
                            <button id="btn-enter-safe-mode" class="btn btn-warning" data-state="idle">
                                <i data-lucide="shield-alert" style="width: 16px; height: 16px;"></i>
                                <span id="btn-safe-mode-label">Enter Safe Mode</span>
                                <span id="btn-safe-mode-spinner" class="spinner" style="display:none; margin-left: 0.5rem;"></span>
                            </button>
                            
                            <button class="btn btn-secondary" disabled title="Actions disabled in read-only mode">
                                <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                                Refresh Config
                            </button>
                            
                            <button id="btn-request-logs" class="btn btn-secondary" data-state="idle">
                                <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                                <span id="btn-request-logs-label">Request Logs</span>
                                <span id="btn-request-logs-spinner" class="spinner" style="display:none; margin-left: 0.5rem;"></span>
                            </button>
                            
                            <button class="btn btn-danger" disabled title="Actions disabled in read-only mode">
                                <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                                Revoke Device
                            </button>
                        </div>

                        <div id="safe-mode-status" class="microcopy-footer" style="margin-top: 1rem; display: none;"></div>
                        <div id="safe-mode-error" class="banner banner-danger" style="display: none; margin-top: 0.75rem;"></div>
                        <div id="logs-status" class="microcopy-footer" style="margin-top: 1rem; display: none;"></div>
                        <div id="logs-error" class="banner banner-danger" style="display: none; margin-top: 0.75rem;"></div>
                        
                        <!-- Microcopy Footer -->
                        <div class="microcopy-footer">
                            <i data-lucide="info" style="width: 14px; height: 14px; flex-shrink: 0; color: var(--info);"></i>
                            <span>Final authority resides on device; actions may be rejected.</span>
                        </div>
                    </div>
                <% } %>
            window.location.href = path;
        }
        
        function copyText(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.createElement('div');
                toast.textContent = `${label} copied!`;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(16, 185, 129, 0.9);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 0.5rem;
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                `;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            });
        }
    </script>
    
    <style>
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0, 240, 255, 0.4);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</body>
</html>
