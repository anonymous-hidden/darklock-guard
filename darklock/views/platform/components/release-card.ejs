<% 
const product = release.product || 'Guard';
const channel = (release.channel || 'stable').toLowerCase();
const os = (release.os || '').toLowerCase();
const releaseDateText = release.releaseDate ? new Date(release.releaseDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Unknown date';
const hash = release.sha256 || 'N/A';
const shortHash = hash.length > 12 ? `${hash.substring(0, 8)}...${hash.substring(hash.length - 4)}` : hash;
const changelog = Array.isArray(release.changelog) ? release.changelog : [];
const downloadLabel = os === 'windows' ? '.exe' : os === 'linux' ? '.tar.gz' : os === 'macos' ? '.dmg' : 'package';
%>
<div class="platform-card" id="release-<%= release.id %>" style="<%= channel === 'beta' ? 'border-left: 4px solid var(--warning);' : '' %>">
    <!-- Header -->
    <div class="release-header">
        <i data-lucide="<%= product === 'Guard' ? 'shield' : 'bot' %>" 
           style="width: 24px; height: 24px; color: <%= product === 'Guard' ? 'var(--accent-primary)' : 'var(--accent-secondary)' %>;"></i>
        <div style="flex: 1;">
            <span style="font-size: 1.125rem; font-weight: 600;"><%= product %> v<%= release.version %></span>
            <span class="badge badge-<%= channel %>" style="margin-left: 0.5rem;">
                <%= channel.toUpperCase() %>
            </span>
        </div>
    </div>
    
    <!-- Meta -->
    <div class="release-meta">
        Released: <%= releaseDateText %> • 
        <%= release.fileSize || 'Unknown size' %> • 
        <%= release.os || 'Unknown OS' %>
    </div>
    
    <!-- Verification Status -->
    <div class="verification-row">
        <div class="verification-item <%= release.signatureValid ? 'verification-valid' : 'verification-invalid' %>">
            <i data-lucide="<%= release.signatureValid ? 'check-circle' : 'x-circle' %>" style="width: 16px; height: 16px;"></i>
            <span>Signature <%= release.signatureValid ? 'Valid' : 'Invalid' %> (ed25519)</span>
        </div>
        
        <div class="verification-item verification-valid">
            <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
            <span class="hash-truncated" title="<%= hash %>">
                SHA-256: <%= shortHash %>
            </span>
            <button 
                class="btn btn-secondary" 
                style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" 
                onclick="copyHash('<%= hash %>')"
                title="Copy full hash">
                <i data-lucide="copy" style="width: 12px; height: 12px;"></i>
            </button>
        </div>
    </div>
    
    <!-- Changelog -->
    <div style="margin: 1rem 0;">
        <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">CHANGELOG</h4>
        <% if (!changelog.length) { %>
            <div style="color: var(--text-secondary); font-size: 0.875rem;">No release notes provided.</div>
        <% } else { %>
        <ul class="changelog-list" id="changelog-<%= release.id %>">
            <% changelog.slice(0, 3).forEach((change, idx) => { %>
                <li class="changelog-item">
                    <span class="changelog-bullet changelog-bullet-<%= change.type %>"></span>
                    <span><strong><%= change.type.charAt(0).toUpperCase() + change.type.slice(1) %>:</strong> <%= change.text %></span>
                </li>
            <% }) %>
            
            <% if (changelog.length > 3) { %>
                <% changelog.slice(3).forEach((change, idx) => { %>
                    <li class="changelog-item" style="display: none;" data-collapsed>
                        <span class="changelog-bullet changelog-bullet-<%= change.type %>"></span>
                        <span><strong><%= change.type.charAt(0).toUpperCase() + change.type.slice(1) %>:</strong> <%= change.text %></span>
                    </li>
                <% }) %>
                
                <button 
                    class="btn btn-secondary" 
                    style="margin-top: 0.5rem; font-size: 0.875rem;"
                    onclick="toggleChangelog(<%= release.id %>)">
                    <span id="toggle-text-<%= release.id %>">View Full Notes ▼</span>
                </button>
            <% } %>
        </ul>
        <% } %>
    </div>
    
    <!-- Action Buttons -->
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button class="btn btn-primary" disabled title="Downloads disabled in read-only mode">
            <i data-lucide="download" style="width: 16px; height: 16px;"></i>
            Download <%= downloadLabel %>
        </button>
        
        <button class="btn btn-secondary" disabled title="Downloads disabled in read-only mode">
            <i data-lucide="file-signature" style="width: 16px; height: 16px;"></i>
            Download .sig
        </button>
        
        <button class="btn btn-secondary" onclick="copyUrl('<%= release.downloadUrl %>')">
            <i data-lucide="link" style="width: 16px; height: 16px;"></i>
            Copy URL
        </button>
    </div>
</div>

<script>
    function toggleChangelog(id) {
        const items = document.querySelectorAll(`#changelog-${id} [data-collapsed]`);
        const button = document.getElementById(`toggle-text-${id}`);
        const isCollapsed = items[0].style.display === 'none';
        
        items.forEach(item => {
            item.style.display = isCollapsed ? 'flex' : 'none';
        });
        
        button.textContent = isCollapsed ? 'Collapse ▲' : 'View Full Notes ▼';
    }
    
    function copyHash(hash) {
        navigator.clipboard.writeText(hash).then(() => {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.textContent = 'Hash copied!';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(16, 185, 129, 0.9);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 2000);
        });
    }
    
    function copyUrl(url) {
        const fullUrl = window.location.origin + url;
        navigator.clipboard.writeText(fullUrl).then(() => {
            const toast = document.createElement('div');
            toast.textContent = 'URL copied!';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 240, 255, 0.9);
                color: #0a0e17;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 2000);
        });
    }
</script>

<style>
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
