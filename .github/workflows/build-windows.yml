name: Build Windows Installers

on:
  workflow_dispatch:
    inputs:
      apps:
        description: "Which apps to build"
        required: false
        default: "both"
        type: choice
        options:
          - both
          - guard
          - secure-channel
  push:
    branches: [main]
    paths:
      - "guard-v2/desktop/**"
      - "secure-channel/apps/dl-secure-channel/**"
      - ".github/workflows/build-windows.yml"

jobs:
  # ─────────────────────────────────────────────────────────
  # Job 1: Darklock Guard
  # ─────────────────────────────────────────────────────────
  build-guard:
    name: "Darklock Guard — Windows"
    runs-on: windows-latest
    if: >
      github.event_name == 'push' ||
      inputs.apps == 'both' ||
      inputs.apps == 'guard'

    defaults:
      run:
        working-directory: guard-v2/desktop

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: guard-v2/desktop/package-lock.json

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "guard-v2 -> target"

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app (Windows NSIS + MSI)
        run: npx tauri build
        env:
          NODE_ENV: production
          CI: true

      - name: Upload NSIS installer (.exe)
        uses: actions/upload-artifact@v4
        with:
          name: darklock-guard-windows-setup
          path: |
            guard-v2/desktop/src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: warn
          retention-days: 30

      - name: Upload MSI installer
        uses: actions/upload-artifact@v4
        with:
          name: darklock-guard-windows-msi
          path: |
            guard-v2/desktop/src-tauri/target/release/bundle/msi/*.msi
          if-no-files-found: warn
          retention-days: 30

  # ─────────────────────────────────────────────────────────
  # Job 2: Darklock Secure Channel
  # ─────────────────────────────────────────────────────────
  build-secure-channel:
    name: "Darklock Secure Channel — Windows"
    runs-on: windows-latest
    if: >
      github.event_name == 'push' ||
      inputs.apps == 'both' ||
      inputs.apps == 'secure-channel'

    defaults:
      run:
        working-directory: secure-channel/apps/dl-secure-channel

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: secure-channel/apps/dl-secure-channel/package-lock.json

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "secure-channel -> target"

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app (Windows NSIS + MSI)
        run: npx tauri build
        env:
          NODE_ENV: production
          CI: true

      - name: Upload NSIS installer (.exe)
        uses: actions/upload-artifact@v4
        with:
          name: darklock-secure-channel-windows-setup
          path: |
            secure-channel/apps/dl-secure-channel/src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: warn
          retention-days: 30

      - name: Upload MSI installer
        uses: actions/upload-artifact@v4
        with:
          name: darklock-secure-channel-windows-msi
          path: |
            secure-channel/apps/dl-secure-channel/src-tauri/target/release/bundle/msi/*.msi
          if-no-files-found: warn
          retention-days: 30
